<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSV Calculator | Franc Engineering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .franc-blue { color: #1e3a5f; }
        .franc-blue-bg { background-color: #1e3a5f; }
        .franc-accent { color: #2563eb; }
        .franc-accent-bg { background-color: #2563eb; }
        .step-indicator { transition: all 0.3s ease; }
        .step-indicator.active { transform: scale(1.1); }
        .scenario-card { transition: all 0.2s ease; }
        .scenario-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .scenario-card.selected { border-color: #2563eb; background-color: #eff6ff; }
        .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input::placeholder { color: #9ca3af; }
        .file-upload { border: 2px dashed #d1d5db; transition: all 0.2s ease; }
        .file-upload:hover { border-color: #2563eb; background-color: #f8fafc; }
        .file-upload.has-file { border-color: #22c55e; background-color: #f0fdf4; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration - Update this for production
        const API_BASE = ''; // Empty for local calculations, or 'https://your-api.railway.app'

        // Component Database
        // Component Database - Added Cp (ideal gas molar heat capacity at 25Â°C, J/molÂ·K)
        const COMPONENTS = {
            methane: { name: 'Methane', formula: 'C1', mw: 16.043, tc: 190.56, pc: 4599000, omega: 0.0115, cp: 35.69, lfl: 5.0, ufl: 15.0 },
            ethane: { name: 'Ethane', formula: 'C2', mw: 30.070, tc: 305.32, pc: 4872000, omega: 0.0995, cp: 52.49, lfl: 3.0, ufl: 12.4 },
            propane: { name: 'Propane', formula: 'C3', mw: 44.096, tc: 369.83, pc: 4248000, omega: 0.1523, cp: 73.60, lfl: 2.1, ufl: 9.5 },
            isobutane: { name: 'Isobutane', formula: 'iC4', mw: 58.122, tc: 407.85, pc: 3640000, omega: 0.1835, cp: 96.65, lfl: 1.8, ufl: 8.4 },
            nbutane: { name: 'n-Butane', formula: 'nC4', mw: 58.122, tc: 425.12, pc: 3796000, omega: 0.2002, cp: 97.45, lfl: 1.8, ufl: 8.4 },
            isopentane: { name: 'Isopentane', formula: 'iC5', mw: 72.149, tc: 460.35, pc: 3381000, omega: 0.2275, cp: 120.2, lfl: 1.4, ufl: 7.6 },
            npentane: { name: 'n-Pentane', formula: 'nC5', mw: 72.149, tc: 469.70, pc: 3370000, omega: 0.2515, cp: 120.1, lfl: 1.4, ufl: 7.8 },
            nhexane: { name: 'n-Hexane', formula: 'C6', mw: 86.175, tc: 507.60, pc: 3025000, omega: 0.3013, cp: 142.6, lfl: 1.2, ufl: 7.4 },
            nheptane: { name: 'n-Heptane', formula: 'C7', mw: 100.202, tc: 540.20, pc: 2740000, omega: 0.3495, cp: 165.2, lfl: 1.05, ufl: 6.7 },
            noctane: { name: 'n-Octane', formula: 'C8', mw: 114.229, tc: 568.70, pc: 2490000, omega: 0.3996, cp: 187.8, lfl: 1.0, ufl: 6.5 },
            nnonane: { name: 'n-Nonane', formula: 'C9', mw: 128.255, tc: 594.60, pc: 2290000, omega: 0.4435, cp: 210.2, lfl: 0.8, ufl: 5.9 },
            ndecane: { name: 'n-Decane', formula: 'C10', mw: 142.282, tc: 617.70, pc: 2110000, omega: 0.4923, cp: 232.7, lfl: 0.8, ufl: 5.4 },
            nitrogen: { name: 'Nitrogen', formula: 'N2', mw: 28.014, tc: 126.20, pc: 3398000, omega: 0.0377, cp: 29.12, lfl: null, ufl: null },
            oxygen: { name: 'Oxygen', formula: 'O2', mw: 31.999, tc: 154.58, pc: 5043000, omega: 0.0222, cp: 29.38, lfl: null, ufl: null },
            co2: { name: 'CO2', formula: 'CO2', mw: 44.010, tc: 304.21, pc: 7383000, omega: 0.2236, cp: 37.13, lfl: null, ufl: null },
            h2s: { name: 'H2S', formula: 'H2S', mw: 34.081, tc: 373.53, pc: 8963000, omega: 0.0942, cp: 34.23, lfl: 4.0, ufl: 44.0 },
            water: { name: 'Water', formula: 'H2O', mw: 18.015, tc: 647.10, pc: 22064000, omega: 0.3449, cp: 33.59, lfl: null, ufl: null },
        };

        // Fluid Presets
        const PRESETS = {
            natural_gas: { name: 'Natural Gas', composition: { methane: 85, ethane: 7, propane: 3, nbutane: 2, co2: 2, nitrogen: 1 }},
            rich_gas: { name: 'Rich Gas', composition: { methane: 70, ethane: 12, propane: 8, isobutane: 3, nbutane: 3, isopentane: 1, npentane: 1, co2: 2 }},
            propane_pure: { name: 'Propane', composition: { propane: 100 }},
            butane_mix: { name: 'Butane Mix', composition: { isobutane: 50, nbutane: 50 }},
            ngl: { name: 'NGL', composition: { ethane: 40, propane: 30, isobutane: 10, nbutane: 10, npentane: 10 }},
            water_pure: { name: 'Water', composition: { water: 100 }},
        };

        // API 526 Orifices with inlet/outlet sizes (including alternate sizes)
        const ORIFICES = [
            { letter: 'D', area: 0.110, inlet: '1"', outlet: '2"', size: '1 D 2' },
            { letter: 'E', area: 0.196, inlet: '1"', outlet: '2"', size: '1 E 2' },
            { letter: 'F', area: 0.307, inlet: '1.5"', outlet: '2"', size: '1Â½ F 2' },
            { letter: 'G', area: 0.503, inlet: '1.5"', outlet: '3"', size: '1Â½ G 3' },
            { letter: 'G', area: 0.503, inlet: '2"', outlet: '3"', size: '2 G 3' },
            { letter: 'H', area: 0.785, inlet: '1.5"', outlet: '3"', size: '1Â½ H 3' },
            { letter: 'H', area: 0.785, inlet: '2"', outlet: '3"', size: '2 H 3' },
            { letter: 'J', area: 1.287, inlet: '2"', outlet: '3"', size: '2 J 3' },
            { letter: 'K', area: 1.838, inlet: '3"', outlet: '4"', size: '3 K 4' },
            { letter: 'L', area: 2.853, inlet: '3"', outlet: '4"', size: '3 L 4' },
            { letter: 'L', area: 2.853, inlet: '4"', outlet: '6"', size: '4 L 6' },
            { letter: 'M', area: 3.600, inlet: '4"', outlet: '6"', size: '4 M 6' },
            { letter: 'N', area: 4.340, inlet: '4"', outlet: '6"', size: '4 N 6' },
            { letter: 'P', area: 6.380, inlet: '4"', outlet: '6"', size: '4 P 6' },
            { letter: 'Q', area: 11.05, inlet: '6"', outlet: '8"', size: '6 Q 8' },
            { letter: 'R', area: 16.00, inlet: '6"', outlet: '8"', size: '6 R 8' },
            { letter: 'T', area: 26.00, inlet: '8"', outlet: '10"', size: '8 T 10' },
        ];

        // Scenarios - Updated per user request
        const SCENARIOS = [
            { id: 'fire_wetted', label: '1A', name: '1A - Fire-Wetted (Liquid Boil up)', icon: 'ðŸ”¥', desc: 'Pool fire on vessel with liquid inventory causing vaporization', compLabel: 'Fire-Wetted Liquid Composition', presets: ['ngl', 'propane_pure', 'water_pure'] },
            { id: 'fire_unwetted', label: '1B', name: '1B - Fire-Unwetted (Vapor)', icon: 'ðŸ’¨', desc: 'Fire exposure on vapor space only', compLabel: 'Fire Unwetted Vapor Composition', presets: ['natural_gas', 'rich_gas', 'water_pure'] },
            { id: 'blocked_vapor', label: '2A', name: '2A - Blocked Outlet - Vapor', icon: 'â›”', desc: 'Blocked vapor outlet with upstream source', compLabel: 'Blocked Outlet Vapor Composition', presets: ['natural_gas', 'rich_gas', 'water_pure'] },
            { id: 'cv_failure', label: '3', name: '3 - CV Failure - Vapor', icon: 'âš ï¸', desc: 'Control valve fails open, vapor service', compLabel: 'CV Failure Vapor Composition', presets: ['natural_gas', 'rich_gas', 'water_pure'] },
        ];

        // Bypass valve Cv lookup tables
        const BYPASS_CV_GLOBE = [
            { size: '1/2"', cv: 100 },
            { size: '3/4"', cv: 192 },
            { size: '1"', cv: 333 },
            { size: '1.25"', cv: 607 },
            { size: '1.5"', cv: 856 },
            { size: '2"', cv: 1504 },
            { size: '2.5"', cv: 2505 },
            { size: '3"', cv: 3868 },
            { size: '3.5"', cv: 5246 },
            { size: '4"', cv: 6854 },
        ];

        const BYPASS_CV_BALL = [
            { size: '1/2"', cv: 20 },
            { size: '3/4"', cv: 49 },
            { size: '1"', cv: 94 },
            { size: '1.5"', cv: 239 },
            { size: '2"', cv: 449 },
            { size: '3"', cv: 1222 },
            { size: '4"', cv: 2374 },
        ];

        // Simplified Peng-Robinson calculations (client-side)
        function calculateProperties(composition, T_F, P_psig) {
            const T_K = (T_F + 459.67) * 5/9;
            const P_Pa = (P_psig + 14.7) * 6894.76;
            const R = 8.314462;

            let mw = 0, totalMol = 0;
            const compData = [];

            Object.entries(composition).forEach(([comp, molPct]) => {
                if (molPct > 0 && COMPONENTS[comp]) {
                    const c = COMPONENTS[comp];
                    const z = molPct / 100;
                    totalMol += z;
                    compData.push({ ...c, z });
                }
            });

            compData.forEach(c => {
                c.z = c.z / totalMol;
                mw += c.z * c.mw;
            });

            let a_mix = 0, b_mix = 0;
            compData.forEach(c => {
                const Tr = T_K / c.tc;
                const kappa = 0.37464 + 1.54226 * c.omega - 0.26992 * c.omega * c.omega;
                const alpha = Math.pow(1 + kappa * (1 - Math.sqrt(Tr)), 2);
                const a_i = 0.45724 * R * R * c.tc * c.tc / c.pc * alpha;
                const b_i = 0.07780 * R * c.tc / c.pc;
                a_mix += c.z * Math.sqrt(a_i);
                b_mix += c.z * b_i;
            });
            a_mix = a_mix * a_mix;

            const A = a_mix * P_Pa / (R * R * T_K * T_K);
            const B = b_mix * P_Pa / (R * T_K);

            let Z = 1.0;
            for (let i = 0; i < 20; i++) {
                const Z_new = 1 + B - A * B / (Z * (Z + B));
                if (Math.abs(Z_new - Z) < 0.0001) break;
                Z = 0.5 * (Z + Z_new);
            }
            Z = Math.max(0.1, Math.min(Z, 1.5));

            const gamma = 1.1 + 0.05 * (50 / mw);
            const density = P_Pa * (mw / 1000) / (Z * R * T_K);

            let lfl_inv = 0, ufl_inv = 0, flammable_total = 0;
            compData.forEach(c => {
                if (c.lfl && c.lfl > 0) {
                    lfl_inv += c.z / c.lfl;
                    ufl_inv += c.z / c.ufl;
                    flammable_total += c.z;
                }
            });

            const lfl = flammable_total > 0 && lfl_inv > 0 ? flammable_total / lfl_inv : null;
            const ufl = flammable_total > 0 && ufl_inv > 0 ? flammable_total / ufl_inv : null;

            return { mw, Z, gamma, density, lfl, ufl };
        }

        function fireHeatInput(wetted_area_ft2, insulated = false) {
            const F = insulated ? 0.3 : 1.0;
            if (wetted_area_ft2 <= 2800) {
                return 21000 * F * Math.pow(wetted_area_ft2, 0.82);
            }
            return 34500 * F * Math.pow(wetted_area_ft2, 0.82);
        }

        function wettedAreaHorizontal(diameter_ft, length_ft, liquid_fraction) {
            const R = diameter_ft / 2;
            const h = liquid_fraction * diameter_ft;
            const theta = 2 * Math.acos((R - h) / R);
            const arc = R * theta;
            const shell = arc * length_ft;
            const segment = (R * R / 2) * (theta - Math.sin(theta));
            const heads = 2 * segment;
            return shell + heads;
        }

        function sizePSV(scenario, props, conditions, vessel) {
            const { mw, Z, gamma } = props;
            const { set_pressure, back_pressure, temperature, latent_heat, flow_rate } = conditions;

            const accumulation = (scenario === 'fire_wetted' || scenario === 'fire_unwetted') ? 0.21 : 0.10;
            const P1_psia = set_pressure * (1 + accumulation) + 14.7;
            const P2_psia = back_pressure + 14.7;
            const T_R = temperature + 459.67;

            let W_lb_hr, Q_fire, wetted_area;

            if (scenario === 'fire_wetted' && vessel) {
                wetted_area = wettedAreaHorizontal(vessel.diameter, vessel.length, vessel.liquid_level);
                Q_fire = fireHeatInput(wetted_area, vessel.insulated);
                W_lb_hr = Q_fire / latent_heat;
            } else if (scenario === 'fire_unwetted' && vessel) {
                wetted_area = wettedAreaHorizontal(vessel.diameter, vessel.length, 0.1);
                Q_fire = fireHeatInput(wetted_area * 0.5, false) * 0.3;
                W_lb_hr = Q_fire / (0.5 * 100);
            } else {
                W_lb_hr = flow_rate || 10000;
                Q_fire = null;
                wetted_area = null;
            }

            const C = 520 * Math.sqrt(gamma * Math.pow(2 / (gamma + 1), (gamma + 1) / (gamma - 1)));
            const P_crit = Math.pow(2 / (gamma + 1), gamma / (gamma - 1));
            const P_ratio = P2_psia / P1_psia;
            const isCritical = P_ratio <= P_crit;

            let A_required;
            if (isCritical) {
                A_required = (W_lb_hr / (C * 0.975 * P1_psia)) * Math.sqrt(T_R * Z / mw);
            } else {
                const r = P_ratio;
                const F2 = Math.sqrt((gamma / (gamma - 1)) * Math.pow(r, 2/gamma) *
                    ((1 - Math.pow(r, (gamma-1)/gamma)) / (1 - r)));
                A_required = (W_lb_hr / (735 * F2 * 0.975)) * Math.sqrt(T_R * Z / (mw * P1_psia * P2_psia));
            }

            // Select orifice (use unique letters for calculation)
            const uniqueOrifices = ORIFICES.filter((o, i, arr) =>
                arr.findIndex(x => x.letter === o.letter) === i
            );
            let selectedOrifice = uniqueOrifices[uniqueOrifices.length - 1];
            for (const o of uniqueOrifices) {
                if (o.area >= A_required) {
                    selectedOrifice = o;
                    break;
                }
            }

            const utilization = (A_required / selectedOrifice.area) * 100;

            return {
                relief_rate: W_lb_hr,
                relieving_pressure: P1_psia,
                back_pressure: P2_psia,
                flow_type: isCritical ? 'Critical' : 'Subcritical',
                required_area: A_required,
                selected_orifice: selectedOrifice.letter,
                orifice_area: selectedOrifice.area,
                orifice_size: selectedOrifice.size,
                orifice_inlet: selectedOrifice.inlet,
                orifice_outlet: selectedOrifice.outlet,
                utilization,
                heat_input: Q_fire,
                wetted_area,
            };
        }

        // Device Info Header Component (shows on steps 2-5)
        function DeviceInfoHeader({ deviceInfo }) {
            if (!deviceInfo.tag && !deviceInfo.pid_number && !deviceInfo.facility_name) return null;
            return (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div className="flex flex-wrap gap-4 text-sm">
                        {deviceInfo.tag && (
                            <div><span className="text-blue-600 font-medium">Tag:</span> <span className="font-semibold">{deviceInfo.tag}</span></div>
                        )}
                        {deviceInfo.pid_number && (
                            <div><span className="text-blue-600 font-medium">P&ID:</span> <span className="font-semibold">{deviceInfo.pid_number}</span></div>
                        )}
                        {deviceInfo.facility_name && (
                            <div><span className="text-blue-600 font-medium">Facility:</span> <span className="font-semibold">{deviceInfo.facility_name}</span></div>
                        )}
                    </div>
                </div>
            );
        }

        // File Upload Component
        function FileUpload({ label, accept, file, onFileChange }) {
            const handleChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    onFileChange(selectedFile);
                }
            };

            return (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                    <label className={`file-upload block p-4 rounded-lg cursor-pointer text-center ${file ? 'has-file' : ''}`}>
                        <input
                            type="file"
                            accept={accept}
                            onChange={handleChange}
                            className="hidden"
                        />
                        {file ? (
                            <div className="text-green-700">
                                <span className="font-medium">{file.name}</span>
                                <p className="text-xs mt-1">Click to replace</p>
                            </div>
                        ) : (
                            <div className="text-gray-500">
                                <svg className="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <span className="text-sm">Click to upload</span>
                            </div>
                        )}
                    </label>
                </div>
            );
        }

        // Main App Component
        function PSVCalculator() {
            const [step, setStep] = useState(1);

            // Step 1: Device Info
            const [deviceInfo, setDeviceInfo] = useState({
                tag: '',
                pid_number: '',
                facility_name: '',
                protected_system: '',
                mawp: '',
                selected_orifice: '',
                new_or_existing: 'new',
                discharge_location: 'atmosphere',
                set_pressure: '',
                psv_type: 'conventional',
            });

            // Step 2: Scenario selections with applicable flags and notes
            const [scenarioSelections, setScenarioSelections] = useState({
                fire_wetted: { applicable: false, notes: '' },
                fire_unwetted: { applicable: false, notes: '' },
                blocked_vapor: { applicable: false, notes: '' },
                cv_failure: { applicable: false, notes: '' },
            });

            // File uploads
            const [pidFile, setPidFile] = useState(null);
            const [miscFile, setMiscFile] = useState(null);

            const [preset, setPreset] = useState('');
            // Compositions keyed by scenario ID
            const [compositions, setCompositions] = useState({
                fire_wetted: {},
                fire_unwetted: {},
                blocked_vapor: {},
                cv_failure: {},
            });

            // Vessel details (shared between fire scenarios)
            const [vesselDetails, setVesselDetails] = useState({
                equipment_tag: '',
                orientation: 'horizontal',
                head_type: '2:1_elliptical',
                inner_diameter: 48, // inches
                seam_to_seam: 10, // ft
                height_above_grade: 2, // ft
                max_liquid_level: 50, // %
                additional_area: 0, // ftÂ² (can be negative to exclude)
            });

            // Scenario-specific conditions
            const [scenarioConditions, setScenarioConditions] = useState({
                fire_wetted: {
                    normal_op_pressure: 80,
                    normal_op_temp: 125,
                    latent_heat: 150,
                },
                fire_unwetted: {
                    normal_op_pressure: 80,
                    normal_op_temp: 125,
                },
                blocked_vapor: {
                    normal_op_pressure: 80,
                    normal_op_temp: 125,
                    flow_rate: 10000,
                    flow_rate_unit: 'lb_hr', // 'lb_hr' or 'mmscfd'
                },
                cv_failure: {
                    valve_tag: '',
                    cv: 100, // Full-Open Valve Flow Coefficient
                    xt: 0.7, // Pressure Drop Ratio Factor
                    upstream_pressure: 800, // psig (P1)
                    upstream_temp: 138, // Â°F (T1)
                    // Bypass valve options
                    has_bypass: false,
                    bypass_valve_type: 'globe', // 'globe' or 'ball'
                    bypass_size: '1"',
                    use_bypass_flow: false, // If true, use bypass flow instead of CV flow
                },
            });

            // Constants
            const AMBIENT_PRESSURE = 14.69; // psia
            const MAX_WALL_TEMP = 1100; // Â°F
            const FIRE_OVERPRESSURE = 0.21; // 21%

            // Calculate molecular weight from composition
            const getMolecularWeight = (composition) => {
                let mw = 0, totalMol = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp]) {
                        totalMol += molPct;
                        mw += molPct * COMPONENTS[comp].mw;
                    }
                });
                return totalMol > 0 ? mw / totalMol : 0;
            };

            // Calculate pseudo-critical pressure using Kay's mixing rule
            const getCriticalPressure = (composition) => {
                let pc_mix = 0, totalMol = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp]) {
                        totalMol += molPct;
                        pc_mix += (molPct / 100) * (COMPONENTS[comp].pc / 6894.76); // Convert Pa to psia
                    }
                });
                return totalMol > 0 ? pc_mix * 100 / totalMol : 0;
            };

            // Calculate specific heat ratio k (Cp/Cv) from composition
            // k = Cp_molar / (Cp_molar - R) where R = 8.314 J/(molÂ·K)
            const getSpecificHeatRatio = (composition) => {
                const R = 8.314; // J/(molÂ·K)
                let cp_mix = 0, totalMol = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp] && COMPONENTS[comp].cp) {
                        totalMol += molPct;
                        cp_mix += (molPct / 100) * COMPONENTS[comp].cp;
                    }
                });
                if (totalMol <= 0) return 1.3; // Default fallback
                const cp_molar = cp_mix * 100 / totalMol;
                const cv_molar = cp_molar - R;
                if (cv_molar <= 0) return 1.3;
                return cp_molar / cv_molar;
            };

            // Calculate API 520 C coefficient from k
            // C = 520 * sqrt(k * (2/(k+1))^((k+1)/(k-1)))
            const getAPI520_C = (k) => {
                if (k <= 1) return 315; // Minimum bound
                const term = Math.pow(2 / (k + 1), (k + 1) / (k - 1));
                return 520 * Math.sqrt(k * term);
            };

            // API 521 Eqn (11): T1 = (p1/pn) * Tn
            const calcRelievingTemp = (p1_psia, pn_psig, Tn_F) => {
                const pn_psia = pn_psig + AMBIENT_PRESSURE;
                const Tn_R = Tn_F + 459.67;
                const T1_R = (p1_psia / pn_psia) * Tn_R;
                return T1_R - 459.67; // Convert back to Â°F
            };

            // API 521 Eqn (12): qm,relief = C12 * sqrt(M * p1) * [A'(Tw-T1)^1.25 / T1^1.1506]
            const C12 = 0.1406; // Constant for lb/hr, ftÂ², psia, Â°F
            const calcFireUnwettedReliefLoad = (M, p1_psia, A_prime, Tw_F, T1_F) => {
                if (T1_F <= 0 || Tw_F <= T1_F) return 0;
                const T1_R = T1_F + 459.67;
                const numerator = A_prime * Math.pow(Tw_F - T1_F, 1.25);
                const denominator = Math.pow(T1_R, 1.1506);
                return C12 * Math.sqrt(M * p1_psia) * (numerator / denominator);
            };

            // Convert relief load to volumetric rate (MMscfd)
            const calcVolumetricRate = (qm_lb_hr, M, T_F, P_psia) => {
                if (M <= 0 || P_psia <= 0) return 0;
                const T_R = T_F + 459.67;
                // PV = nRT, n = qm/M, convert to scf/day then MMscfd
                const scf_per_hr = (qm_lb_hr / M) * 10.73 * (520) / 14.696; // at standard conditions
                return (scf_per_hr * 24) / 1e6;
            };

            // Calculate vessel surface areas and volume
            const calcVesselAreas = (vessel) => {
                const D_ft = vessel.inner_diameter / 12; // Convert inches to feet
                const R_ft = D_ft / 2;
                const L_ft = vessel.seam_to_seam;
                const liquidFrac = vessel.max_liquid_level / 100;

                // Head surface area (each head) - CORRECT FORMULAS
                let headArea = 0;
                let headVolume = 0;
                if (vessel.head_type === '2:1_elliptical') {
                    // 2:1 elliptical head surface area = 1.084 Ã— DÂ²
                    headArea = 1.084 * D_ft * D_ft;
                    // 2:1 elliptical head volume = Ï€ Ã— DÂ³ / 24
                    headVolume = Math.PI * Math.pow(D_ft, 3) / 24;
                } else if (vessel.head_type === 'hemispherical') {
                    // Hemisphere surface area = Ï€ Ã— DÂ² / 2
                    headArea = Math.PI * D_ft * D_ft / 2;
                    // Hemisphere volume = Ï€ Ã— DÂ³ / 12
                    headVolume = Math.PI * Math.pow(D_ft, 3) / 12;
                } else if (vessel.head_type === 'flat') {
                    // Flat head area = Ï€ Ã— RÂ² = Ï€ Ã— DÂ² / 4
                    headArea = Math.PI * D_ft * D_ft / 4;
                    // Flat head has no additional volume
                    headVolume = 0;
                }
                // 'none' = 0 for both

                const totalHeadArea = 2 * headArea;
                const shellArea = Math.PI * D_ft * L_ft;
                const totalArea = shellArea + totalHeadArea;

                // Shell volume (cylinder)
                const shellVolume = Math.PI * R_ft * R_ft * L_ft;
                const totalVolume_ft3 = shellVolume + 2 * headVolume;
                const totalVolume_gal = totalVolume_ft3 * 7.48052; // Convert to US gallons

                // For horizontal vessel, calculate wetted/unwetted based on liquid level
                let wettedArea = 0;
                let unwettedArea = 0;

                if (vessel.orientation === 'horizontal') {
                    // Approximate wetted shell area for horizontal cylinder
                    const h = liquidFrac * D_ft;
                    const theta = 2 * Math.acos(Math.max(-1, Math.min(1, (R_ft - h) / R_ft)));
                    const wettedShellFrac = theta / (2 * Math.PI);
                    const wettedShell = wettedShellFrac * shellArea;
                    const wettedHeads = wettedShellFrac * totalHeadArea;
                    wettedArea = wettedShell + wettedHeads;
                    unwettedArea = totalArea - wettedArea;
                } else {
                    // Vertical vessel
                    const liquidHeight = liquidFrac * L_ft;
                    const wettedShell = Math.PI * D_ft * liquidHeight;
                    // Only include bottom head as wetted if there's liquid
                    const wettedHead = liquidFrac > 0 ? headArea : 0;
                    wettedArea = wettedShell + wettedHead;
                    unwettedArea = totalArea - wettedArea;
                }

                // Apply additional area adjustment
                const adjustedUnwetted = Math.max(0, unwettedArea + vessel.additional_area);
                const adjustedWetted = Math.max(0, wettedArea + vessel.additional_area);

                return {
                    total: totalArea,
                    shell: shellArea,
                    heads: totalHeadArea,
                    wetted: wettedArea,
                    unwetted: unwettedArea,
                    adjustedUnwetted,
                    adjustedWetted,
                    volume_ft3: totalVolume_ft3,
                    volume_gal: totalVolume_gal,
                };
            };

            // Update vessel details
            const updateVesselDetail = (field, value) => {
                setVesselDetails(prev => ({
                    ...prev,
                    [field]: typeof value === 'string' ? value : (parseFloat(value) || 0)
                }));
            };

            const [conditions, setConditions] = useState({
                temperature: 100,
                tempUnit: 'F',
                pressure: 150,
                pressureUnit: 'psig',
                back_pressure: 0,
                latent_heat: 150,
                flow_rate: 10000,
            });
            const [vessel, setVessel] = useState({
                diameter: 6,
                length: 20,
                liquid_level: 0.5,
                insulated: false,
            });
            const [scenario, setScenario] = useState('fire_wetted');
            const [activeConditionsTab, setActiveConditionsTab] = useState(null);
            const [results, setResults] = useState(null);
            const [reportOptions, setReportOptions] = useState({
                includeInputs: true,
                includeResults: true,
                includeCalcs: true,
                includeAppendix: true
            });

            // Get list of applicable scenarios
            const applicableScenarios = SCENARIOS.filter(s => scenarioSelections[s.id]?.applicable);

            // Apply preset to a specific scenario's composition
            const handlePresetChange = (presetId, scenarioId) => {
                setPreset(presetId);
                if (PRESETS[presetId]) {
                    setCompositions(prev => ({
                        ...prev,
                        [scenarioId]: PRESETS[presetId].composition
                    }));
                }
            };

            // Update composition for a specific scenario
            const handleCompChange = (scenarioId, comp, value) => {
                setCompositions(prev => ({
                    ...prev,
                    [scenarioId]: {
                        ...prev[scenarioId],
                        [comp]: parseFloat(value) || 0
                    }
                }));
            };

            // Copy composition from first applicable scenario to another
            const copyCompositionFrom = (fromScenarioId, toScenarioId) => {
                setCompositions(prev => ({
                    ...prev,
                    [toScenarioId]: { ...prev[fromScenarioId] }
                }));
            };

            // Update scenario-specific conditions
            const updateScenarioCondition = (scenarioId, field, value) => {
                setScenarioConditions(prev => ({
                    ...prev,
                    [scenarioId]: {
                        ...prev[scenarioId],
                        [field]: field.includes('unit') || field.includes('tag') || field.includes('type') || field.includes('size')
                            ? value
                            : (typeof value === 'boolean' ? value : (parseFloat(value) || 0))
                    }
                }));
            };

            // Calculate total mol% for a specific scenario
            const getTotalMol = (scenarioId) => {
                const comp = compositions[scenarioId] || {};
                return Object.values(comp).reduce((a, b) => a + (b || 0), 0);
            };

            const calculate = () => {
                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                const selectedOrificeSize = deviceInfo.selected_orifice;
                const selectedOrifice = ORIFICES.find(o => o.size === selectedOrificeSize);
                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                // Calculate results for each applicable scenario
                const scenarioResults = {};
                let controllingScenario = null;
                let maxRequiredArea = 0;

                // Fire Unwetted (1B)
                if (scenarioSelections.fire_unwetted?.applicable) {
                    const comp = compositions.fire_unwetted || {};
                    const cond = scenarioConditions.fire_unwetted;
                    const p1_psia = setP * (1 + FIRE_OVERPRESSURE) + AMBIENT_PRESSURE;
                    const M = getMolecularWeight(comp);
                    const T1 = calcRelievingTemp(p1_psia, cond.normal_op_pressure, cond.normal_op_temp);
                    const vesselAreas = calcVesselAreas({ ...vesselDetails, max_liquid_level: 0 });
                    const qRelief = calcFireUnwettedReliefLoad(M, p1_psia, vesselAreas.adjustedUnwetted, MAX_WALL_TEMP, T1);
                    const T1_R = T1 + 459.67;
                    const k = getSpecificHeatRatio(comp);
                    const C = getAPI520_C(k);
                    const requiredArea = qRelief > 0 && M > 0 && p1_psia > 0
                        ? (qRelief * Math.sqrt(T1_R * 1.0)) / (C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M))
                        : 0;
                    const ratedLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                        ? (ratedArea * C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * 1.0)
                        : 0;
                    scenarioResults.fire_unwetted = {
                        applicable: true, label: '1B', name: 'Fire-Unwetted',
                        requiredFlow: qRelief, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'fire_unwetted'; }
                }

                // Blocked Outlet (2A)
                if (scenarioSelections.blocked_vapor?.applicable) {
                    const comp = compositions.blocked_vapor || {};
                    const cond = scenarioConditions.blocked_vapor;
                    const p1_psia = setP * 1.10 + AMBIENT_PRESSURE;
                    const M = getMolecularWeight(comp);
                    const T1 = cond.normal_op_temp;
                    const T1_R = T1 + 459.67;
                    const k = getSpecificHeatRatio(comp);
                    const C = getAPI520_C(k);
                    const flowRateInput = parseFloat(cond.flow_rate) || 0;
                    const qRelief = cond.flow_rate_unit === 'mmscfd'
                        ? (flowRateInput * 1e6 * M) / (379.5 * 24)
                        : flowRateInput;
                    const requiredArea = qRelief > 0 && M > 0 && p1_psia > 0
                        ? (qRelief * Math.sqrt(T1_R * 1.0)) / (C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M))
                        : 0;
                    const ratedLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                        ? (ratedArea * C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * 1.0)
                        : 0;
                    scenarioResults.blocked_vapor = {
                        applicable: true, label: '2A', name: 'Blocked Outlet',
                        requiredFlow: qRelief, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'blocked_vapor'; }
                }

                // Fire Wetted (1A) - placeholder
                if (scenarioSelections.fire_wetted?.applicable) {
                    scenarioResults.fire_wetted = {
                        applicable: true, label: '1A', name: 'Fire-Wetted',
                        requiredFlow: 0, ratedFlow: 0, requiredArea: 0, ratedArea,
                        adequate: true, placeholder: true
                    };
                }

                // CV Failure (3)
                if (scenarioSelections.cv_failure?.applicable) {
                    const comp = compositions.cv_failure || {};
                    const cond = scenarioConditions.cv_failure;
                    const M = getMolecularWeight(comp);
                    const Gg = M / 28.97;
                    const k = getSpecificHeatRatio(comp);
                    const Fk = k / 1.4;

                    const P1_psig = cond.upstream_pressure;
                    const P1_psia = P1_psig + 14.69;
                    const P2_psig = setP * 1.10;
                    const P2_psia = P2_psig + 14.69;
                    const deltaP = P1_psig - P2_psig;
                    const x = deltaP / P1_psia;

                    const Cv = cond.cv;
                    const XT = cond.xt;
                    const Z = 0.95;
                    const T1_R = cond.upstream_temp + 459.67;

                    const xChoked = Fk * XT;
                    const xEffective = Math.min(x, xChoked);
                    const Y = Math.max(1 - xEffective / (3 * Fk * XT), 0.667);

                    // ISA volumetric flow equation: q = N7 * Cv * P1 * Y * sqrt(x / (Gg * T * Z))
                    const N7 = 1360; // For q in scfh, P in psia, T in Â°R
                    const q_cv = Gg > 0 && T1_R > 0 && Z > 0
                        ? N7 * Cv * P1_psia * Y * Math.sqrt(xEffective / (Gg * T1_R * Z))
                        : 0;
                    const W_cv = q_cv * M / 379.5;

                    // Bypass flow calculations if applicable
                    let W = W_cv;
                    if (cond.has_bypass && cond.use_bypass_flow) {
                        const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                        const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                        const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;
                        const bypassXT = 1.0;
                        const bypassXChoked = Fk * bypassXT;
                        const bypassXEffective = Math.min(x, bypassXChoked);
                        const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                        const q_bypass = Gg > 0 && T1_R > 0 && Z > 0
                            ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                            : 0;
                        W = q_bypass * M / 379.5;
                    }

                    const C = getAPI520_C(k);
                    const requiredArea = W > 0 && M > 0 && P2_psia > 0
                        ? (W * Math.sqrt(T1_R * Z)) / (C * 0.975 * P2_psia * 1.0 * 1.0 * Math.sqrt(M))
                        : 0;
                    const ratedLoad = ratedArea > 0 && M > 0 && P2_psia > 0
                        ? (ratedArea * C * 0.975 * P2_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                        : 0;

                    scenarioResults.cv_failure = {
                        applicable: true, label: '3', name: '3 - CV Failure - Vapor',
                        requiredFlow: W, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'cv_failure'; }
                }

                // Find recommended orifice (smallest that meets required area)
                const recommendedOrifice = ORIFICES.find(o => o.area >= maxRequiredArea) || ORIFICES[ORIFICES.length - 1];
                const isUndersized = ratedArea < maxRequiredArea;

                setResults({
                    deviceInfo,
                    selectedOrifice,
                    ratedArea,
                    scenarioResults,
                    controllingScenario,
                    maxRequiredArea,
                    vesselDetails,
                    recommendedOrifice,
                    isUndersized
                });
                setStep(5);
            };

            // Generate PDF Report
            const generateReport = () => {
                if (!results) {
                    alert('No results to generate report. Please complete calculations first.');
                    return;
                }

                try {
                    if (!window.jspdf) {
                        alert('PDF library not loaded. Please refresh the page and try again.');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPos = margin;

                // Scenario name lookup
                const scenarioNames = {
                    fire_wetted: '1A - Fire-Wetted (Liquid Boil up)',
                    fire_unwetted: '1B - Fire-Unwetted (Vapor)',
                    blocked_vapor: '2A - Blocked Outlet - Vapor',
                    cv_failure: '3 - CV Failure - Vapor'
                };
                const controllingName = scenarioNames[results.controllingScenario] || results.controllingScenario;

                // Helper to add new page if needed
                const checkNewPage = (requiredSpace = 30) => {
                    if (yPos + requiredSpace > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                };

                // ========== COVER PAGE ==========
                doc.setFillColor(30, 58, 95); // Franc blue
                doc.rect(0, 0, pageWidth, 80, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('PSV Sizing Report', pageWidth / 2, 40, { align: 'center' });

                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('Pressure Safety Valve Sizing per API 520/521', pageWidth / 2, 55, { align: 'center' });

                doc.setTextColor(30, 58, 95);
                yPos = 100;

                // Device info on cover
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Device Information', margin, yPos);
                yPos += 10;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                if (deviceInfo.tag) { doc.text(`Relief Device Tag: ${deviceInfo.tag}`, margin, yPos); yPos += 7; }
                if (deviceInfo.pid_number) { doc.text(`P&ID Number: ${deviceInfo.pid_number}`, margin, yPos); yPos += 7; }
                if (deviceInfo.facility_name) { doc.text(`Facility: ${deviceInfo.facility_name}`, margin, yPos); yPos += 7; }
                if (deviceInfo.equipment_tag) { doc.text(`Equipment Tag: ${deviceInfo.equipment_tag}`, margin, yPos); yPos += 7; }

                yPos += 10;
                doc.setFont('helvetica', 'bold');
                doc.text('Valve Details', margin, yPos);
                yPos += 10;
                doc.setFont('helvetica', 'normal');
                doc.text(`Orifice Designation: ${results.selectedOrifice.letter}`, margin, yPos); yPos += 7;
                doc.text(`Rated Area: ${results.ratedArea.toFixed(3)} inÂ²`, margin, yPos); yPos += 7;
                doc.text(`Set Pressure: ${deviceInfo.set_pressure} psig`, margin, yPos); yPos += 7;
                doc.text(`Backpressure: ${deviceInfo.backpressure} psig`, margin, yPos); yPos += 7;

                yPos += 20;

                // Results summary box
                doc.setFillColor(results.isUndersized ? 254 : 240, results.isUndersized ? 226 : 253, results.isUndersized ? 226 : 244);
                doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 50, 3, 3, 'F');

                yPos += 15;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(results.isUndersized ? 220 : 22, results.isUndersized ? 38 : 163, results.isUndersized ? 38 : 74);
                doc.text(results.isUndersized ? 'UNDERSIZED' : 'ADEQUATE', pageWidth / 2, yPos, { align: 'center' });

                yPos += 12;
                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                doc.setFont('helvetica', 'normal');
                doc.text(`Controlling Scenario: ${controllingName}`, pageWidth / 2, yPos, { align: 'center' });
                yPos += 8;
                doc.text(`Required Area: ${results.maxRequiredArea.toFixed(4)} inÂ² | Rated Area: ${results.ratedArea.toFixed(3)} inÂ²`, pageWidth / 2, yPos, { align: 'center' });

                // Footer on cover
                doc.setTextColor(128, 128, 128);
                doc.setFontSize(9);
                doc.text('Franc Engineering | franceng.com', pageWidth / 2, pageHeight - 20, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 14, { align: 'center' });

                // ========== PAGE 2: INPUT SUMMARY ==========
                doc.addPage();
                yPos = margin;

                doc.setTextColor(30, 58, 95);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Input Summary', margin, yPos);
                yPos += 15;

                // Device inputs table
                doc.autoTable({
                    startY: yPos,
                    head: [['Parameter', 'Value']],
                    body: [
                        ['Relief Device Tag', deviceInfo.tag || '-'],
                        ['P&ID Number', deviceInfo.pid_number || '-'],
                        ['Facility', deviceInfo.facility_name || '-'],
                        ['Equipment Tag', deviceInfo.equipment_tag || '-'],
                        ['Orifice Designation', results.selectedOrifice.letter],
                        ['Set Pressure', `${deviceInfo.set_pressure} psig`],
                        ['Backpressure', `${deviceInfo.backpressure} psig`],
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [30, 58, 95] },
                    margin: { left: margin, right: margin }
                });

                yPos = doc.lastAutoTable.finalY + 15;

                // Fluid composition if available
                const activeScenarioId = results.controllingScenario.id;
                const comp = compositions[activeScenarioId] || {};
                const compEntries = Object.entries(comp).filter(([_, val]) => val > 0);

                if (compEntries.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Fluid Composition', margin, yPos);
                    yPos += 10;

                    doc.autoTable({
                        startY: yPos,
                        head: [['Component', 'Mol %']],
                        body: compEntries.map(([name, val]) => [name, val.toFixed(2)]),
                        theme: 'striped',
                        headStyles: { fillColor: [30, 58, 95] },
                        margin: { left: margin, right: margin }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                // ========== PAGE 3: RESULTS TABLE ==========
                doc.addPage();
                yPos = margin;

                doc.setTextColor(30, 58, 95);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Scenario Results Summary', margin, yPos);
                yPos += 15;

                // Convert scenarioResults object to array for PDF table
                const allScenarios = [
                    { id: 'fire_wetted', name: '1A - Fire-Wetted (Liquid Boil up)' },
                    { id: 'fire_unwetted', name: '1B - Fire-Unwetted (Vapor)' },
                    { id: 'blocked_vapor', name: '2A - Blocked Outlet - Vapor' },
                    { id: 'cv_failure', name: '3 - CV Failure - Vapor' }
                ];

                // Get controlling scenario name for bolding
                const controllingScenarioName = allScenarios.find(s => s.id === results.controllingScenario)?.name || '';

                const scenarioTableData = allScenarios.map(s => {
                    const r = results.scenarioResults[s.id];
                    if (r && r.applicable) {
                        return [
                            'Yes',
                            s.name,
                            r.requiredFlow.toFixed(1) + ' / ' + r.ratedFlow.toFixed(0),
                            r.requiredArea.toFixed(4),
                            r.requiredArea <= results.ratedArea ? 'Adequate' : 'Undersized'
                        ];
                    } else {
                        return ['No', s.name, '-', '-', '-'];
                    }
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['Applicable?', 'Scenario', 'Required/Rated Flow (lb/hr)', 'Required Area (inÂ²)', 'Status']],
                    body: scenarioTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [30, 58, 95] },
                    margin: { left: margin, right: margin },
                    didParseCell: function(data) {
                        // Bold the controlling scenario row
                        const scenarioName = data.row.raw[1];
                        if (scenarioName === controllingScenarioName && data.section === 'body') {
                            data.cell.styles.fontStyle = 'bold';
                        }
                        // Color the status column
                        if (data.column.index === 4 && data.section === 'body') {
                            if (data.cell.raw === 'Adequate') {
                                data.cell.styles.textColor = [22, 163, 74];
                            } else if (data.cell.raw === 'Undersized') {
                                data.cell.styles.textColor = [220, 38, 38];
                            }
                        }
                    }
                });

                yPos = doc.lastAutoTable.finalY + 20;

                // Sizing summary
                checkNewPage(60);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Sizing Summary', margin, yPos);
                yPos += 10;

                doc.autoTable({
                    startY: yPos,
                    head: [['Parameter', 'Value']],
                    body: [
                        ['Controlling Scenario', controllingName],
                        ['Required Relief Area', `${results.maxRequiredArea.toFixed(4)} inÂ²`],
                        ['Installed Orifice', results.selectedOrifice.letter],
                        ['Installed Rated Area', `${results.ratedArea.toFixed(3)} inÂ²`],
                        ['Utilization', `${((results.maxRequiredArea / results.ratedArea) * 100).toFixed(1)}%`],
                        ['Status', results.isUndersized ? 'UNDERSIZED' : 'ADEQUATE'],
                        ...(results.isUndersized ? [['Recommended Orifice', results.recommendedOrifice.letter], ['Recommended Area', `${results.recommendedOrifice.area.toFixed(3)} inÂ²`]] : [])
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [30, 58, 95] },
                    margin: { left: margin, right: margin }
                });

                // ========== PAGE 4: CALCULATION DETAILS ==========
                doc.addPage();
                yPos = margin;

                doc.setTextColor(30, 58, 95);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Calculation Details', margin, yPos);
                yPos += 15;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(60, 60, 60);

                // Add calculation methodology
                const calcText = [
                    'Sizing performed per API 520 Part I / API 521 6th Edition',
                    '',
                    'Vapor Sizing Equation (API 520):',
                    'A = W Ã— âˆš(TÃ—Z) / (C Ã— Kd Ã— P1 Ã— Kb Ã— Kc Ã— âˆšM)',
                    '',
                    'Where:',
                    '  A = Required relief area (inÂ²)',
                    '  W = Mass flow rate (lb/hr)',
                    '  T = Relieving temperature (Â°R)',
                    '  Z = Compressibility factor',
                    '  C = Coefficient from specific heat ratio k',
                    '  Kd = Discharge coefficient (0.975 for vapor)',
                    '  P1 = Relieving pressure absolute (psia)',
                    '  Kb = Backpressure correction factor',
                    '  Kc = Combination correction factor',
                    '  M = Molecular weight (lb/lb-mol)',
                    '',
                    'Fire Case (API 521):',
                    'Q = Câ‚ Ã— F Ã— A^0.82  (for wetted area)',
                    'Q = 21000 Ã— F Ã— A^0.82  (for unwetted vessels)',
                    '',
                    'W = Q Ã— M / Î»',
                    '',
                    'Where:',
                    '  Q = Heat absorption (BTU/hr)',
                    '  F = Environment factor (1.0 for no insulation)',
                    '  A = Wetted/Unwetted surface area (ftÂ²)',
                    '  Î» = Latent heat of vaporization (BTU/lb)'
                ];

                calcText.forEach(line => {
                    doc.text(line, margin, yPos);
                    yPos += 6;
                });

                // Footer on each page
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    if (i > 1) {
                        doc.text('Franc Engineering | franceng.com', pageWidth - margin, pageHeight - 10, { align: 'right' });
                    }
                }

                // Save the PDF
                const filename = `PSV_Report_${deviceInfo.tag || 'Unnamed'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('Error generating PDF: ' + error.message);
                }
            };

            // Check if all applicable scenarios have valid compositions (>=99%)
            const allCompositionsValid = applicableScenarios.every(s => getTotalMol(s.id) >= 99);

            // Updated step order: Device -> Scenario -> Fluid -> Calcs -> Results
            const STEP_LABELS = ['Device', 'Scenario', 'Fluid', 'Calcs', 'Results'];

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6">
                    {/* Header */}
                    <div className="flex justify-between items-start mb-8">
                        <div>
                            <h1 className="text-2xl sm:text-3xl font-bold franc-blue mb-2">PSV Sizing Calculator</h1>
                            <p className="text-gray-600">Pressure Safety Valve Sizing per API 520/521</p>
                            <p className="text-sm text-gray-500 mt-1">Franc Engineering | franceng.com</p>
                        </div>
                        {/* Device Info - Upper Right */}
                        {step > 1 && (deviceInfo.tag || deviceInfo.pid_number || deviceInfo.facility_name) && (
                            <div className="text-right text-sm bg-gray-100 rounded-lg p-3">
                                {deviceInfo.tag && (
                                    <div><span className="text-gray-500">Relief Device Tag:</span> <span className="font-semibold">{deviceInfo.tag}</span></div>
                                )}
                                {deviceInfo.pid_number && (
                                    <div><span className="text-gray-500">P&ID Number:</span> <span className="font-semibold">{deviceInfo.pid_number}</span></div>
                                )}
                                {deviceInfo.facility_name && (
                                    <div><span className="text-gray-500">Facility:</span> <span className="font-semibold">{deviceInfo.facility_name}</span></div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Progress Steps */}
                    <div className="flex justify-center mb-6">
                        <div className="flex items-center space-x-1 sm:space-x-2">
                            {[1, 2, 3, 4, 5].map((s) => (
                                <React.Fragment key={s}>
                                    <div
                                        className={`step-indicator w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center font-semibold cursor-pointer text-sm sm:text-base
                                            ${step >= s ? 'franc-accent-bg text-white' : 'bg-gray-200 text-gray-500'}
                                            ${step === s ? 'active ring-4 ring-blue-200' : ''}`}
                                        onClick={() => s < step && setStep(s)}
                                    >
                                        {s}
                                    </div>
                                    {s < 5 && <div className={`w-4 sm:w-8 h-1 ${step > s ? 'franc-accent-bg' : 'bg-gray-200'}`}></div>}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    {/* Step Labels */}
                    <div className="flex justify-between mb-8 text-xs sm:text-sm text-gray-500 px-2">
                        {STEP_LABELS.map((label, idx) => (
                            <span key={label} className={step === idx + 1 ? 'font-semibold franc-accent' : ''}>{label}</span>
                        ))}
                    </div>

                    {/* Step 1: Device Info */}
                    {step === 1 && (
                        <div className="fade-in bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-semibold mb-4">Relief Device Information</h2>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                {/* Relief Device Tag */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Relief Device Tag</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.tag}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, tag: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="PSV-123"
                                    />
                                </div>

                                {/* P&ID Number */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">P&ID Number</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.pid_number}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, pid_number: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="PID-001"
                                    />
                                </div>

                                {/* Facility Name */}
                                <div className="sm:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Facility Name</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.facility_name}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, facility_name: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="Enter facility name"
                                    />
                                </div>

                                {/* Protected System */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Protected System</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.protected_system}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, protected_system: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="Absorber V-123"
                                    />
                                </div>

                                {/* Protected MAWP */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Protected System MAWP (psig)</label>
                                    <input
                                        type="number"
                                        value={deviceInfo.mawp}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, mawp: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="285"
                                    />
                                </div>

                                {/* Relief Device Selection (API Sizes) */}
                                <div className="sm:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Relief Device Selection (API Sizes)</label>
                                    <select
                                        value={deviceInfo.selected_orifice}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, selected_orifice: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="">-- Calculate Required Size --</option>
                                        {ORIFICES.map((o, idx) => (
                                            <option key={`${o.letter}-${o.size}-${idx}`} value={o.size}>
                                                {o.size} â€” Orifice {o.letter} ({o.area} inÂ²) â€” Inlet: {o.inlet}, Outlet: {o.outlet}
                                            </option>
                                        ))}
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">Leave blank to calculate required orifice size</p>
                                </div>

                                {/* New or Existing */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">New or Existing</label>
                                    <select
                                        value={deviceInfo.new_or_existing}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, new_or_existing: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="new">New Installation</option>
                                        <option value="existing">Existing Device</option>
                                    </select>
                                </div>

                                {/* Discharge Location */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Discharge Location</label>
                                    <select
                                        value={deviceInfo.discharge_location}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, discharge_location: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="atmosphere">Atmosphere</option>
                                        <option value="flare">Flare</option>
                                        <option value="process">Process</option>
                                    </select>
                                </div>

                                {/* PSV Set Pressure */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">PSV Set Pressure (psig)</label>
                                    <input
                                        type="number"
                                        value={deviceInfo.set_pressure}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, set_pressure: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="285"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Typically equal to or less than MAWP</p>
                                </div>

                                {/* PSV Type */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">PSV Type</label>
                                    <select
                                        value={deviceInfo.psv_type}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, psv_type: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="conventional">CONVENTIONAL</option>
                                        <option value="balanced">BALANCED</option>
                                        <option value="pilot_modulating">PILOT (MODULATING)</option>
                                        <option value="pilot_pop">PILOT (POP-ACTING)</option>
                                    </select>
                                </div>

                                {/* P&ID Upload */}
                                <FileUpload
                                    label="P&ID Upload (PDF)"
                                    accept=".pdf"
                                    file={pidFile}
                                    onFileChange={setPidFile}
                                />

                                {/* Miscellaneous */}
                                <FileUpload
                                    label="Miscellaneous"
                                    accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"
                                    file={miscFile}
                                    onFileChange={setMiscFile}
                                />
                            </div>

                            <div className="flex justify-end mt-6">
                                <button
                                    onClick={() => setStep(2)}
                                    className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 transition"
                                >
                                    Next: Scenario â†’
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Step 2: Scenario Identification */}
                    {step === 2 && (
                        <div className="fade-in bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-semibold mb-2">Potential Relieving Scenario Identification</h2>
                            <p className="text-sm text-gray-600 mb-6">Check "Applicable" for scenarios that require calculation. Add notes to document your justification.</p>

                            <div className="space-y-4">
                                {SCENARIOS.map((s) => (
                                    <div
                                        key={s.id}
                                        className={`p-4 border-2 rounded-xl ${scenarioSelections[s.id]?.applicable ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-center space-x-3">
                                                <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">{s.label}</span>
                                                <span className="text-2xl">{s.icon}</span>
                                                <div>
                                                    <h3 className="font-semibold text-gray-900">{s.name}</h3>
                                                    <p className="text-sm text-gray-500">{s.desc}</p>
                                                </div>
                                            </div>
                                            <label className="flex items-center space-x-2 cursor-pointer">
                                                <span className={`text-sm font-medium ${scenarioSelections[s.id]?.applicable ? 'text-green-600' : 'text-gray-400'}`}>
                                                    Applicable: {scenarioSelections[s.id]?.applicable ? 'YES' : 'NO'}
                                                </span>
                                                <input
                                                    type="checkbox"
                                                    checked={scenarioSelections[s.id]?.applicable || false}
                                                    onChange={(e) => setScenarioSelections(prev => ({
                                                        ...prev,
                                                        [s.id]: { ...prev[s.id], applicable: e.target.checked }
                                                    }))}
                                                    className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                />
                                            </label>
                                        </div>
                                        <div className="mt-3">
                                            <textarea
                                                value={scenarioSelections[s.id]?.notes || ''}
                                                onChange={(e) => setScenarioSelections(prev => ({
                                                    ...prev,
                                                    [s.id]: { ...prev[s.id], notes: e.target.value }
                                                }))}
                                                className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:border-blue-500 resize-none"
                                                rows="2"
                                                placeholder="Notes / Justification (e.g., 'The system is not expected to operate with a liquid level.')"
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="flex justify-between mt-6">
                                <button onClick={() => setStep(1)} className="px-6 py-2 border rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Back
                                </button>
                                <button
                                    onClick={() => {
                                        // Set the first applicable scenario as the active one for calculation
                                        const firstApplicable = Object.entries(scenarioSelections).find(([id, sel]) => sel.applicable);
                                        if (firstApplicable) setScenario(firstApplicable[0]);
                                        setStep(3);
                                    }}
                                    disabled={!Object.values(scenarioSelections).some(s => s.applicable)}
                                    className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                >
                                    Next: Fluid â†’
                                </button>
                            </div>
                            {!Object.values(scenarioSelections).some(s => s.applicable) && (
                                <p className="text-sm text-red-500 mt-2 text-right">Please select at least one applicable scenario</p>
                            )}
                        </div>
                    )}

                    {/* Step 3: Fluid Selection */}
                    {step === 3 && (
                        <div className="fade-in bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-semibold mb-2">Select Fluid Compositions</h2>
                            <p className="text-sm text-gray-600 mb-6">
                                Enter composition for each applicable scenario.
                                {applicableScenarios.length > 1 && " Use 'Copy from first' to duplicate the first composition."}
                            </p>

                            {/* Scenario Composition Sections */}
                            <div className="space-y-6">
                                {applicableScenarios.map((scenarioItem, idx) => {
                                    const scenarioComp = compositions[scenarioItem.id] || {};
                                    const scenarioTotal = getTotalMol(scenarioItem.id);
                                    const isFirst = idx === 0;
                                    const firstScenarioId = applicableScenarios[0]?.id;

                                    return (
                                        <div key={scenarioItem.id} className="border rounded-xl p-4">
                                            {/* Scenario Header */}
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-xl">{scenarioItem.icon}</span>
                                                    <h3 className="font-semibold text-gray-900">{scenarioItem.compLabel}</h3>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    {!isFirst && (
                                                        <button
                                                            onClick={() => copyCompositionFrom(firstScenarioId, scenarioItem.id)}
                                                            className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition"
                                                        >
                                                            Copy from first
                                                        </button>
                                                    )}
                                                    <span className={`text-sm font-medium ${Math.abs(scenarioTotal - 100) < 0.1 ? 'text-green-600' : 'text-red-500'}`}>
                                                        Total: {scenarioTotal.toFixed(1)}%
                                                    </span>
                                                </div>
                                            </div>

                                            {/* Quick Presets for this scenario */}
                                            <div className="mb-4">
                                                <label className="text-xs text-gray-500 mb-1 block">Quick Select:</label>
                                                <div className="flex gap-2">
                                                    {scenarioItem.presets.map((presetId) => (
                                                        <button
                                                            key={presetId}
                                                            className="px-3 py-1.5 rounded text-sm font-medium transition bg-gray-100 hover:bg-gray-200 text-gray-700"
                                                            onClick={() => handlePresetChange(presetId, scenarioItem.id)}
                                                        >
                                                            {PRESETS[presetId]?.name}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Composition Grid - Left: Hydrocarbons, Right: Inerts/Other */}
                                            <div className="flex gap-8">
                                                {/* Left Column - Hydrocarbons */}
                                                <div className="flex-1 space-y-1">
                                                    {['methane', 'ethane', 'propane', 'isobutane', 'nbutane', 'isopentane', 'npentane', 'nhexane', 'nheptane', 'noctane', 'nnonane', 'ndecane'].map((compId) => {
                                                        const comp = COMPONENTS[compId];
                                                        return (
                                                            <div key={compId} className="flex items-center justify-between py-1 border-b border-gray-100">
                                                                <label className="text-sm text-gray-700">{comp.name} ({comp.formula})</label>
                                                                <input
                                                                    type="number"
                                                                    min="0"
                                                                    max="100"
                                                                    step="0.1"
                                                                    value={scenarioComp[compId] || ''}
                                                                    onChange={(e) => handleCompChange(scenarioItem.id, compId, e.target.value)}
                                                                    className="input-field w-20 px-2 py-1 border rounded text-sm text-right focus:outline-none"
                                                                    placeholder="0"
                                                                />
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                {/* Right Column - Inerts/Other */}
                                                <div className="flex-1 space-y-1">
                                                    {['nitrogen', 'oxygen', 'co2', 'water', 'h2s'].map((compId) => {
                                                        const comp = COMPONENTS[compId];
                                                        return (
                                                            <div key={compId} className="flex items-center justify-between py-1 border-b border-gray-100">
                                                                <label className="text-sm text-gray-700">{comp.name} ({comp.formula})</label>
                                                                <input
                                                                    type="number"
                                                                    min="0"
                                                                    max="100"
                                                                    step="0.1"
                                                                    value={scenarioComp[compId] || ''}
                                                                    onChange={(e) => handleCompChange(scenarioItem.id, compId, e.target.value)}
                                                                    className="input-field w-20 px-2 py-1 border rounded text-sm text-right focus:outline-none"
                                                                    placeholder="0"
                                                                />
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="flex justify-between mt-6">
                                <button onClick={() => setStep(2)} className="px-6 py-2 border rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Back
                                </button>
                                <button
                                    onClick={() => setStep(4)}
                                    disabled={!allCompositionsValid}
                                    className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                >
                                    Next: Calcs â†’
                                </button>
                            </div>
                            {!allCompositionsValid && (
                                <p className="text-sm text-red-500 mt-2 text-right">All compositions must total at least 99%</p>
                            )}
                        </div>
                    )}

                    {/* Step 4: Operating Conditions - Scenario Specific with Tabs */}
                    {step === 4 && (() => {
                        // Set active tab to first applicable scenario if not set
                        if (!activeConditionsTab || !scenarioSelections[activeConditionsTab]?.applicable) {
                            const firstApplicable = applicableScenarios[0];
                            if (firstApplicable && activeConditionsTab !== firstApplicable.id) {
                                setTimeout(() => setActiveConditionsTab(firstApplicable.id), 0);
                            }
                        }
                        return (
                        <div className="fade-in space-y-6">
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-2">Required Relieving Rate Calculation</h2>
                                <p className="text-sm text-gray-600 mb-4">Enter conditions for each applicable scenario. Green fields are inputs, blue fields are calculated outputs.</p>

                                {/* Scenario Tabs */}
                                {applicableScenarios.length > 1 && (
                                    <div className="flex border-b border-gray-200">
                                        {applicableScenarios.map((s) => (
                                            <button
                                                key={s.id}
                                                onClick={() => setActiveConditionsTab(s.id)}
                                                className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                                                    activeConditionsTab === s.id
                                                        ? 'border-blue-500 text-blue-600'
                                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                                }`}
                                            >
                                                {s.name}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Fire-Unwetted (1B) Section */}
                            {(activeConditionsTab === 'fire_unwetted' || (applicableScenarios.length === 1 && scenarioSelections.fire_unwetted?.applicable)) && (() => {
                                const comp = compositions.fire_unwetted || {};
                                const cond = scenarioConditions.fire_unwetted;
                                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                                const p1_psia = setP * (1 + FIRE_OVERPRESSURE) + AMBIENT_PRESSURE;
                                const p1_psig = setP * (1 + FIRE_OVERPRESSURE);
                                const M = getMolecularWeight(comp);
                                const Pcrit = getCriticalPressure(comp);
                                const T1 = calcRelievingTemp(p1_psia, cond.normal_op_pressure, cond.normal_op_temp);
                                // Calculate surface areas from vessel geometry (force 0% liquid for fire unwetted)
                                const vesselAreas = calcVesselAreas({ ...vesselDetails, max_liquid_level: 0 });
                                const unwettedArea = vesselAreas.adjustedUnwetted;
                                const qRelief = calcFireUnwettedReliefLoad(M, p1_psia, unwettedArea, MAX_WALL_TEMP, T1);
                                const qVol = calcVolumetricRate(qRelief, M, T1, p1_psia);

                                // Calculate required area using API 520 vapor equation
                                // A = W * sqrt(T*Z) / (C * Kd * P1 * Kb * sqrt(M))
                                const Kd = 0.975; // Coefficient of discharge for vapor
                                const Kb = 1.0; // Back pressure correction (assume atmospheric discharge)
                                const Kc = 1.0; // Combination correction factor (no rupture disk)
                                const T1_R = T1 + 459.67;
                                const Z = 1.0; // Simplified compressibility
                                const k = getSpecificHeatRatio(comp); // Calculate k from composition
                                const C = getAPI520_C(k); // API 520 C coefficient
                                const requiredArea = qRelief > 0 && M > 0 && p1_psia > 0
                                    ? (qRelief * Math.sqrt(T1_R * Z)) / (C * Kd * p1_psia * Kb * Kc * Math.sqrt(M))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrificeSize = deviceInfo.selected_orifice;
                                const selectedOrifice = ORIFICES.find(o => o.size === selectedOrificeSize);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                                // Calculate rated relief load (reverse of area calc)
                                const ratedReliefLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                                    ? (ratedArea * C * Kd * p1_psia * Kb * Kc * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                    <div className="bg-white rounded-xl shadow-lg p-6">
                                        <div className="flex items-center space-x-3 mb-4">
                                            <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">1B</span>
                                            <span className="text-xl">ðŸ’¨</span>
                                            <h3 className="text-lg font-semibold">Fire Unwetted (Vapor) - API 521 6th Ed. 4.4.13.2.4.3</h3>
                                        </div>

                                        {/* Relief Device Sizing Summary - AT TOP */}
                                        <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{qRelief > 0 ? qRelief.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(4) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {ratedArea > 0 && requiredArea > 0 && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-sm text-gray-600">Utilization</span>
                                                        <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                            {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                            {!selectedOrifice && (
                                                <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                            )}
                                        </div>

                                        <p className="text-xs text-gray-500 mb-4">
                                            This method applies for above-grade pressure vessels with design pressures exceeding 15 psig.
                                            Unwetted wall vessels are those where internal walls are exposed to gas/vapor.
                                        </p>

                                        {/* Operating Conditions Inputs */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-green-800 mb-3">Operating Conditions (Inputs)</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Pressure (P<sub>n</sub>)</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_pressure}
                                                            onChange={(e) => updateScenarioCondition('fire_unwetted', 'normal_op_pressure', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">psig</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Temperature (T<sub>n</sub>)</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_temp}
                                                            onChange={(e) => updateScenarioCondition('fire_unwetted', 'normal_op_temp', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">Â°F</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Vessel Details with Diagram */}
                                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                            <h4 className="font-medium text-gray-700 mb-4">Vessel Details</h4>
                                            <div className="flex gap-6">
                                                {/* Left: Vessel Inputs */}
                                                <div className="flex-1 space-y-3">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Equipment Tag</span>
                                                        <input type="text" value={vesselDetails.equipment_tag}
                                                            onChange={(e) => updateVesselDetail('equipment_tag', e.target.value)}
                                                            placeholder="V-123"
                                                            className="w-28 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Orientation</span>
                                                        <select value={vesselDetails.orientation}
                                                            onChange={(e) => updateVesselDetail('orientation', e.target.value)}
                                                            className="w-28 px-2 py-1.5 bg-green-50 border border-green-300 rounded text-sm focus:outline-none focus:border-green-500">
                                                            <option value="horizontal">Horizontal</option>
                                                            <option value="vertical">Vertical</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Head Type</span>
                                                        <select value={vesselDetails.head_type}
                                                            onChange={(e) => updateVesselDetail('head_type', e.target.value)}
                                                            className="w-36 px-2 py-1.5 bg-green-50 border border-green-300 rounded text-sm focus:outline-none focus:border-green-500">
                                                            <option value="2:1_elliptical">2:1 ELLIPTICAL</option>
                                                            <option value="flat">FLAT</option>
                                                            <option value="hemispherical">HEMISPHERICAL</option>
                                                            <option value="none">NONE</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Inner Diameter (ID)</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.inner_diameter}
                                                                onChange={(e) => updateVesselDetail('inner_diameter', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">in</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Seam-to-Seam Length</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.seam_to_seam}
                                                                onChange={(e) => updateVesselDetail('seam_to_seam', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ft</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Height Above Grade</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.height_above_grade}
                                                                onChange={(e) => updateVesselDetail('height_above_grade', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ft</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Max Liquid Operating Level</span>
                                                        <div className="flex items-center space-x-1">
                                                            <span className="text-sm font-medium text-gray-900 w-20 text-right">0</span>
                                                            <span className="text-xs text-gray-500">%</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Additional Area (+/-)</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.additional_area}
                                                                onChange={(e) => updateVesselDetail('additional_area', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ftÂ²</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Right: Vessel Diagram and Results */}
                                                <div className="w-64 flex flex-col">
                                                    {/* Vessel Diagram SVG */}
                                                    <div className="bg-white border border-gray-200 rounded-lg p-3 mb-3">
                                                        <svg viewBox="0 0 200 100" className="w-full h-24">
                                                            {vesselDetails.orientation === 'horizontal' ? (
                                                                <>
                                                                    {/* Horizontal vessel shell */}
                                                                    <rect x="40" y="20" width="120" height="60" fill="none" stroke="#374151" strokeWidth="2" rx="0"/>
                                                                    {/* Left head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="40" cy="50" rx="12" ry="30" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 40 20 A 30 30 0 0 0 40 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="40" y1="20" x2="40" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Right head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="160" cy="50" rx="12" ry="30" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 160 20 A 30 30 0 0 1 160 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="160" y1="20" x2="160" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Liquid level indication (for fire unwetted = empty) */}
                                                                    <text x="100" y="55" textAnchor="middle" className="text-xs" fill="#6b7280">Empty (Vapor)</text>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    {/* Vertical vessel shell */}
                                                                    <rect x="70" y="15" width="60" height="65" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    {/* Top head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="100" cy="15" rx="30" ry="10" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 70 15 A 30 30 0 0 1 130 15" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="70" y1="15" x2="130" y2="15" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Bottom head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="100" cy="80" rx="30" ry="10" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 70 80 A 30 30 0 0 0 130 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="70" y1="80" x2="130" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    <text x="100" y="50" textAnchor="middle" className="text-xs" fill="#6b7280">Empty</text>
                                                                </>
                                                            )}
                                                        </svg>
                                                    </div>

                                                    {/* Volume Results */}
                                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                                                        <div className="flex justify-between mb-2">
                                                            <span className="text-gray-600">Filled Volume</span>
                                                            <span className="font-medium">0 <span className="text-xs text-gray-500">US gal</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Total Volume</span>
                                                            <span className="font-medium">{vesselAreas.volume_gal > 0 ? vesselAreas.volume_gal.toFixed(1) : '-'} <span className="text-xs text-gray-500">US gal</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            {/* Relief Device Set Pressure - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relief Device Set Pressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{setP || '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            {/* Allowable Overpressure - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Allowable Overpressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">21%</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Relieving Pressure - Display (in psig) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Pressure (pâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{p1_psig > 0 ? p1_psig.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            {/* Critical Pressure - Display (from composition) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Critical Pressure (P<sub>CRIT</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{Pcrit > 0 ? Pcrit.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psia</span>
                                                </div>
                                            </div>

                                            {/* Vapor Molecular Weight - Display (from composition) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Vapor Molecular Weight (M)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{M > 0 ? M.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Maximum Wall Temperature - Display (fixed) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Maximum Wall Temperature (T<sub>W</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{MAX_WALL_TEMP.toLocaleString()}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            {/* Unwetted Surface Area from Vessel Geometry */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-blue-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Unwetted Surface Area (A')</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-blue-700 w-24 text-right">{unwettedArea > 0 ? unwettedArea.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">ftÂ²</span>
                                                </div>
                                            </div>

                                            {/* Relieving Temperature - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Temperature (Tâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{T1 > 0 ? T1.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            {/* Relief Load - Display (highlighted) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-red-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Relief Load (q<sub>m,relief</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-red-700 w-24 text-right">{qRelief > 0 ? qRelief.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">lb/hr</span>
                                                </div>
                                            </div>

                                            {/* Volumetric Relieving Rate - Display (highlighted) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-red-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Required Volumetric Relieving Rate</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-red-700 w-24 text-right">{qVol > 0 ? qVol.toFixed(3) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">MMscfd</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Fire-Wetted (1A) Section */}
                            {(activeConditionsTab === 'fire_wetted' || (applicableScenarios.length === 1 && scenarioSelections.fire_wetted?.applicable)) && (
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="flex items-center space-x-3 mb-4">
                                        <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">1A</span>
                                        <span className="text-xl">ðŸ”¥</span>
                                        <h3 className="text-lg font-semibold">Fire-Wetted (Liquid Boil up)</h3>
                                    </div>
                                    <div className="bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4">
                                        <p className="text-sm text-gray-500">Fire-Wetted calculation section coming soon...</p>
                                    </div>
                                </div>
                            )}

                            {/* Blocked Outlet (2A) Section */}
                            {(activeConditionsTab === 'blocked_vapor' || (applicableScenarios.length === 1 && scenarioSelections.blocked_vapor?.applicable)) && (() => {
                                const comp = compositions.blocked_vapor || {};
                                const cond = scenarioConditions.blocked_vapor;
                                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                                const BLOCKED_OVERPRESSURE = 0.10; // 10% for non-fire scenarios
                                const p1_psig = setP * (1 + BLOCKED_OVERPRESSURE);
                                const p1_psia = p1_psig + AMBIENT_PRESSURE;
                                const M = getMolecularWeight(comp);
                                const k = getSpecificHeatRatio(comp);
                                const C = getAPI520_C(k);

                                // For isenthalpic flash, T1 â‰ˆ Tn (simplified - actual requires EOS)
                                // In reality would flash to ensure vapor fraction = 1.0
                                const T1 = cond.normal_op_temp; // Simplified: use operating temp
                                const T1_R = T1 + 459.67;

                                // Get flow rate in lb/hr (convert if needed)
                                const flowRateInput = parseFloat(cond.flow_rate) || 0;
                                let qRelief_lb_hr, qRelief_mmscfd;
                                if (cond.flow_rate_unit === 'mmscfd') {
                                    qRelief_mmscfd = flowRateInput;
                                    // Convert MMscfd to lb/hr: (MMscfd * 1e6 * M) / (379.5 * 24)
                                    qRelief_lb_hr = (flowRateInput * 1e6 * M) / (379.5 * 24);
                                } else {
                                    qRelief_lb_hr = flowRateInput;
                                    // Convert lb/hr to MMscfd
                                    qRelief_mmscfd = M > 0 ? (flowRateInput * 379.5 * 24) / (1e6 * M) : 0;
                                }

                                // Calculate required area using API 520 vapor equation
                                const Kd = 0.975;
                                const Kb = 1.0;
                                const Kc = 1.0;
                                const Z = 1.0;
                                const requiredArea = qRelief_lb_hr > 0 && M > 0 && p1_psia > 0
                                    ? (qRelief_lb_hr * Math.sqrt(T1_R * Z)) / (C * Kd * p1_psia * Kb * Kc * Math.sqrt(M))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrificeSize = deviceInfo.selected_orifice;
                                const selectedOrifice = ORIFICES.find(o => o.size === selectedOrificeSize);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                                // Calculate rated relief load
                                const ratedReliefLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                                    ? (ratedArea * C * Kd * p1_psia * Kb * Kc * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                    <div className="bg-white rounded-xl shadow-lg p-6">
                                        <div className="flex items-center space-x-3 mb-4">
                                            <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">2A</span>
                                            <span className="text-xl">â›”</span>
                                            <h3 className="text-lg font-semibold">Blocked Outlet - Vapor</h3>
                                        </div>

                                        {/* Relief Device Sizing Summary - AT TOP */}
                                        <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{qRelief_lb_hr > 0 ? qRelief_lb_hr.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(4) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {ratedArea > 0 && requiredArea > 0 && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-sm text-gray-600">Utilization</span>
                                                        <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                            {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                            {!selectedOrifice && (
                                                <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                            )}
                                        </div>

                                        {/* Operating Conditions Inputs */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-green-800 mb-3">Operating Conditions (Inputs)</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Pressure</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_pressure}
                                                            onChange={(e) => updateScenarioCondition('blocked_vapor', 'normal_op_pressure', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">psig</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Temperature</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_temp}
                                                            onChange={(e) => updateScenarioCondition('blocked_vapor', 'normal_op_temp', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">Â°F</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Calculated Values */}
                                        <div className="space-y-2 mb-4">
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relief Device Set Pressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{setP || '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Allowable Overpressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">10%</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Pressure (pâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{p1_psig > 0 ? p1_psig.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 group relative">
                                                <span className="text-sm text-gray-700 cursor-help border-b border-dotted border-gray-400">
                                                    Relieving Temperature (Tâ‚)
                                                    <span className="invisible group-hover:visible absolute left-0 top-full mt-1 p-2 bg-gray-800 text-white text-xs rounded shadow-lg z-10 w-64">
                                                        Isenthalpically flashed to relieving pressure to ensure vapor fraction of 1.0
                                                    </span>
                                                </span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{T1 > 0 ? T1.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Vapor Molecular Weight (M)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{M > 0 ? M.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Relieving Rate Input */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <h4 className="font-medium text-green-800 mb-3">Relieving Rate (Input)</h4>
                                            <div className="flex items-center space-x-4">
                                                {/* Toggle Buttons */}
                                                <div className="flex rounded-lg overflow-hidden border border-green-300">
                                                    <button type="button"
                                                        onClick={() => updateScenarioCondition('blocked_vapor', 'flow_rate_unit', 'lb_hr')}
                                                        className={`px-3 py-1.5 text-sm font-medium transition ${
                                                            cond.flow_rate_unit === 'lb_hr'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-gray-600 hover:bg-gray-50'
                                                        }`}>
                                                        lb/hr
                                                    </button>
                                                    <button type="button"
                                                        onClick={() => updateScenarioCondition('blocked_vapor', 'flow_rate_unit', 'mmscfd')}
                                                        className={`px-3 py-1.5 text-sm font-medium transition ${
                                                            cond.flow_rate_unit === 'mmscfd'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-gray-600 hover:bg-gray-50'
                                                        }`}>
                                                        MMscfd
                                                    </button>
                                                </div>
                                                <input type="number" value={cond.flow_rate}
                                                    onChange={(e) => updateScenarioCondition('blocked_vapor', 'flow_rate', e.target.value)}
                                                    className="w-28 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                <span className="text-sm text-gray-400">
                                                    {cond.flow_rate_unit === 'lb_hr'
                                                        ? `= ${qRelief_mmscfd > 0 ? qRelief_mmscfd.toFixed(2) : '-'} MMscfd`
                                                        : `= ${qRelief_lb_hr > 0 ? qRelief_lb_hr.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} lb/hr`
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* CV Failure (3) Section */}
                            {(activeConditionsTab === 'cv_failure' || (applicableScenarios.length === 1 && scenarioSelections.cv_failure?.applicable)) && (() => {
                                const comp = compositions.cv_failure || {};
                                const cond = scenarioConditions.cv_failure;
                                const setP = parseFloat(deviceInfo.set_pressure) || 150;

                                // Calculated vapor properties
                                const M = getMolecularWeight(comp);
                                const Gg = M / 28.97; // Specific gravity relative to air
                                const k = getSpecificHeatRatio(comp);
                                const Fk = k / 1.4; // Ratio of specific heats factor

                                // Pressures
                                const P1_psig = cond.upstream_pressure;
                                const P1_psia = P1_psig + 14.69;
                                const P2_psig = setP * 1.10; // Relieving pressure (10% overpressure)
                                const P2_psia = P2_psig + 14.69;
                                const deltaP = P1_psig - P2_psig;
                                const x = deltaP / P1_psia; // Pressure drop ratio

                                // Control valve calculations
                                const Cv = cond.cv;
                                const XT = cond.xt;
                                const Z = 0.95; // Compressibility factor (fixed)
                                const T1 = cond.upstream_temp;
                                const T1_R = T1 + 459.67;

                                // Limit x to Fk*XT (choked flow limit)
                                const xChoked = Fk * XT;
                                const xEffective = Math.min(x, xChoked);

                                // Expansion factor Y (limited to 0.667 minimum)
                                const Y = Math.max(1 - xEffective / (3 * Fk * XT), 0.667);

                                // Volumetric flow q (scfh) - ISA equation with N7 = 1360
                                const N7 = 1360; // For q in scfh, P in psia, T in Â°R
                                const q_cv = Gg > 0 && T1_R > 0 && Z > 0
                                    ? N7 * Cv * P1_psia * Y * Math.sqrt(xEffective / (Gg * T1_R * Z))
                                    : 0;

                                // CV Mass flow W (lb/hr) = q * M / 379.5 (molar volume at STP)
                                const W_cv = q_cv * M / 379.5;

                                // Bypass flow calculations
                                const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                                const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;
                                const bypassXT = 1.0; // Fixed for bypass valves

                                const bypassXChoked = Fk * bypassXT;
                                const bypassXEffective = Math.min(x, bypassXChoked);
                                const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                                const q_bypass = cond.has_bypass && Gg > 0 && T1_R > 0 && Z > 0
                                    ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                                    : 0;
                                const W_bypass = q_bypass * M / 379.5;

                                // Use CV or Bypass flow based on checkbox
                                const q = cond.has_bypass && cond.use_bypass_flow ? q_bypass : q_cv;
                                const W = cond.has_bypass && cond.use_bypass_flow ? W_bypass : W_cv;

                                // For display purposes, keep Cg based on CV
                                const Cg = Cv * 40 * Math.sqrt(XT);

                                // Calculate required area
                                const C = getAPI520_C(k);
                                const Kd = 0.975;
                                const requiredArea = W > 0 && M > 0 && P2_psia > 0
                                    ? (W * Math.sqrt(T1_R * Z)) / (C * Kd * P2_psia * 1.0 * 1.0 * Math.sqrt(M))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrifice = ORIFICES.find(o => o.size === deviceInfo.selected_orifice);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                                // Calculate rated relief load
                                const ratedReliefLoad = ratedArea > 0 && M > 0 && P2_psia > 0
                                    ? (ratedArea * C * Kd * P2_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="flex items-center space-x-3 mb-4">
                                        <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">3</span>
                                        <span className="text-xl">âš ï¸</span>
                                        <h3 className="text-lg font-semibold">CV Failure - Vapor</h3>
                                    </div>

                                    {/* Relief Device Sizing Summary - matches Fire Unwetted format */}
                                    <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                        <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Load</span>
                                                        <span className="text-sm font-medium">{W > 0 ? W.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Area</span>
                                                        <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(4) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Load</span>
                                                        <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Area</span>
                                                        <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {ratedArea > 0 && requiredArea > 0 && (
                                            <div className="mt-3 pt-3 border-t border-gray-200">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">Utilization</span>
                                                    <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                        {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                        {!selectedOrifice && (
                                            <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                        )}
                                    </div>

                                    {/* Vapor Properties (from composition) */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Vapor Properties</h4>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 bg-gray-50 rounded-lg p-4">
                                            <div>
                                                <p className="text-xs text-gray-500">Molecular Weight</p>
                                                <p className="font-semibold">{M > 0 ? M.toFixed(2) : 'â€”'} <span className="text-xs text-gray-400">lb/lbmol</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Specific Gravity (G<sub>g</sub>)</p>
                                                <p className="font-semibold">{Gg > 0 ? Gg.toFixed(3) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Specific Heat Ratio (k)</p>
                                                <p className="font-semibold">{k > 0 ? k.toFixed(3) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Ratio Factor (F<sub>k</sub>)</p>
                                                <p className="font-semibold">{Fk > 0 ? Fk.toFixed(3) : 'â€”'}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Upstream Properties */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Upstream Properties</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Maximum Operating Pressure (P<sub>1</sub>)
                                                </label>
                                                <div className="flex items-center">
                                                    <input
                                                        type="number"
                                                        value={cond.upstream_pressure}
                                                        onChange={(e) => updateScenarioCondition('cv_failure', 'upstream_pressure', e.target.value)}
                                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                    />
                                                    <span className="ml-2 text-sm text-gray-500">psig</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Temperature (T<sub>1</sub>)
                                                </label>
                                                <div className="flex items-center">
                                                    <input
                                                        type="number"
                                                        value={cond.upstream_temp}
                                                        onChange={(e) => updateScenarioCondition('cv_failure', 'upstream_temp', e.target.value)}
                                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                    />
                                                    <span className="ml-2 text-sm text-gray-500">Â°F</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Downstream Properties (calculated) */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Downstream Properties</h4>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 bg-gray-50 rounded-lg p-4">
                                            <div>
                                                <p className="text-xs text-gray-500">Relief Device Set Pressure</p>
                                                <p className="font-semibold">{setP} <span className="text-xs text-gray-400">psig</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Allowable Overpressure</p>
                                                <p className="font-semibold">10%</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Relieving Pressure (P<sub>2</sub>)</p>
                                                <p className="font-semibold">{P2_psig.toFixed(0)} <span className="text-xs text-gray-400">psig</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Pressure Drop Ratio (x)</p>
                                                <p className="font-semibold">{x > 0 ? x.toFixed(3) : 'â€”'}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Control Valve Specification */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Control Valve Specification</h4>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Valve Tag</label>
                                                <input
                                                    type="text"
                                                    value={cond.valve_tag}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'valve_tag', e.target.value)}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                    placeholder="LCV-485"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Full-Open Valve Coefficient (C<sub>v</sub>)
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    value={cond.cv}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'cv', e.target.value)}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Pressure Drop Ratio Factor (X<sub>T</sub>)
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={cond.xt}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'xt', e.target.value)}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Bypass Valve Section */}
                                    <div className="mb-6">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-medium text-gray-700">Bypass Valve</h4>
                                            <label className="flex items-center cursor-pointer">
                                                <span className="text-sm text-gray-600 mr-3">Has Bypass Valve?</span>
                                                <div className="relative">
                                                    <input
                                                        type="checkbox"
                                                        checked={cond.has_bypass}
                                                        onChange={(e) => updateScenarioCondition('cv_failure', 'has_bypass', e.target.checked)}
                                                        className="sr-only"
                                                    />
                                                    <div className={`w-10 h-6 rounded-full transition ${cond.has_bypass ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                                                    <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition transform ${cond.has_bypass ? 'translate-x-4' : ''}`}></div>
                                                </div>
                                            </label>
                                        </div>

                                        <div className={`grid grid-cols-2 gap-4 p-4 rounded-lg border ${cond.has_bypass ? 'bg-white border-gray-200' : 'bg-gray-100 border-gray-200 opacity-50'}`}>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Valve Type</label>
                                                <select
                                                    value={cond.bypass_valve_type}
                                                    onChange={(e) => {
                                                        updateScenarioCondition('cv_failure', 'bypass_valve_type', e.target.value);
                                                        // Reset size to first available for new valve type
                                                        const sizes = e.target.value === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                                        updateScenarioCondition('cv_failure', 'bypass_size', sizes[0].size);
                                                    }}
                                                    disabled={!cond.has_bypass}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none disabled:bg-gray-100"
                                                >
                                                    <option value="globe">Globe Valve</option>
                                                    <option value="ball">Ball Valve</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Nominal Size (C<sub>v</sub>)
                                                </label>
                                                <select
                                                    value={cond.bypass_size}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'bypass_size', e.target.value)}
                                                    disabled={!cond.has_bypass}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none disabled:bg-gray-100"
                                                >
                                                    {(cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL).map(v => (
                                                        <option key={v.size} value={v.size}>{v.size} (Cv = {v.cv})</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Bypass Flow Calculation (shown when bypass exists) */}
                                        {cond.has_bypass && (() => {
                                            const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                            const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                                            const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;
                                            const bypassXT = 1.0; // Fixed for bypass valves

                                            const bypassXChoked = Fk * bypassXT;
                                            const bypassXEffective = Math.min(x, bypassXChoked);
                                            const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                                            const bypassQ = Gg > 0 && T1_R > 0 && Z > 0
                                                ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                                                : 0;
                                            const bypassW = bypassQ * M / 379.5;

                                            return (
                                                <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <h5 className="font-medium text-amber-800">Bypass Flow Calculation</h5>
                                                        <label className="flex items-center cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={cond.use_bypass_flow}
                                                                onChange={(e) => updateScenarioCondition('cv_failure', 'use_bypass_flow', e.target.checked)}
                                                                className="w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500"
                                                            />
                                                            <span className="ml-2 text-sm text-amber-700">Use bypass flow for sizing</span>
                                                        </label>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                                        <div>
                                                            <p className="text-xs text-gray-500">Bypass C<sub>v</sub></p>
                                                            <p className="font-semibold text-amber-700">{bypassCv}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-gray-500">Bypass Flow (q)</p>
                                                            <p className="font-semibold text-amber-700">{bypassQ > 0 ? bypassQ.toLocaleString(undefined, {maximumFractionDigits: 0}) : 'â€”'} <span className="text-xs">scfh</span></p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-gray-500">Bypass Mass Flow (W)</p>
                                                            <p className="font-semibold text-amber-700">{bypassW > 0 ? bypassW.toLocaleString(undefined, {maximumFractionDigits: 0}) : 'â€”'} <span className="text-xs">lb/hr</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>

                                    {/* Calculated Flow Values */}
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 className="font-medium text-green-800 mb-3">Calculated Flow Through Failed Valve</h4>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                            <div>
                                                <p className="text-xs text-gray-500">Gas Sizing Coef (C<sub>g</sub>)</p>
                                                <p className="font-semibold text-green-700">{Cg > 0 ? Cg.toFixed(0) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Expansion Factor (Y)</p>
                                                <p className="font-semibold text-green-700">{Y > 0 ? Y.toFixed(3) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Volumetric Flow (q)</p>
                                                <p className="font-semibold text-green-700">{q > 0 ? q.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : 'â€”'} <span className="text-xs">scfh</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Mass Flow (W)</p>
                                                <p className="font-semibold text-green-700">{W > 0 ? W.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : 'â€”'} <span className="text-xs">lb/hr</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                );
                            })()}

                            {/* Navigation */}
                            <div className="flex justify-between">
                                <button onClick={() => setStep(3)} className="px-6 py-2 border bg-white rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Back
                                </button>
                                <button onClick={calculate} className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 transition">
                                    Calculate â†’
                                </button>
                            </div>
                        </div>
                        );
                    })()}

                    {/* Step 5: Results */}
                    {step === 5 && results && (
                        <div className="fade-in space-y-6">
                            {/* Device Header */}
                            {(results.deviceInfo?.tag || results.deviceInfo?.facility_name) && (
                                <div className="bg-gray-100 rounded-xl p-4">
                                    <div className="flex flex-wrap gap-4 text-sm">
                                        {results.deviceInfo.tag && (
                                            <div><span className="text-gray-500">Tag:</span> <span className="font-semibold">{results.deviceInfo.tag}</span></div>
                                        )}
                                        {results.deviceInfo.facility_name && (
                                            <div><span className="text-gray-500">Facility:</span> <span className="font-semibold">{results.deviceInfo.facility_name}</span></div>
                                        )}
                                        {results.deviceInfo.pid_number && (
                                            <div><span className="text-gray-500">P&ID:</span> <span className="font-semibold">{results.deviceInfo.pid_number}</span></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Sizing Results Card */}
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-4">Sizing Results</h2>

                                {/* Controlling Scenario vs Installed Device vs Recommended */}
                                <div className="bg-blue-50 rounded-xl p-6 mb-6">
                                    <div className={`grid gap-6 ${results.isUndersized ? 'grid-cols-3' : 'grid-cols-2'}`}>
                                        <div className="text-center">
                                            <p className="text-sm text-gray-600 mb-1">Controlling Scenario</p>
                                            <p className="text-2xl font-bold text-blue-700 mb-1">
                                                {results.controllingScenario ? results.scenarioResults[results.controllingScenario]?.name : '-'}
                                            </p>
                                            <p className="text-lg text-gray-700">
                                                Required Area: <span className="font-semibold">{results.maxRequiredArea > 0 ? results.maxRequiredArea.toFixed(4) : '-'}</span> inÂ²
                                            </p>
                                        </div>
                                        <div className="text-center border-l border-blue-200">
                                            <p className="text-sm text-gray-600 mb-1">Installed Device</p>
                                            <p className={`text-2xl font-bold mb-1 ${results.isUndersized ? 'text-red-600' : 'franc-accent'}`}>
                                                {results.selectedOrifice ? results.selectedOrifice.letter : '-'}
                                            </p>
                                            <p className="text-lg text-gray-700">
                                                Rated Area: <span className="font-semibold">{results.ratedArea > 0 ? results.ratedArea.toFixed(3) : '-'}</span> inÂ²
                                            </p>
                                        </div>
                                        {results.isUndersized && results.recommendedOrifice && (
                                            <div className="text-center border-l border-blue-200">
                                                <p className="text-sm text-gray-600 mb-1">Recommended Device</p>
                                                <p className="text-2xl font-bold text-green-600 mb-1">
                                                    {results.recommendedOrifice.letter}
                                                </p>
                                                <p className="text-lg text-gray-700">
                                                    Rated Area: <span className="font-semibold">{results.recommendedOrifice.area.toFixed(3)}</span> inÂ²
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                    {results.ratedArea > 0 && results.maxRequiredArea > 0 && (
                                        <div className="mt-4 pt-4 border-t border-blue-200 text-center">
                                            <span className={`text-lg font-bold ${!results.isUndersized ? 'text-green-600' : 'text-red-600'}`}>
                                                {!results.isUndersized ? 'âœ“ ADEQUATE' : 'âœ— UNDERSIZED'}
                                            </span>
                                            <span className="text-gray-500 ml-2">
                                                ({((results.maxRequiredArea / results.ratedArea) * 100).toFixed(1)}% utilized)
                                            </span>
                                        </div>
                                    )}
                                </div>

                                {/* Summary of Potential Relieving Scenarios Table */}
                                <h3 className="font-medium mb-3">Summary of Potential Relieving Scenarios</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-3 py-2 text-left">Applicable?</th>
                                                <th className="border border-gray-300 px-3 py-2 text-left">Scenario</th>
                                                <th className="border border-gray-300 px-3 py-2 text-right">Required/Rated Flow (lb/hr)</th>
                                                <th className="border border-gray-300 px-3 py-2 text-right">Required Area (inÂ²)</th>
                                                <th className="border border-gray-300 px-3 py-2 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {SCENARIOS.map(s => {
                                                const sr = results.scenarioResults[s.id];
                                                const isControlling = results.controllingScenario === s.id;
                                                const isApplicable = scenarioSelections[s.id]?.applicable;
                                                return (
                                                    <tr key={s.id} className={isControlling ? 'bg-yellow-50 font-bold' : ''}>
                                                        <td className="border border-gray-300 px-3 py-2">
                                                            <span className={isApplicable ? 'text-green-600' : 'text-gray-400'}>
                                                                {isApplicable ? 'YES' : 'NO'}
                                                            </span>
                                                        </td>
                                                        <td className="border border-gray-300 px-3 py-2">{s.name}</td>
                                                        <td className="border border-gray-300 px-3 py-2 text-right">
                                                            {sr && !sr.placeholder
                                                                ? `${sr.requiredFlow > 0 ? sr.requiredFlow.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} / ${sr.ratedFlow > 0 ? sr.ratedFlow.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}`
                                                                : '-'
                                                            }
                                                        </td>
                                                        <td className="border border-gray-300 px-3 py-2 text-right">
                                                            {sr && !sr.placeholder && sr.requiredArea > 0 ? sr.requiredArea.toFixed(4) : '-'}
                                                        </td>
                                                        <td className="border border-gray-300 px-3 py-2 text-center">
                                                            {sr && !sr.placeholder ? (
                                                                <span className={sr.adequate ? 'text-green-600' : 'text-red-600 font-bold'}>
                                                                    {sr.adequate ? 'Adequate' : 'Undersized'}
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400">-</span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Report Options */}
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <h3 className="text-lg font-semibold mb-4 franc-blue">Report Sections</h3>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeInputs}
                                            onChange={(e) => setReportOptions({...reportOptions, includeInputs: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Device Inputs</span>
                                    </label>
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeResults}
                                            onChange={(e) => setReportOptions({...reportOptions, includeResults: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Results Table</span>
                                    </label>
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeCalcs}
                                            onChange={(e) => setReportOptions({...reportOptions, includeCalcs: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Calculations</span>
                                    </label>
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeAppendix}
                                            onChange={(e) => setReportOptions({...reportOptions, includeAppendix: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Appendix/Uploads</span>
                                    </label>
                                </div>
                            </div>

                            {/* Professional Reports & Services */}
                            <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl shadow-lg p-6 text-white">
                                <h3 className="text-xl font-semibold mb-2">Professional Reports & Services</h3>
                                <p className="text-blue-100 mb-4">Auto-generate a detailed PDF report with all inputs and calculations.</p>

                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div className="bg-white/10 rounded-lg p-4">
                                        <p className="font-semibold text-lg">Standard Report</p>
                                        <p className="text-sm text-blue-200 mb-2">First report FREE!</p>
                                        <p className="text-3xl font-bold my-2">$99<span className="text-sm font-normal">/each after</span></p>
                                        <ul className="text-sm text-blue-100 space-y-1 mb-4">
                                            <li>âœ“ Full calculation package</li>
                                            <li>âœ“ Auto-generated PDF</li>
                                            <li>âœ“ All inputs documented</li>
                                        </ul>
                                        <button onClick={generateReport} className="w-full py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition">
                                            Generate Report
                                        </button>
                                    </div>

                                    <div className="bg-white/10 rounded-lg p-4 ring-2 ring-yellow-400">
                                        <p className="font-semibold text-lg">PE-Reviewed Report</p>
                                        <p className="text-sm text-yellow-300 mb-2">Engineer Stamped</p>
                                        <p className="text-3xl font-bold my-2">$499</p>
                                        <ul className="text-sm text-blue-100 space-y-1 mb-4">
                                            <li>âœ“ Everything in Standard</li>
                                            <li>âœ“ PE stamp (TX/CO)</li>
                                            <li>âœ“ 48-72 hour delivery</li>
                                        </ul>
                                        <button
                                           onClick={() => {
                                               // TODO: Replace with actual Stripe checkout URL
                                               // window.location.href = 'https://checkout.stripe.com/your-checkout-link';
                                               alert('Stripe checkout coming soon! For now, please email caseym@franceng.com');
                                               window.location.href = 'mailto:caseym@franceng.com?subject=PSV%20PE-Reviewed%20Report%20Request&body=I%20would%20like%20to%20request%20a%20PE-Reviewed%20PSV%20Sizing%20Report.';
                                           }}
                                           className="w-full py-2 bg-yellow-400 text-blue-900 rounded-lg font-medium hover:bg-yellow-300 transition">
                                            Request Quote
                                        </button>
                                    </div>

                                    <div className="bg-white/10 rounded-lg p-4">
                                        <p className="font-semibold text-lg">PSV Sizing Services</p>
                                        <p className="text-sm text-blue-200 mb-2">Let us do it for you</p>
                                        <p className="text-3xl font-bold my-2">Custom</p>
                                        <ul className="text-sm text-blue-100 space-y-1 mb-4">
                                            <li>âœ“ Full engineering review</li>
                                            <li>âœ“ Multiple scenarios</li>
                                            <li>âœ“ Turnkey solution</li>
                                        </ul>
                                        <button
                                           onClick={() => {
                                               window.open('https://franceng.com/contact/', '_blank');
                                               window.location.href = 'mailto:caseym@franceng.com?subject=PSV%20Sizing%20Services%20Inquiry';
                                           }}
                                           className="w-full py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition">
                                            Contact Us
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Back Button */}
                            <div className="flex justify-between">
                                <button onClick={() => setStep(1)} className="px-6 py-2 border bg-white rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Start Over
                                </button>
                                <button onClick={() => setStep(4)} className="px-6 py-2 border bg-white rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Modify Calcs
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="mt-8 text-center text-sm text-gray-500">
                        <p>Calculations per API 520/521. For screening purposes only.</p>
                        <p className="mt-1">Â© 2024 Franc Engineering | <a href="https://franceng.com" className="hover:underline">franceng.com</a></p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PSVCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
