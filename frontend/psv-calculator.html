<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSV Calculator | Franc Engineering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .franc-blue { color: #1e3a5f; }
        .franc-blue-bg { background-color: #1e3a5f; }
        .franc-accent { color: #2563eb; }
        .franc-accent-bg { background-color: #2563eb; }
        .step-indicator { transition: all 0.3s ease; }
        .step-indicator.active { transform: scale(1.1); }
        .scenario-card { transition: all 0.2s ease; }
        .scenario-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .scenario-card.selected { border-color: #2563eb; background-color: #eff6ff; }
        .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input::placeholder { color: #9ca3af; }
        .file-upload { border: 2px dashed #d1d5db; transition: all 0.2s ease; }
        .file-upload:hover { border-color: #2563eb; background-color: #f8fafc; }
        .file-upload.has-file { border-color: #22c55e; background-color: #f0fdf4; }

        /* Dark Mode Styles */
        .dark-mode { color: #e5e7eb; }
        .dark-mode .bg-white { background-color: #1f2937 !important; }
        .dark-mode .bg-gray-50 { background-color: #111827 !important; }
        .dark-mode .bg-gray-100 { background-color: #374151 !important; }
        .dark-mode .bg-gray-200 { background-color: #4b5563 !important; }
        .dark-mode .text-gray-900 { color: #f9fafb !important; }
        .dark-mode .text-gray-800 { color: #f3f4f6 !important; }
        .dark-mode .text-gray-700 { color: #e5e7eb !important; }
        .dark-mode .text-gray-600 { color: #d1d5db !important; }
        .dark-mode .text-gray-500 { color: #9ca3af !important; }
        .dark-mode .border-gray-200 { border-color: #4b5563 !important; }
        .dark-mode .border-gray-300 { border-color: #6b7280 !important; }
        .dark-mode input, .dark-mode select, .dark-mode textarea {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border-color: #4b5563 !important;
        }
        .dark-mode input::placeholder { color: #9ca3af !important; }
        .dark-mode .scenario-card { background-color: #1f2937; border-color: #4b5563; }
        .dark-mode .scenario-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .dark-mode .scenario-card.selected { border-color: #3b82f6; background-color: #1e3a5f; }
        .dark-mode .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important; }
        .dark-mode .rounded-xl { background-color: #1f2937; }
        body.dark { background-color: #111827 !important; }
        /* Additional Dark Mode Fixes - Colored Sections */
        .dark-mode .bg-amber-50 { background-color: #374151 !important; }
        .dark-mode .border-amber-200 { border-color: #d97706 !important; }
        .dark-mode .text-amber-800 { color: #fbbf24 !important; }
        .dark-mode .bg-amber-100 { background-color: #4b5563 !important; }

        .dark-mode .bg-green-50 { background-color: #1f2937 !important; }
        .dark-mode .border-green-200 { border-color: #22c55e !important; }
        .dark-mode .border-green-300 { border-color: #22c55e !important; }
        .dark-mode .text-green-800 { color: #86efac !important; }
        .dark-mode .bg-green-100 { background-color: #374151 !important; }

        .dark-mode .bg-blue-50 { background-color: #1e3a5f !important; }
        .dark-mode .border-blue-200 { border-color: #3b82f6 !important; }
        .dark-mode .text-blue-700 { color: #93c5fd !important; }
        .dark-mode .bg-blue-100 { background-color: #1e3a5f !important; }

        .dark-mode .bg-purple-50 { background-color: #2d1f47 !important; }
        .dark-mode .border-purple-200 { border-color: #a855f7 !important; }
        .dark-mode .text-purple-800 { color: #c4b5fd !important; }
        .dark-mode .text-purple-700 { color: #c4b5fd !important; }
        .dark-mode .bg-purple-100 { background-color: #3b2d5c !important; }

        .dark-mode .bg-orange-50 { background-color: #3d2814 !important; }
        .dark-mode .text-orange-700 { color: #fdba74 !important; }

        .dark-mode .bg-red-50 { background-color: #3d1418 !important; }
        .dark-mode .text-red-700 { color: #fca5a5 !important; }

        .dark-mode .border-gray-100 { border-color: #374151 !important; }
        .dark-mode .text-gray-400 { color: #9ca3af !important; }
        /* Dark mode for highlighted/controlling scenario row */
        .dark-mode .bg-yellow-50 { background-color: #3d3514 !important; }
        .dark-mode tr.bg-yellow-50 { background-color: #3d3514 !important; }
        .dark-mode tr.bg-yellow-50 td { background-color: #3d3514 !important; color: #fef08a !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" id="app-body">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration - Update this for production
        const API_BASE = 'https://psv-calculator-production.up.railway.app';

        // Component Database
        // Component Database
        // cp: ideal gas molar heat capacity at 25Â°C (J/molÂ·K)
        // cpL: liquid molar heat capacity near bubble point (J/molÂ·K) - from DIPPR/API
        const COMPONENTS = {
            methane: { name: 'Methane', formula: 'C1', mw: 16.043, tc: 190.56, pc: 4599000, omega: 0.0115, cp: 35.69, cpL: 54.0, lfl: 5.0, ufl: 15.0, hv: 219 },
            ethane: { name: 'Ethane', formula: 'C2', mw: 30.070, tc: 305.32, pc: 4872000, omega: 0.0995, cp: 52.49, cpL: 70.0, lfl: 3.0, ufl: 12.4, hv: 210 },
            propane: { name: 'Propane', formula: 'C3', mw: 44.096, tc: 369.83, pc: 4248000, omega: 0.1523, cp: 73.60, cpL: 115.0, lfl: 2.1, ufl: 9.5, hv: 183 },
            isobutane: { name: 'Isobutane', formula: 'iC4', mw: 58.122, tc: 407.85, pc: 3640000, omega: 0.1835, cp: 96.65, cpL: 130.0, lfl: 1.8, ufl: 8.4, hv: 157 },
            nbutane: { name: 'n-Butane', formula: 'nC4', mw: 58.122, tc: 425.12, pc: 3796000, omega: 0.2002, cp: 97.45, cpL: 135.0, lfl: 1.8, ufl: 8.4, hv: 165 },
            isopentane: { name: 'Isopentane', formula: 'iC5', mw: 72.149, tc: 460.35, pc: 3381000, omega: 0.2275, cp: 120.2, cpL: 165.0, lfl: 1.4, ufl: 7.6, hv: 147 },
            npentane: { name: 'n-Pentane', formula: 'nC5', mw: 72.149, tc: 469.70, pc: 3370000, omega: 0.2515, cp: 120.1, cpL: 170.0, lfl: 1.4, ufl: 7.8, hv: 153 },
            nhexane: { name: 'n-Hexane', formula: 'C6', mw: 86.175, tc: 507.60, pc: 3025000, omega: 0.3013, cp: 142.6, cpL: 195.0, lfl: 1.2, ufl: 7.4, hv: 144 },
            nheptane: { name: 'n-Heptane', formula: 'C7', mw: 100.202, tc: 540.20, pc: 2740000, omega: 0.3495, cp: 165.2, cpL: 225.0, lfl: 1.05, ufl: 6.7, hv: 136 },
            noctane: { name: 'n-Octane', formula: 'C8', mw: 114.229, tc: 568.70, pc: 2490000, omega: 0.3996, cp: 187.8, cpL: 255.0, lfl: 1.0, ufl: 6.5, hv: 129 },
            nnonane: { name: 'n-Nonane', formula: 'C9', mw: 128.255, tc: 594.60, pc: 2290000, omega: 0.4435, cp: 210.2, cpL: 285.0, lfl: 0.8, ufl: 5.9, hv: 123 },
            ndecane: { name: 'n-Decane', formula: 'C10', mw: 142.282, tc: 617.70, pc: 2110000, omega: 0.4923, cp: 232.7, cpL: 315.0, lfl: 0.8, ufl: 5.4, hv: 118 },
            nitrogen: { name: 'Nitrogen', formula: 'N2', mw: 28.014, tc: 126.20, pc: 3398000, omega: 0.0377, cp: 29.12, cpL: 58.0, lfl: null, ufl: null, hv: 85 },
            oxygen: { name: 'Oxygen', formula: 'O2', mw: 31.999, tc: 154.58, pc: 5043000, omega: 0.0222, cp: 29.38, cpL: 54.0, lfl: null, ufl: null, hv: 91 },
            co2: { name: 'CO2', formula: 'CO2', mw: 44.010, tc: 304.21, pc: 7383000, omega: 0.2236, cp: 37.13, cpL: 85.0, lfl: null, ufl: null, hv: 234 },
            h2s: { name: 'H2S', formula: 'H2S', mw: 34.081, tc: 373.53, pc: 8963000, omega: 0.0942, cp: 34.23, cpL: 85.0, lfl: 4.0, ufl: 44.0, hv: 235 },
            water: { name: 'Water', formula: 'H2O', mw: 18.015, tc: 647.10, pc: 22064000, omega: 0.3449, cp: 33.59, cpL: 75.4, lfl: null, ufl: null, hv: 970 },
        };

        // Fluid Presets
        const PRESETS = {
            natural_gas: { name: 'Natural Gas', composition: { methane: 85, ethane: 7, propane: 3, nbutane: 2, co2: 2, nitrogen: 1 }},
            rich_gas: { name: 'Rich Gas', composition: { methane: 70, ethane: 12, propane: 8, isobutane: 3, nbutane: 3, isopentane: 1, npentane: 1, co2: 2 }},
            propane_pure: { name: 'Propane', composition: { propane: 100 }},
            butane_mix: { name: 'Butane Mix', composition: { isobutane: 50, nbutane: 50 }},
            ngl: { name: 'NGL', composition: { ethane: 40, propane: 30, isobutane: 10, nbutane: 10, npentane: 10 }},
            water_pure: { name: 'Water', composition: { water: 100 }},
        };

        // API 526 Orifices with inlet/outlet sizes (including alternate sizes)
        const ORIFICES = [
            { letter: 'D', area: 0.110, inlet: '1"', outlet: '2"', size: '1 D 2' },
            { letter: 'E', area: 0.196, inlet: '1"', outlet: '2"', size: '1 E 2' },
            { letter: 'F', area: 0.307, inlet: '1.5"', outlet: '2"', size: '1Â½ F 2' },
            { letter: 'G', area: 0.503, inlet: '1.5"', outlet: '3"', size: '1Â½ G 3' },
            { letter: 'G', area: 0.503, inlet: '2"', outlet: '3"', size: '2 G 3' },
            { letter: 'H', area: 0.785, inlet: '1.5"', outlet: '3"', size: '1Â½ H 3' },
            { letter: 'H', area: 0.785, inlet: '2"', outlet: '3"', size: '2 H 3' },
            { letter: 'J', area: 1.287, inlet: '2"', outlet: '3"', size: '2 J 3' },
            { letter: 'K', area: 1.838, inlet: '3"', outlet: '4"', size: '3 K 4' },
            { letter: 'L', area: 2.853, inlet: '3"', outlet: '4"', size: '3 L 4' },
            { letter: 'L', area: 2.853, inlet: '4"', outlet: '6"', size: '4 L 6' },
            { letter: 'M', area: 3.600, inlet: '4"', outlet: '6"', size: '4 M 6' },
            { letter: 'N', area: 4.340, inlet: '4"', outlet: '6"', size: '4 N 6' },
            { letter: 'P', area: 6.380, inlet: '4"', outlet: '6"', size: '4 P 6' },
            { letter: 'Q', area: 11.05, inlet: '6"', outlet: '8"', size: '6 Q 8' },
            { letter: 'R', area: 16.00, inlet: '6"', outlet: '8"', size: '6 R 8' },
            { letter: 'T', area: 26.00, inlet: '8"', outlet: '10"', size: '8 T 10' },
        ];

        // Scenarios - Updated per user request
        const SCENARIOS = [
            { id: 'fire_wetted', label: '1A', name: '1A - Fire-Wetted (Liquid Boil up)', icon: 'ðŸ”¥', desc: 'Pool fire on vessel with liquid inventory causing vaporization', compLabel: 'Fire-Wetted Liquid Composition', presets: ['ngl', 'propane_pure', 'water_pure'] },
            { id: 'fire_unwetted', label: '1B', name: '1B - Fire-Unwetted (Vapor)', icon: 'ðŸ’¨', desc: 'Fire exposure on vapor space only', compLabel: 'Fire Unwetted Vapor Composition', presets: ['natural_gas', 'rich_gas', 'water_pure'] },
            { id: 'blocked_vapor', label: '2A', name: '2A - Blocked Outlet - Vapor', icon: 'â›”', desc: 'Blocked vapor outlet with upstream source', compLabel: 'Blocked Outlet Vapor Composition', presets: ['natural_gas', 'rich_gas', 'water_pure'] },
            { id: 'cv_failure', label: '3', name: '3 - CV Failure - Vapor', icon: 'âš ï¸', desc: 'Control valve fails open, vapor service', compLabel: 'CV Failure Vapor Composition', presets: ['natural_gas', 'rich_gas', 'water_pure'] },
            { id: 'hydraulic_thermal', label: '4', name: '4 - Hydraulic Thermal Expansion', icon: 'ðŸŒ¡ï¸', desc: 'Liquid-full system thermal expansion per API 521 4.4.12', noCalc: true },
        ];

        // Bypass valve Cv lookup tables
        const BYPASS_CV_GLOBE = [
            { size: '1/2"', cv: 2.94 },
            { size: '3/4"', cv: 5.65 },
            { size: '1"', cv: 9.79 },
            { size: '1.5"', cv: 25.18 },
            { size: '2"', cv: 44.23 },
            { size: '3"', cv: 113.76 },
            { size: '4"', cv: 201.58 },
        ];

        const BYPASS_CV_BALL = [
            { size: '1/2"', cv: 20 },
            { size: '3/4"', cv: 49 },
            { size: '1"', cv: 94 },
            { size: '1.5"', cv: 239 },
            { size: '2"', cv: 449 },
            { size: '3"', cv: 1222 },
            { size: '4"', cv: 2374 },
        ];

        // Simplified Peng-Robinson calculations (client-side)
        function calculateProperties(composition, T_F, P_psig) {
            const T_K = (T_F + 459.67) * 5/9;
            const P_Pa = (P_psig + 14.7) * 6894.76;
            const R = 8.314462;

            let mw = 0, totalMol = 0;
            const compData = [];

            Object.entries(composition).forEach(([comp, molPct]) => {
                if (molPct > 0 && COMPONENTS[comp]) {
                    const c = COMPONENTS[comp];
                    const z = molPct / 100;
                    totalMol += z;
                    compData.push({ ...c, z });
                }
            });

            compData.forEach(c => {
                c.z = c.z / totalMol;
                mw += c.z * c.mw;
            });

            let a_mix = 0, b_mix = 0;
            compData.forEach(c => {
                const Tr = T_K / c.tc;
                const kappa = 0.37464 + 1.54226 * c.omega - 0.26992 * c.omega * c.omega;
                const alpha = Math.pow(1 + kappa * (1 - Math.sqrt(Tr)), 2);
                const a_i = 0.45724 * R * R * c.tc * c.tc / c.pc * alpha;
                const b_i = 0.07780 * R * c.tc / c.pc;
                a_mix += c.z * Math.sqrt(a_i);
                b_mix += c.z * b_i;
            });
            a_mix = a_mix * a_mix;

            const A = a_mix * P_Pa / (R * R * T_K * T_K);
            const B = b_mix * P_Pa / (R * T_K);

            let Z = 1.0;
            for (let i = 0; i < 20; i++) {
                const Z_new = 1 + B - A * B / (Z * (Z + B));
                if (Math.abs(Z_new - Z) < 0.0001) break;
                Z = 0.5 * (Z + Z_new);
            }
            Z = Math.max(0.1, Math.min(Z, 1.5));

            const gamma = 1.1 + 0.05 * (50 / mw);
            const density = P_Pa * (mw / 1000) / (Z * R * T_K);

            let lfl_inv = 0, ufl_inv = 0, flammable_total = 0;
            compData.forEach(c => {
                if (c.lfl && c.lfl > 0) {
                    lfl_inv += c.z / c.lfl;
                    ufl_inv += c.z / c.ufl;
                    flammable_total += c.z;
                }
            });

            const lfl = flammable_total > 0 && lfl_inv > 0 ? flammable_total / lfl_inv : null;
            const ufl = flammable_total > 0 && ufl_inv > 0 ? flammable_total / ufl_inv : null;

            return { mw, Z, gamma, density, lfl, ufl };
        }

        function fireHeatInput(wetted_area_ft2, insulated = false) {
            const F = insulated ? 0.3 : 1.0;
            if (wetted_area_ft2 <= 2800) {
                return 21000 * F * Math.pow(wetted_area_ft2, 0.82);
            }
            return 34500 * F * Math.pow(wetted_area_ft2, 0.82);
        }

        function wettedAreaHorizontal(diameter_ft, length_ft, liquid_fraction) {
            const R = diameter_ft / 2;
            const h = liquid_fraction * diameter_ft;
            const theta = 2 * Math.acos((R - h) / R);
            const arc = R * theta;
            const shell = arc * length_ft;
            const segment = (R * R / 2) * (theta - Math.sin(theta));
            const heads = 2 * segment;
            return shell + heads;
        }

        function sizePSV(scenario, props, conditions, vessel) {
            const { mw, Z, gamma } = props;
            const { set_pressure, back_pressure, temperature, latent_heat, flow_rate } = conditions;

            const accumulation = (scenario === 'fire_wetted' || scenario === 'fire_unwetted') ? 0.21 : 0.10;
            const P1_psia = set_pressure * (1 + accumulation) + 14.7;
            const P2_psia = back_pressure + 14.7;
            const T_R = temperature + 459.67;

            let W_lb_hr, Q_fire, wetted_area;

            if (scenario === 'fire_wetted' && vessel) {
                wetted_area = wettedAreaHorizontal(vessel.diameter, vessel.length, vessel.liquid_level);
                Q_fire = fireHeatInput(wetted_area, vessel.insulated);
                W_lb_hr = Q_fire / latent_heat;
            } else if (scenario === 'fire_unwetted' && vessel) {
                wetted_area = wettedAreaHorizontal(vessel.diameter, vessel.length, 0.1);
                Q_fire = fireHeatInput(wetted_area * 0.5, false) * 0.3;
                W_lb_hr = Q_fire / (0.5 * 100);
            } else {
                W_lb_hr = flow_rate || 10000;
                Q_fire = null;
                wetted_area = null;
            }

            const C = 520 * Math.sqrt(gamma * Math.pow(2 / (gamma + 1), (gamma + 1) / (gamma - 1)));
            const P_crit = Math.pow(2 / (gamma + 1), gamma / (gamma - 1));
            const P_ratio = P2_psia / P1_psia;
            const isCritical = P_ratio <= P_crit;

            let A_required;
            if (isCritical) {
                A_required = (W_lb_hr / (C * 0.975 * P1_psia)) * Math.sqrt(T_R * Z / mw);
            } else {
                const r = P_ratio;
                const F2 = Math.sqrt((gamma / (gamma - 1)) * Math.pow(r, 2/gamma) *
                    ((1 - Math.pow(r, (gamma-1)/gamma)) / (1 - r)));
                A_required = (W_lb_hr / (735 * F2 * 0.975)) * Math.sqrt(T_R * Z / (mw * P1_psia * P2_psia));
            }

            // Select orifice (use unique letters for calculation)
            const uniqueOrifices = ORIFICES.filter((o, i, arr) =>
                arr.findIndex(x => x.letter === o.letter) === i
            );
            let selectedOrifice = uniqueOrifices[uniqueOrifices.length - 1];
            for (const o of uniqueOrifices) {
                if (o.area >= A_required) {
                    selectedOrifice = o;
                    break;
                }
            }

            const utilization = (A_required / selectedOrifice.area) * 100;

            return {
                relief_rate: W_lb_hr,
                relieving_pressure: P1_psia,
                back_pressure: P2_psia,
                flow_type: isCritical ? 'Critical' : 'Subcritical',
                required_area: A_required,
                selected_orifice: selectedOrifice.letter,
                orifice_area: selectedOrifice.area,
                orifice_size: selectedOrifice.size,
                orifice_inlet: selectedOrifice.inlet,
                orifice_outlet: selectedOrifice.outlet,
                utilization,
                heat_input: Q_fire,
                wetted_area,
            };
        }

        // Device Info Header Component (shows on steps 2-5)
        function DeviceInfoHeader({ deviceInfo }) {
            if (!deviceInfo.tag && !deviceInfo.pid_number && !deviceInfo.facility_name) return null;
            return (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div className="flex flex-wrap gap-4 text-sm">
                        {deviceInfo.tag && (
                            <div><span className="text-blue-600 font-medium">Tag:</span> <span className="font-semibold">{deviceInfo.tag}</span></div>
                        )}
                        {deviceInfo.pid_number && (
                            <div><span className="text-blue-600 font-medium">P&ID:</span> <span className="font-semibold">{deviceInfo.pid_number}</span></div>
                        )}
                        {deviceInfo.facility_name && (
                            <div><span className="text-blue-600 font-medium">Facility:</span> <span className="font-semibold">{deviceInfo.facility_name}</span></div>
                        )}
                    </div>
                </div>
            );
        }

        // File Upload Component
        function FileUpload({ label, accept, file, onFileChange }) {
            const handleChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    onFileChange(selectedFile);
                }
            };

            return (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                    <label className={`file-upload block p-4 rounded-lg cursor-pointer text-center ${file ? 'has-file' : ''}`}>
                        <input
                            type="file"
                            accept={accept}
                            onChange={handleChange}
                            className="hidden"
                        />
                        {file ? (
                            <div className="text-green-700">
                                <span className="font-medium">{file.name}</span>
                                <p className="text-xs mt-1">Click to replace</p>
                            </div>
                        ) : (
                            <div className="text-gray-500">
                                <svg className="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <span className="text-sm">Click to upload</span>
                            </div>
                        )}
                    </label>
                </div>
            );
        }

        // Main App Component
        function PSVCalculator() {
            const [step, setStep] = useState(0);
            const [darkMode, setDarkMode] = useState(false);

            // Step 1: Device Info
            const [deviceInfo, setDeviceInfo] = useState({
                tag: '',
                pid_number: '',
                facility_name: '',
                protected_system: '',
                mawp: '',
                selected_orifice: '',
                new_or_existing: 'new',
                discharge_location: 'atmosphere',
                set_pressure: '',
                psv_type: 'conventional',
                // Additional fields for professional report
                client: '',
                plant: '',
                project: '',
                project_no: '',
                manufacturer: '',
                model_number: '',
                serial_number: '',
                inlet_pipe_size: '',
                inlet_pipe_schedule: 'XS',
                inlet_connection_rating: 'CL 150',
                outlet_pipe_size: '',
                outlet_pipe_schedule: 'XS',
                outlet_connection_rating: 'CL 150',
            });

            // Report metadata
            const [reportInfo, setReportInfo] = useState({
                engineered_by: '',
                checked_by: '',
                revision: 'A',
                revision_date: new Date().toLocaleDateString(),
                revision_history: [
                    { rev: 'A', date: new Date().toLocaleDateString(), description: 'Issued for Review' }
                ]
            });

            // Step 2: Scenario selections with applicable flags and notes
            const [scenarioSelections, setScenarioSelections] = useState({
                fire_wetted: { applicable: false, notes: '' },
                fire_unwetted: { applicable: false, notes: '' },
                blocked_vapor: { applicable: false, notes: '' },
                cv_failure: { applicable: false, notes: '' },
                hydraulic_thermal: { applicable: false, notes: '' },
            });

            // File uploads
            const [pidFile, setPidFile] = useState(null);
            const [miscFile, setMiscFile] = useState(null);

            const [preset, setPreset] = useState('');
            // Compositions keyed by scenario ID
            const [compositions, setCompositions] = useState({
                fire_wetted: {},
                fire_unwetted: {},
                blocked_vapor: {},
                cv_failure: {},
            });

            // Vessel details (shared between fire scenarios)
            const [vesselDetails, setVesselDetails] = useState({
                equipment_tag: '',
                orientation: 'horizontal',
                head_type: '2:1_elliptical',
                inner_diameter: 48, // inches
                seam_to_seam: 10, // ft
                height_above_grade: 2, // ft
                max_liquid_level: 50, // %
                additional_area: 0, // % adjustment (can be negative to exclude)
            });

            // Scenario-specific conditions
            const [scenarioConditions, setScenarioConditions] = useState({
                fire_wetted: {
                    normal_op_pressure: 80,
                    normal_op_temp: 125,
                    latent_heat: 150, // Btu/lb (for single component, or calculated for multi)
                    liquid_level: 50, // % liquid level for wetted area
                    prompt_firefighting: false, // Affects C1 vs C2
                    latent_heat_safety_factor: true, // Apply 10% derating to multi-comp latent heat
                    is_insulated: false,
                    insulation_thickness: 0, // inches
                    thermal_conductivity: 4, // Btu-in/hr-ftÂ²-Â°F
                    stream_a_mass_flow: 1000, // lb/hr inlet
                    show_math: false, // Toggle to show multi-component latent heat analysis
                },
                fire_unwetted: {
                    normal_op_pressure: 80,
                    normal_op_temp: 125,
                },
                blocked_vapor: {
                    normal_op_pressure: 80,
                    normal_op_temp: 125,
                    flow_rate: 10000,
                    flow_rate_unit: 'lb_hr', // 'lb_hr' or 'mmscfd'
                },
                cv_failure: {
                    valve_tag: '',
                    cv: 5, // Full-Open Valve Flow Coefficient
                    xt: 0.9, // Pressure Drop Ratio Factor
                    upstream_pressure: 800, // psig (P1)
                    upstream_temp: 138, // Â°F (T1)
                    // Bypass valve options
                    has_bypass: false,
                    bypass_valve_type: 'globe', // 'globe' or 'ball'
                    bypass_size: '1"',
                    use_bypass_flow: false, // If true, use bypass flow instead of CV flow
                },
            });

            // Constants
            const AMBIENT_PRESSURE = 14.69; // psia
            const MAX_WALL_TEMP = 1100; // Â°F
            const FIRE_OVERPRESSURE = 0.21; // 21%

            // Calculate molecular weight from composition
            const getMolecularWeight = (composition) => {
                let mw = 0, totalMol = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp]) {
                        totalMol += molPct;
                        mw += molPct * COMPONENTS[comp].mw;
                    }
                });
                return totalMol > 0 ? mw / totalMol : 0;
            };

            // Calculate pseudo-critical pressure using Kay's mixing rule
            const getCriticalPressure = (composition) => {
                let pc_mix = 0, totalMol = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp]) {
                        totalMol += molPct;
                        pc_mix += (molPct / 100) * (COMPONENTS[comp].pc / 6894.76); // Convert Pa to psia
                    }
                });
                return totalMol > 0 ? pc_mix * 100 / totalMol : 0;
            };

            // Calculate specific heat ratio k (Cp/Cv) from composition
            // k = Cp_molar / (Cp_molar - R) where R = 8.314 J/(molÂ·K)
            const getSpecificHeatRatio = (composition) => {
                const R = 8.314; // J/(molÂ·K)
                let cp_mix = 0, totalMol = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp] && COMPONENTS[comp].cp) {
                        totalMol += molPct;
                        cp_mix += (molPct / 100) * COMPONENTS[comp].cp;
                    }
                });
                if (totalMol <= 0) return 1.3; // Default fallback
                const cp_molar = cp_mix * 100 / totalMol;
                const cv_molar = cp_molar - R;
                if (cv_molar <= 0) return 1.3;
                return cp_molar / cv_molar;
            };

            // Calculate API 520 C coefficient from k
            // C = 520 * sqrt(k * (2/(k+1))^((k+1)/(k-1)))
            const getAPI520_C = (k) => {
                if (k <= 1) return 315; // Minimum bound
                const term = Math.pow(2 / (k + 1), (k + 1) / (k - 1));
                return 520 * Math.sqrt(k * term);
            };

            // Calculate latent heat of vaporization from composition (Btu/lb)
            // For single component: use hv from component data
            // For multi-component: mass-weighted average
            const getLatentHeat = (composition) => {
                let hv_mix = 0, totalMass = 0;
                Object.entries(composition).forEach(([comp, molPct]) => {
                    if (molPct > 0 && COMPONENTS[comp] && COMPONENTS[comp].hv) {
                        const massFrac = molPct * COMPONENTS[comp].mw;
                        totalMass += massFrac;
                        hv_mix += massFrac * COMPONENTS[comp].hv;
                    }
                });
                return totalMass > 0 ? hv_mix / totalMass : 150; // Default 150 Btu/lb if no data
            };

            // ============ PENG-ROBINSON EOS CALCULATIONS ============

            // Wilson K-value correlation: Ki = (Pci/P) * exp[5.37(1+Ï‰i)(1-Tci/T)]
            // Wilson K-value correlation (used as initial estimate and for low pressure)
            const calcWilsonK = (Tc_K, Pc_Pa, omega, T_K, P_Pa) => {
                const Tr = T_K / Tc_K;
                return (Pc_Pa / P_Pa) * Math.exp(5.37 * (1 + omega) * (1 - 1/Tr));
            };

            // K-value calculation - uses Wilson with PR correction applied inline
            // (defined inline to avoid forward reference issues)
            const calcKvalue = (comp, T_K, P_Pa) => {
                // Start with Wilson K-value
                const Tr = T_K / comp.tc;
                const Pr = P_Pa / comp.pc;
                const K_wilson = (1/Pr) * Math.exp(5.37 * (1 + comp.omega) * (1 - 1/Tr));

                // PR correction factor based on reduced conditions
                // At low pressures, Wilson is accurate; at high pressures, apply correction
                const correction = 1 + 0.1 * (Pr - 0.1) * (1 - Tr);

                return Math.max(1e-10, K_wilson * Math.max(0.5, Math.min(2.0, correction)));
            };

            // Calculate bubble point temperature at given pressure using PR-EOS K-values
            // Bubble point: Î£(Ki * zi) = 1
            const calcBubblePoint = (composition, P_psia) => {
                const P_Pa = P_psia * 6894.76;
                const compArray = Object.entries(composition).filter(([_, mol]) => mol > 0);
                if (compArray.length === 0) return 300; // Default 300Â°F

                // Normalize mole fractions
                let totalMol = 0;
                compArray.forEach(([_, mol]) => totalMol += mol);

                // Newton-Raphson iteration to find T where Î£(Ki*zi) = 1
                let T_K = 280; // Initial guess in Kelvin (start lower for NGL)
                for (let iter = 0; iter < 100; iter++) {
                    let sumKz = 0;
                    let dSumKz_dT = 0;

                    compArray.forEach(([compId, molPct]) => {
                        const comp = COMPONENTS[compId];
                        if (comp) {
                            const zi = molPct / totalMol;
                            const Ki = calcKvalue(comp, T_K, P_Pa);
                            sumKz += Ki * zi;

                            // Numerical derivative of Ki with respect to T
                            const dT = 0.1;
                            const Ki_plus = calcKvalue(comp, T_K + dT, P_Pa);
                            const dKi_dT = (Ki_plus - Ki) / dT;
                            dSumKz_dT += dKi_dT * zi;
                        }
                    });

                    const f = sumKz - 1;
                    if (Math.abs(f) < 1e-6) break;

                    // Newton step with damping
                    let step = f / (dSumKz_dT || 1e-6);
                    step = Math.max(-20, Math.min(20, step)); // Limit step size
                    T_K = T_K - 0.7 * step; // Damping factor
                    T_K = Math.max(100, Math.min(600, T_K)); // Bounds
                }

                return (T_K - 273.15) * 9/5 + 32; // Convert K to Â°F
            };

            // Calculate dew point temperature for vapor at given pressure using PR-EOS K-values
            // Dew point: Î£(zi/Ki) = 1
            const calcDewPoint = (composition, P_psia) => {
                const P_Pa = P_psia * 6894.76;
                const compArray = Object.entries(composition).filter(([_, mol]) => mol > 0);
                if (compArray.length === 0) return 400; // Default

                // Normalize mole fractions
                let totalMol = 0;
                compArray.forEach(([_, mol]) => totalMol += mol);

                let T_K = 350; // Initial guess
                for (let iter = 0; iter < 100; iter++) {
                    let sumZoverK = 0;
                    let dSum_dT = 0;

                    compArray.forEach(([compId, molPct]) => {
                        const comp = COMPONENTS[compId];
                        if (comp) {
                            const zi = molPct / totalMol;
                            const Ki = calcKvalue(comp, T_K, P_Pa);
                            sumZoverK += zi / Ki;

                            // Numerical derivative
                            const dT = 0.1;
                            const Ki_plus = calcKvalue(comp, T_K + dT, P_Pa);
                            const dKi_dT = (Ki_plus - Ki) / dT;
                            dSum_dT += -zi * dKi_dT / (Ki * Ki);
                        }
                    });

                    const f = sumZoverK - 1;
                    if (Math.abs(f) < 1e-6) break;

                    let step = f / (dSum_dT || 1e-6);
                    step = Math.max(-20, Math.min(20, step));
                    T_K = T_K - 0.7 * step;
                    T_K = Math.max(100, Math.min(700, T_K));
                }

                return (T_K - 273.15) * 9/5 + 32; // Convert K to Â°F
            };

            // Flash calculation at given T, P to find vapor fraction using PR-EOS K-values
            // Rachford-Rice: Î£ zi(Ki-1)/(1+V(Ki-1)) = 0
            const calcFlash = (composition, T_F, P_psia) => {
                const T_K = (T_F + 459.67) * 5/9;
                const P_Pa = P_psia * 6894.76;
                const compArray = Object.entries(composition).filter(([_, mol]) => mol > 0);

                // Normalize mole fractions
                let totalMol = 0;
                compArray.forEach(([_, mol]) => totalMol += mol);

                // Calculate K values using PR-EOS
                const Kvalues = {};
                compArray.forEach(([compId, molPct]) => {
                    const comp = COMPONENTS[compId];
                    if (comp) {
                        Kvalues[compId] = calcKvalue(comp, T_K, P_Pa);
                    }
                });

                // Solve Rachford-Rice for V (vapor fraction)
                let V = 0.5;
                for (let iter = 0; iter < 100; iter++) {
                    let f = 0, df = 0;
                    compArray.forEach(([compId, molPct]) => {
                        const zi = molPct / totalMol;
                        const Ki = Kvalues[compId] || 1;
                        const term = Ki - 1;
                        const denom = 1 + V * term;
                        f += zi * term / denom;
                        df -= zi * term * term / (denom * denom);
                    });

                    if (Math.abs(f) < 1e-8) break;
                    V = V - f / df;
                    V = Math.max(0, Math.min(1, V));
                }

                // Calculate liquid and vapor compositions
                const x = {}, y = {};
                let mw_L = 0, mw_V = 0;
                compArray.forEach(([compId, molPct]) => {
                    const comp = COMPONENTS[compId];
                    const zi = molPct / totalMol;
                    const Ki = Kvalues[compId] || 1;
                    x[compId] = zi / (1 + V * (Ki - 1));
                    y[compId] = Ki * x[compId];
                    if (comp) {
                        mw_L += x[compId] * comp.mw;
                        mw_V += y[compId] * comp.mw;
                    }
                });

                return { V, x, y, Kvalues, mw_L, mw_V };
            };

            // Calculate molar heat capacity of mixture (Btu/lbmolÂ·Â°F)
            // Uses liquid Cp (cpL) for liquid, vapor Cp (cp) for vapor
            const calcMolarCp = (composition, isLiquid = true) => {
                let cp_mix = 0, totalMol = 0;
                Object.entries(composition).forEach(([compId, molPct]) => {
                    const comp = COMPONENTS[compId];
                    if (molPct > 0 && comp) {
                        totalMol += molPct;
                        // Use liquid Cp for liquid phase, vapor Cp for vapor phase
                        const cpValue = isLiquid ? (comp.cpL || comp.cp) : comp.cp;
                        cp_mix += (molPct / 100) * cpValue;
                    }
                });
                // Convert J/(molÂ·K) to Btu/(lbmolÂ·Â°F):
                // Factor = 0.000947817 / 1.8 * 453.592 = 0.2388
                return totalMol > 0 ? (cp_mix * 100 / totalMol) * 0.2388 : 25;
            };

            // ============================================================
            // PENG-ROBINSON EQUATION OF STATE (PR-EOS)
            // ============================================================
            const R_GAS = 8.314462; // J/(molÂ·K)

            // Calculate PR-EOS parameters for a single component
            const calcPREOSParams = (comp, T_K) => {
                const Tr = T_K / comp.tc;
                // Soave alpha function with kappa
                const kappa = comp.omega <= 0.491
                    ? 0.37464 + 1.54226 * comp.omega - 0.26992 * comp.omega * comp.omega
                    : 0.379642 + 1.48503 * comp.omega - 0.164423 * comp.omega * comp.omega + 0.016666 * Math.pow(comp.omega, 3);
                const alpha = Math.pow(1 + kappa * (1 - Math.sqrt(Tr)), 2);
                const a = 0.45724 * R_GAS * R_GAS * comp.tc * comp.tc / comp.pc * alpha;
                const b = 0.07780 * R_GAS * comp.tc / comp.pc;
                return { a, b, alpha, kappa, Tr };
            };

            // Cubic equation solver for PR-EOS: ZÂ³ + p*ZÂ² + q*Z + r = 0
            // Returns all real roots
            const solveCubic = (p, q, r) => {
                // Cardano's method for depressed cubic
                const a = (3*q - p*p) / 3;
                const b = (2*p*p*p - 9*p*q + 27*r) / 27;
                const discriminant = b*b/4 + a*a*a/27;

                const roots = [];
                if (discriminant > 0) {
                    // One real root
                    const sqrtD = Math.sqrt(discriminant);
                    const u = Math.cbrt(-b/2 + sqrtD);
                    const v = Math.cbrt(-b/2 - sqrtD);
                    roots.push(u + v - p/3);
                } else if (Math.abs(discriminant) < 1e-10) {
                    // Three real roots (at least two equal)
                    const u = Math.cbrt(-b/2);
                    roots.push(2*u - p/3);
                    roots.push(-u - p/3);
                } else {
                    // Three distinct real roots
                    const rho = Math.sqrt(-a*a*a/27);
                    const theta = Math.acos(-b/(2*rho));
                    const m = 2 * Math.cbrt(rho);
                    roots.push(m * Math.cos(theta/3) - p/3);
                    roots.push(m * Math.cos((theta + 2*Math.PI)/3) - p/3);
                    roots.push(m * Math.cos((theta + 4*Math.PI)/3) - p/3);
                }
                return roots.filter(z => z > 0).sort((a, b) => a - b);
            };

            // Calculate compressibility factor Z for mixture using PR-EOS
            const calcPRCompressibility = (composition, T_K, P_Pa, phase = 'vapor') => {
                const compArray = Object.entries(composition).filter(([_, mol]) => mol > 0);
                if (compArray.length === 0) return 1.0;

                // Normalize mole fractions
                let totalMol = 0;
                compArray.forEach(([_, mol]) => totalMol += mol);
                const zFracs = compArray.map(([_, mol]) => mol / totalMol);

                // Calculate pure component parameters
                const params = compArray.map(([compId]) => {
                    const comp = COMPONENTS[compId];
                    return comp ? calcPREOSParams(comp, T_K) : null;
                }).filter(p => p !== null);

                // Simple mixing rules (no BIPs for simplicity)
                let a_mix = 0, b_mix = 0;
                for (let i = 0; i < params.length; i++) {
                    b_mix += zFracs[i] * params[i].b;
                    for (let j = 0; j < params.length; j++) {
                        // Geometric mean for a_ij (k_ij = 0)
                        a_mix += zFracs[i] * zFracs[j] * Math.sqrt(params[i].a * params[j].a);
                    }
                }

                // Dimensionless parameters
                const A = a_mix * P_Pa / (R_GAS * R_GAS * T_K * T_K);
                const B = b_mix * P_Pa / (R_GAS * T_K);

                // Solve cubic: ZÂ³ - (1-B)ZÂ² + (A - 3BÂ² - 2B)Z - (AB - BÂ² - BÂ³) = 0
                const p = -(1 - B);
                const q = A - 3*B*B - 2*B;
                const r = -(A*B - B*B - B*B*B);

                const roots = solveCubic(p, q, r);
                if (roots.length === 0) return 1.0;

                // Vapor: largest root, Liquid: smallest root
                return phase === 'vapor' ? roots[roots.length - 1] : roots[0];
            };

            // Calculate PR-EOS K-values (vapor-liquid equilibrium)
            const calcPRKvalue = (comp, T_K, P_Pa, Z_L, Z_V, a_mix, b_mix, A_mix, B_mix) => {
                const params = calcPREOSParams(comp, T_K);

                // Fugacity coefficient calculation
                const calcPhi = (Z, phase) => {
                    const bi_over_b = params.b / b_mix;

                    // Sum of a_ij contributions (simplified: no BIPs)
                    const sqrt_ai = Math.sqrt(params.a);
                    const sqrt_amix = Math.sqrt(a_mix);
                    const sum_aj = 2 * sqrt_ai * sqrt_amix; // Simplified

                    const term1 = bi_over_b * (Z - 1);
                    const term2 = -Math.log(Z - B_mix);
                    const sqrt2 = Math.sqrt(2);
                    const logArg = (Z + (1 + sqrt2) * B_mix) / (Z + (1 - sqrt2) * B_mix);
                    const term3 = -A_mix / (2 * sqrt2 * B_mix) * (sum_aj / a_mix - bi_over_b) * Math.log(Math.abs(logArg));

                    return Math.exp(term1 + term2 + term3);
                };

                const phi_L = calcPhi(Z_L, 'liquid');
                const phi_V = calcPhi(Z_V, 'vapor');

                return phi_L / phi_V;
            };

            // Simplified PR K-value using Wilson as initial + PR correction
            const calcPRKvalueSimplified = (comp, T_K, P_Pa) => {
                // Start with Wilson K-value
                const Tr = T_K / comp.tc;
                const Pr = P_Pa / comp.pc;
                const K_wilson = (1/Pr) * Math.exp(5.37 * (1 + comp.omega) * (1 - 1/Tr));

                // PR correction factor based on reduced conditions
                // At low pressures, Wilson is accurate; at high pressures, apply correction
                const correction = 1 + 0.1 * (Pr - 0.1) * (1 - Tr);

                return Math.max(1e-10, K_wilson * Math.max(0.5, Math.min(2.0, correction)));
            };

            // Calculate enthalpy departure using PR-EOS (H - H_ig)
            // Returns enthalpy departure in J/mol
            const calcEnthalpyDeparture = (composition, T_K, P_Pa, phase = 'vapor') => {
                const compArray = Object.entries(composition).filter(([_, mol]) => mol > 0);
                if (compArray.length === 0) return 0;

                // Normalize
                let totalMol = 0;
                compArray.forEach(([_, mol]) => totalMol += mol);
                const zFracs = compArray.map(([_, mol]) => mol / totalMol);

                // Get params and calculate mixture values
                const params = compArray.map(([compId]) => {
                    const comp = COMPONENTS[compId];
                    return comp ? { ...calcPREOSParams(comp, T_K), comp } : null;
                }).filter(p => p !== null);

                // Mixing rules
                let a_mix = 0, b_mix = 0, da_dT_mix = 0;
                for (let i = 0; i < params.length; i++) {
                    b_mix += zFracs[i] * params[i].b;

                    // Calculate da/dT for component i
                    const Ti = params[i].comp.tc;
                    const sqrtAlpha_i = Math.sqrt(params[i].alpha);
                    const kappa_i = params[i].kappa;
                    const a0_i = 0.45724 * R_GAS * R_GAS * Ti * Ti / params[i].comp.pc;
                    const da_dT_i = -a0_i * kappa_i * sqrtAlpha_i / (Math.sqrt(T_K * Ti));

                    for (let j = 0; j < params.length; j++) {
                        const Tj = params[j].comp.tc;
                        const sqrtAlpha_j = Math.sqrt(params[j].alpha);
                        const kappa_j = params[j].kappa;
                        const a0_j = 0.45724 * R_GAS * R_GAS * Tj * Tj / params[j].comp.pc;
                        const da_dT_j = -a0_j * kappa_j * sqrtAlpha_j / (Math.sqrt(T_K * Tj));

                        const sqrt_ai_aj = Math.sqrt(params[i].a * params[j].a);
                        a_mix += zFracs[i] * zFracs[j] * sqrt_ai_aj;

                        // d(sqrt(ai*aj))/dT
                        if (sqrt_ai_aj > 0) {
                            const d_sqrt_aiaj_dT = 0.5 / sqrt_ai_aj * (params[j].a * da_dT_i + params[i].a * da_dT_j);
                            da_dT_mix += zFracs[i] * zFracs[j] * d_sqrt_aiaj_dT;
                        }
                    }
                }

                const A = a_mix * P_Pa / (R_GAS * R_GAS * T_K * T_K);
                const B = b_mix * P_Pa / (R_GAS * T_K);

                // Get compressibility
                const Z = calcPRCompressibility(composition, T_K, P_Pa, phase);

                // Enthalpy departure formula
                const sqrt2 = Math.sqrt(2);
                const logArg = (Z + (1 + sqrt2) * B) / (Z + (1 - sqrt2) * B);

                // (H - H_ig)/RT = Z - 1 + (A/(2*sqrt(2)*B)) * (1 - T*da_dT/a) * ln[(...)]
                const term1 = Z - 1;
                const term2 = (A / (2 * sqrt2 * B)) * (1 - T_K * da_dT_mix / a_mix) * Math.log(Math.abs(logArg));

                const H_dep_over_RT = term1 + term2;
                return H_dep_over_RT * R_GAS * T_K; // J/mol
            };

            // Calculate latent heat of vaporization using PR-EOS
            // Î”H_vap = H_dep(vapor) - H_dep(liquid)
            const calcLatentHeatPREOS = (composition, T_K, P_Pa) => {
                const H_dep_V = calcEnthalpyDeparture(composition, T_K, P_Pa, 'vapor');
                const H_dep_L = calcEnthalpyDeparture(composition, T_K, P_Pa, 'liquid');

                // Latent heat = H_V - H_L = (H_ig + H_dep_V) - (H_ig + H_dep_L) = H_dep_V - H_dep_L
                const latentHeat_Jmol = H_dep_V - H_dep_L;

                // Convert J/mol to Btu/lb using mixture MW
                const M = getMolecularWeight(composition);
                const latentHeat_Btulb = latentHeat_Jmol / M * 0.000947817 * 453.592; // J/mol -> Btu/lb

                return Math.abs(latentHeat_Btulb);
            };

            // Calculate multi-component latent heat using Stream A/B method with PR-EOS
            const calcMultiCompLatentHeat = (composition, P_psia, T_bubble_F) => {
                const M = getMolecularWeight(composition);
                const P_Pa = P_psia * 6894.76;
                const massFlowBasis = 1000; // lb/hr basis
                const molarFlowBasis = M > 0 ? massFlowBasis / M : 0;

                // Stream A: Liquid at bubble point (V = 0)
                const T_A = T_bubble_F;
                const T_A_K = (T_A + 459.67) * 5/9;
                const Cp_A = calcMolarCp(composition, true); // Liquid Cp

                // Stream B: 5% molar vapor
                const vaporFracB = 0.05;

                // Find temperature where we get 5% vapor (iterate)
                let T_B = T_A + 30; // Start above bubble point
                let flashB = null;
                for (let iter = 0; iter < 100; iter++) {
                    flashB = calcFlash(composition, T_B, P_psia);
                    const diff = flashB.V - vaporFracB;
                    if (Math.abs(diff) < 0.0005) break;
                    // Secant-like adjustment
                    const dT = diff > 0 ? -Math.abs(diff) * 50 : Math.abs(diff) * 50;
                    T_B = T_B + dT * 0.5;
                    T_B = Math.max(T_A + 0.1, Math.min(T_A + 300, T_B));
                }

                // Recalculate flash at final T_B
                flashB = calcFlash(composition, T_B, P_psia);
                const T_B_K = (T_B + 459.67) * 5/9;

                // Moles vaporized (use vapor MW for mass calculation)
                const molesVaporized = molarFlowBasis * flashB.V;
                const mw_vapor = flashB.mw_V || M; // Use calculated vapor MW
                const massVaporized = molesVaporized * mw_vapor;

                // Calculate liquid and vapor Cp at Stream B conditions
                // Weight by phase fractions
                const Cp_L = calcMolarCp(composition, true);   // Liquid Cp
                const Cp_V = calcMolarCp(composition, false);  // Vapor Cp
                const Cp_B = (1 - flashB.V) * Cp_L + flashB.V * Cp_V; // Weighted average

                // Sensible heat: Q_sens = n * Cp_avg * (T_B - T_A)
                const Cp_avg = (Cp_A + Cp_B) / 2;
                const Q_sensible = molarFlowBasis * Cp_avg * (T_B - T_A); // Btu/hr

                // Calculate PR-EOS latent heat at bubble point
                const T_avg_K = (T_A_K + T_B_K) / 2;
                let latentHeat_PR = 0;
                try {
                    // Get enthalpy departures
                    const H_dep_V = calcEnthalpyDeparture(composition, T_avg_K, P_Pa, 'vapor');
                    const H_dep_L = calcEnthalpyDeparture(composition, T_avg_K, P_Pa, 'liquid');

                    // Latent heat in J/mol, convert to Btu/lbmol
                    const deltaH_Jmol = H_dep_V - H_dep_L;
                    latentHeat_PR = Math.abs(deltaH_Jmol) * 0.000947817 * 453.592; // Btu/lbmol
                } catch (e) {
                    latentHeat_PR = 0; // Fallback if calculation fails
                }

                // Calculate latent heat of vaporization (Btu/lb)
                // Q_latent = n_vaporized * deltaH_vap
                const Q_latent = molesVaporized * latentHeat_PR; // Btu/hr

                // Total heat duty
                const Q_total = Q_sensible + Q_latent;

                // Effective latent heat (Btu/lb)
                const lambda_eff = massVaporized > 0 ? Q_total / massVaporized : 100;

                // Return stream properties for display
                return {
                    streamA: {
                        vaporFrac: 0,
                        pressure: P_psia,
                        temperature: T_A,
                        massFlow: massFlowBasis,
                        molarFlow: molarFlowBasis,
                        molarCp: Cp_A
                    },
                    streamB: {
                        vaporFrac: flashB.V,
                        pressure: P_psia,
                        temperature: T_B,
                        massVaporized: massVaporized,
                        molesVaporized: molesVaporized,
                        molarCp: Cp_B,
                        mw_vapor: mw_vapor
                    },
                    Q_sensible: Q_sensible,
                    Q_latent: Q_latent,
                    Q_total: Q_total,
                    lambda_eff: lambda_eff,
                    latentHeat_PR: latentHeat_PR,
                    M: M
                };
            };

            // API 521 Eqn (11): T1 = (p1/pn) * Tn
            const calcRelievingTemp = (p1_psia, pn_psig, Tn_F) => {
                const pn_psia = pn_psig + AMBIENT_PRESSURE;
                const Tn_R = Tn_F + 459.67;
                const T1_R = (p1_psia / pn_psia) * Tn_R;
                return T1_R - 459.67; // Convert back to Â°F
            };

            // API 521 Eqn (12): qm,relief = C12 * sqrt(M * p1) * [A'(Tw-T1)^1.25 / T1^1.1506]
            const C12 = 0.1406; // Constant for lb/hr, ftÂ², psia, Â°F
            const calcFireUnwettedReliefLoad = (M, p1_psia, A_prime, Tw_F, T1_F) => {
                if (T1_F <= 0 || Tw_F <= T1_F) return 0;
                const T1_R = T1_F + 459.67;
                const numerator = A_prime * Math.pow(Tw_F - T1_F, 1.25);
                const denominator = Math.pow(T1_R, 1.1506);
                return C12 * Math.sqrt(M * p1_psia) * (numerator / denominator);
            };

            // Convert relief load to volumetric rate (MMscfd)
            const calcVolumetricRate = (qm_lb_hr, M, T_F, P_psia) => {
                if (M <= 0 || P_psia <= 0) return 0;
                const T_R = T_F + 459.67;
                // PV = nRT, n = qm/M, convert to scf/day then MMscfd
                const scf_per_hr = (qm_lb_hr / M) * 10.73 * (520) / 14.696; // at standard conditions
                return (scf_per_hr * 24) / 1e6;
            };

            // Calculate vessel surface areas and volume
            const calcVesselAreas = (vessel) => {
                const D_ft = vessel.inner_diameter / 12; // Convert inches to feet
                const R_ft = D_ft / 2;
                const L_ft = vessel.seam_to_seam;
                const liquidFrac = vessel.max_liquid_level / 100;

                // Head surface area (each head) - CORRECT FORMULAS
                let headArea = 0;
                let headVolume = 0;
                if (vessel.head_type === '2:1_elliptical') {
                    // 2:1 elliptical head surface area = 1.084 Ã— DÂ²
                    headArea = 1.084 * D_ft * D_ft;
                    // 2:1 elliptical head volume = Ï€ Ã— DÂ³ / 24
                    headVolume = Math.PI * Math.pow(D_ft, 3) / 24;
                } else if (vessel.head_type === 'hemispherical') {
                    // Hemisphere surface area = 2Ï€RÂ² = Ï€ Ã— DÂ² / 2
                    headArea = Math.PI * D_ft * D_ft / 2;
                    // Hemisphere volume = Ï€ Ã— DÂ³ / 12
                    headVolume = Math.PI * Math.pow(D_ft, 3) / 12;
                } else if (vessel.head_type === 'flat') {
                    // Flat head area = Ï€ Ã— RÂ² = Ï€ Ã— DÂ² / 4
                    headArea = Math.PI * D_ft * D_ft / 4;
                    // Flat head has no additional volume
                    headVolume = 0;
                }
                // 'none' = 0 for both

                const totalHeadArea = 2 * headArea;
                const shellArea = Math.PI * D_ft * L_ft;
                const totalArea = shellArea + totalHeadArea;

                // Shell volume (cylinder)
                const shellVolume = Math.PI * R_ft * R_ft * L_ft;
                const totalVolume_ft3 = shellVolume + 2 * headVolume;
                const totalVolume_gal = totalVolume_ft3 * 7.48052; // Convert to US gallons

                // Calculate filled volume based on orientation
                let filledVolume_ft3 = 0;

                if (vessel.orientation === 'horizontal') {
                    // Horizontal cylinder partial fill: circular segment
                    const h = liquidFrac * D_ft; // liquid height
                    // Cross-sectional area of liquid = RÂ²Ã—acos((R-h)/R) - (R-h)Ã—âˆš(2Rh-hÂ²)
                    const arg = Math.max(-1, Math.min(1, (R_ft - h) / R_ft));
                    const segmentArea = R_ft * R_ft * Math.acos(arg) - (R_ft - h) * Math.sqrt(Math.max(0, 2 * R_ft * h - h * h));
                    const shellLiquidVol = segmentArea * L_ft;

                    // Head liquid volume (simplified - use fraction of total head volume)
                    // For hemispherical heads: use liquid fraction directly
                    // More accurate would require spherical cap integration
                    const headLiquidVol = liquidFrac * (2 * headVolume);

                    filledVolume_ft3 = shellLiquidVol + headLiquidVol;
                } else {
                    // Vertical vessel - simpler: volume Ã— liquid fraction
                    filledVolume_ft3 = totalVolume_ft3 * liquidFrac;
                }

                const filledVolume_gal = filledVolume_ft3 * 7.48052;

                // For horizontal vessel, calculate wetted/unwetted based on liquid level
                let wettedArea = 0;
                let unwettedArea = 0;

                if (vessel.orientation === 'horizontal') {
                    // Shell wetted area uses chord angle calculation
                    const h = liquidFrac * D_ft;
                    const theta = 2 * Math.acos(Math.max(-1, Math.min(1, (R_ft - h) / R_ft)));
                    const wettedShellFrac = theta / (2 * Math.PI);
                    const wettedShell = wettedShellFrac * shellArea;

                    // For hemispherical heads, use liquid level fraction directly
                    // For other heads, use shell chord fraction
                    let wettedHeads;
                    if (vessel.head_type === 'hemispherical') {
                        wettedHeads = liquidFrac * totalHeadArea;
                    } else {
                        wettedHeads = wettedShellFrac * totalHeadArea;
                    }

                    wettedArea = wettedShell + wettedHeads;
                    unwettedArea = totalArea - wettedArea;
                } else {
                    // Vertical vessel
                    const liquidHeight = liquidFrac * L_ft;
                    const wettedShell = Math.PI * D_ft * liquidHeight;

                    // For wetted area: include bottom head if any liquid, plus shell up to liquid level
                    // For unwetted area: use total - wetted to get shell above liquid + top head (+ bottom head if dry)
                    const bottomHeadWetted = liquidFrac > 0 ? headArea : 0;

                    // Check if liquid reaches top head (liquidFrac >= 1 means full)
                    const topHeadWetted = liquidFrac >= 1 ? headArea : 0;

                    wettedArea = wettedShell + bottomHeadWetted + topHeadWetted;
                    unwettedArea = totalArea - wettedArea;
                }

                // Apply additional area adjustment as PERCENTAGE
                const additionalPct = (vessel.additional_area || 0) / 100;
                const adjustedWetted = wettedArea * (1 + additionalPct);
                const adjustedUnwetted = unwettedArea * (1 + additionalPct);

                return {
                    total: totalArea,
                    shell: shellArea,
                    heads: totalHeadArea,
                    wetted: adjustedWetted,
                    filledVolume_gal,
                    unwetted: adjustedUnwetted,
                    adjustedUnwetted,
                    adjustedWetted,
                    volume_ft3: totalVolume_ft3,
                    volume_gal: totalVolume_gal,
                };
            };

            // Update vessel details
            const updateVesselDetail = (field, value) => {
                setVesselDetails(prev => ({
                    ...prev,
                    [field]: typeof value === 'string' ? value : (parseFloat(value) || 0)
                }));
            };

            const [conditions, setConditions] = useState({
                temperature: 100,
                tempUnit: 'F',
                pressure: 150,
                pressureUnit: 'psig',
                back_pressure: 0,
                latent_heat: 150,
                flow_rate: 10000,
            });
            const [vessel, setVessel] = useState({
                diameter: 6,
                length: 20,
                liquid_level: 0.5,
                insulated: false,
            });
            const [scenario, setScenario] = useState('fire_wetted');
            const [activeConditionsTab, setActiveConditionsTab] = useState(null);
            const [results, setResults] = useState(null);
            const [reportOptions, setReportOptions] = useState({
                includeInputs: true,
                includeResults: true,
                includeCalcs: true,
                includeAppendix: true
            });

            // Payment state
            const [paymentStatus, setPaymentStatus] = useState({
                hasPaid: false,
                sessionId: null,
                reportsGenerated: 0, // Track free reports used
                stripeConfigured: false,
            });
            const [isProcessingPayment, setIsProcessingPayment] = useState(false);
// ============================================
            // AUTO-SAVE & RESTORE STATE (1 hour expiry)
            // ============================================
            const STORAGE_KEY = 'psv_calculator_state';
            const EXPIRY_MS = 60 * 60 * 1000; // 1 hour

            // Save all form state to localStorage
            const saveStateToStorage = () => {
                const state = {
                    deviceInfo,
                    reportInfo,
                    scenarioSelections,
                    scenarioConditions,
                    vesselDetails,
                    compositions,
                    results,
                    step,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            };

            // Auto-save whenever any state changes
            useEffect(() => {
                // Don't save if we're on step 1 with no data entered
                if (step === 1 && !deviceInfo.tag && !deviceInfo.facility_name) return;
                saveStateToStorage();
            }, [deviceInfo, reportInfo, scenarioSelections, scenarioConditions, vesselDetails, compositions, results, step]);

            // Restore state on initial load
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // Check if data is less than 1 hour old
                        if (parsed.timestamp && (Date.now() - parsed.timestamp) < EXPIRY_MS) {
                            if (parsed.deviceInfo) setDeviceInfo(parsed.deviceInfo);
                            if (parsed.reportInfo) setReportInfo(parsed.reportInfo);
                            if (parsed.scenarioSelections) setScenarioSelections(parsed.scenarioSelections);
                            if (parsed.scenarioConditions) setScenarioConditions(parsed.scenarioConditions);
                            if (parsed.vesselDetails) setVesselDetails(parsed.vesselDetails);
                            if (parsed.compositions) setCompositions(parsed.compositions);
                            if (parsed.results) setResults(parsed.results);
                            if (parsed.step) setStep(parsed.step);
                            console.log('Restored saved state from', new Date(parsed.timestamp).toLocaleTimeString());
                        } else {
                            // Data expired, clear it
                            localStorage.removeItem(STORAGE_KEY);
                            console.log('Saved state expired, cleared');
                        }
                    }
                } catch (e) {
                    console.error('Error restoring state:', e);
                }
            }, []); // Only run once on mount

            // Clear saved state after successful payment/report generation
            const clearSavedState = () => {
                localStorage.removeItem(STORAGE_KEY);
                console.log('Cleared saved state');
            };
            // Check for payment success on page load
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const payment = urlParams.get('payment');
                const sessionId = urlParams.get('session_id');

                // Load reports count from localStorage
                const savedReportsCount = parseInt(localStorage.getItem('psv_reports_generated') || '0');
                setPaymentStatus(prev => ({ ...prev, reportsGenerated: savedReportsCount }));

                // Check if Stripe is configured
                if (API_BASE) {
                    fetch(`${API_BASE}/payment-status`)
                        .then(res => res.json())
                        .then(data => {
                            setPaymentStatus(prev => ({ ...prev, stripeConfigured: data.stripe_configured }));
                        })
                        .catch(() => {});
                }

                if (payment === 'success' && sessionId) {
                    // Verify payment with backend
                    verifyPayment(sessionId);
                    // Clean up URL
                    window.history.replaceState({}, '', window.location.pathname);
                } else if (payment === 'cancelled') {
                    alert('Payment was cancelled. You can try again when ready.');
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }, []);

            // Verify payment with backend
            const verifyPayment = async (sessionId) => {
                if (!API_BASE) return;
                try {
                    const response = await fetch(`${API_BASE}/verify-payment/${sessionId}`);
                    const data = await response.json();
                    if (data.valid) {
                        setPaymentStatus(prev => ({
                            ...prev,
                            hasPaid: true,
                            sessionId: sessionId,
                        }));
                        alert('Payment successful! You can now generate your report.');
                    }
                } catch (error) {
                    console.error('Error verifying payment:', error);
                }
            };

            // Initiate Stripe checkout
            const initiateCheckout = async (product = 'standard_report') => {
                if (!API_BASE) {
                    alert('Payment system not configured. API_BASE must be set.');
                    return;
                }

                setIsProcessingPayment(true);
                try {
                    const currentUrl = window.location.href.split('?')[0];
                    const response = await fetch(`${API_BASE}/create-checkout-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product: product,
                            success_url: `${currentUrl}?payment=success&session_id={CHECKOUT_SESSION_ID}`,
                            cancel_url: `${currentUrl}?payment=cancelled`,
                        }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to create checkout session');
                    }

                    const data = await response.json();
                    // Redirect to Stripe Checkout
                    window.location.href = data.checkout_url;
                } catch (error) {
                    console.error('Checkout error:', error);
                    alert(`Checkout error: ${error.message}`);
                    setIsProcessingPayment(false);
                }
            };

            // Track report generation
            const trackReportGeneration = () => {
                const newCount = paymentStatus.reportsGenerated + 1;
                localStorage.setItem('psv_reports_generated', newCount.toString());
                setPaymentStatus(prev => ({ ...prev, reportsGenerated: newCount }));
            };

            // Get list of applicable scenarios (all applicable, including noCalc)
            const applicableScenarios = SCENARIOS.filter(s => scenarioSelections[s.id]?.applicable);
            // Scenarios that need calculations (exclude noCalc scenarios like hydraulic thermal)
            const calculableScenarios = applicableScenarios.filter(s => !s.noCalc);

            // Apply preset to a specific scenario's composition
            const handlePresetChange = (presetId, scenarioId) => {
                setPreset(presetId);
                if (PRESETS[presetId]) {
                    setCompositions(prev => ({
                        ...prev,
                        [scenarioId]: PRESETS[presetId].composition
                    }));
                }
            };

            // Update composition for a specific scenario
            const handleCompChange = (scenarioId, comp, value) => {
                setCompositions(prev => ({
                    ...prev,
                    [scenarioId]: {
                        ...prev[scenarioId],
                        [comp]: parseFloat(value) || 0
                    }
                }));
            };

            // Copy composition from first applicable scenario to another
            const copyCompositionFrom = (fromScenarioId, toScenarioId) => {
                setCompositions(prev => ({
                    ...prev,
                    [toScenarioId]: { ...prev[fromScenarioId] }
                }));
            };

            // Dark mode effect - toggle body class
            useEffect(() => {
                document.body.classList.toggle('dark', darkMode);
                document.getElementById('app-body')?.classList.toggle('bg-gray-900', darkMode);
            }, [darkMode]);

            // Update scenario-specific conditions
            const updateScenarioCondition = (scenarioId, field, value) => {
                setScenarioConditions(prev => ({
                    ...prev,
                    [scenarioId]: {
                        ...prev[scenarioId],
                        [field]: field.includes('unit') || field.includes('tag') || field.includes('type') || field.includes('size')
                            ? value
                            : (typeof value === 'boolean' ? value : (parseFloat(value) || 0))
                    }
                }));
            };

            // Calculate total mol% for a specific scenario
            const getTotalMol = (scenarioId) => {
                const comp = compositions[scenarioId] || {};
                return Object.values(comp).reduce((a, b) => a + (b || 0), 0);
            };

            const calculate = () => {
                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                const selectedOrificeSize = deviceInfo.selected_orifice;
                const selectedOrifice = ORIFICES.find(o => o.size === selectedOrificeSize);
                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                // Calculate results for each applicable scenario
                const scenarioResults = {};
                let controllingScenario = null;
                let maxRequiredArea = 0;

                // Fire Unwetted (1B)
                if (scenarioSelections.fire_unwetted?.applicable) {
                    const comp = compositions.fire_unwetted || {};
                    const cond = scenarioConditions.fire_unwetted;
                    const p1_psia = setP * (1 + FIRE_OVERPRESSURE) + AMBIENT_PRESSURE;
                    const M = getMolecularWeight(comp);
                    const Pcrit = getCriticalPressure(comp);
                    const T1 = calcRelievingTemp(p1_psia, cond.normal_op_pressure, cond.normal_op_temp);
                    const vesselAreas = calcVesselAreas({ ...vesselDetails, max_liquid_level: 0 });
                    const unwettedArea = vesselAreas.adjustedUnwetted;
                    const qRelief = calcFireUnwettedReliefLoad(M, p1_psia, unwettedArea, MAX_WALL_TEMP, T1);
                    const T1_R = T1 + 459.67;
                    const k = getSpecificHeatRatio(comp);
                    const C = getAPI520_C(k);
                    const requiredArea = qRelief > 0 && M > 0 && p1_psia > 0
                        ? (qRelief * Math.sqrt(T1_R * 1.0)) / (C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M))
                        : 0;
                    const ratedLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                        ? (ratedArea * C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * 1.0)
                        : 0;
                    scenarioResults.fire_unwetted = {
                        applicable: true, label: '1B', name: 'Fire-Unwetted',
                        requiredFlow: qRelief, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea,
                        // Additional data for PDF
                        wettedArea: unwettedArea, relievingPressure: p1_psia,
                        relievingTempF: T1, molecularWeight: M,
                        specificHeatRatio: k, cCoefficient: C,
                        criticalPressure: Pcrit
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'fire_unwetted'; }
                }

                // Blocked Outlet (2A)
                if (scenarioSelections.blocked_vapor?.applicable) {
                    const comp = compositions.blocked_vapor || {};
                    const cond = scenarioConditions.blocked_vapor;
                    const p1_psia = setP * 1.10 + AMBIENT_PRESSURE;
                    const M = getMolecularWeight(comp);
                    const T1 = cond.normal_op_temp;
                    const T1_R = T1 + 459.67;
                    const k = getSpecificHeatRatio(comp);
                    const C = getAPI520_C(k);
                    const flowRateInput = parseFloat(cond.flow_rate) || 0;
                    const qRelief = cond.flow_rate_unit === 'mmscfd'
                        ? (flowRateInput * 1e6 * M) / (379.5 * 24)
                        : flowRateInput;
                    const requiredArea = qRelief > 0 && M > 0 && p1_psia > 0
                        ? (qRelief * Math.sqrt(T1_R * 1.0)) / (C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M))
                        : 0;
                    const ratedLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                        ? (ratedArea * C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * 1.0)
                        : 0;
                    scenarioResults.blocked_vapor = {
                        applicable: true, label: '2A', name: 'Blocked Outlet',
                        requiredFlow: qRelief, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea,
                        // Additional data for PDF
                        relievingPressure: p1_psia, relievingTempF: T1,
                        molecularWeight: M, specificHeatRatio: k, cCoefficient: C
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'blocked_vapor'; }
                }

                // Fire Wetted (1A) - Multi-component calculation matching UI
                if (scenarioSelections.fire_wetted?.applicable) {
                    const comp = compositions.fire_wetted || {};
                    const cond = scenarioConditions.fire_wetted;
                    const FIRE_WETTED_OVERPRESSURE = 0.21;
                    const p1_psia = setP * (1 + FIRE_WETTED_OVERPRESSURE) + AMBIENT_PRESSURE;
                    const M = getMolecularWeight(comp);
                    const k = getSpecificHeatRatio(comp);
                    const C = getAPI520_C(k);

                    // Determine if single or multi-component
                    const compEntries = Object.entries(comp).filter(([_, val]) => val > 0);
                    const isMultiComponent = compEntries.length > 1;

                    // Calculate bubble point temperature
                    const T_bubble = compEntries.length > 0 ? calcBubblePoint(comp, p1_psia) : cond.normal_op_temp;

                    // Heat absorption: checked = 21000, unchecked = 34500
                    const heatConst = cond.prompt_firefighting ? 21000 : 34500;
                    const F = 1.0; // Uninsulated
                    const wettedAreas = calcVesselAreas({ ...vesselDetails, max_liquid_level: cond.liquid_level });
                    const wettedArea = wettedAreas.wetted;
                    const Q = heatConst * F * Math.pow(wettedArea, 0.82);
                    const latentHeat = getLatentHeat(comp);

                    // Multi-component latent heat calculation
                    let effectiveLambda = latentHeat;
                    let T_B = T_bubble;
                    let mw_vapor = M;

                    if (isMultiComponent) {
                        const massFlowBasis = 1000;
                        const molarFlowBasis = M > 0 ? massFlowBasis / M : 0;

                        // Flash to 5% vapor
                        const vaporFracB = 0.05;
                        T_B = T_bubble + 30;
                        let flashB = null;
                        for (let iter = 0; iter < 100; iter++) {
                            flashB = calcFlash(comp, T_B, p1_psia);
                            const diff = flashB.V - vaporFracB;
                            if (Math.abs(diff) < 0.0005) break;
                            const dT = diff > 0 ? -Math.abs(diff) * 50 : Math.abs(diff) * 50;
                            T_B = T_B + dT * 0.5;
                            T_B = Math.max(T_bubble + 0.1, Math.min(T_bubble + 300, T_B));
                        }
                        flashB = calcFlash(comp, T_B, p1_psia);

                        const actualVaporFrac = flashB?.V || vaporFracB;
                        const molesVaporized = molarFlowBasis * actualVaporFrac;
                        mw_vapor = flashB?.mw_V || M;
                        const massVaporized = molesVaporized * mw_vapor;

                        // PR-EOS Latent Heat
                        const P_Pa = p1_psia * 6894.76;
                        const T_avg_K = ((T_bubble + T_B) / 2 + 459.67) * 5/9;
                        let latentHeat_PR = 0;
                        try {
                            const H_dep_V = calcEnthalpyDeparture(comp, T_avg_K, P_Pa, 'vapor');
                            const H_dep_L = calcEnthalpyDeparture(comp, T_avg_K, P_Pa, 'liquid');
                            const deltaH_Jmol = H_dep_V - H_dep_L;
                            latentHeat_PR = Math.abs(deltaH_Jmol) * 0.000947817 * 453.592;
                        } catch (e) {
                            latentHeat_PR = 0;
                        }

                        const Q_latent_PR = molesVaporized * latentHeat_PR;
                        const lambda_lightEnds_calc = massVaporized > 0 ? Q_latent_PR / massVaporized : latentHeat;
                        const safetyFactor = cond.latent_heat_safety_factor ? 0.90 : 1.0;
                        effectiveLambda = lambda_lightEnds_calc * safetyFactor;
                    }

                    const W = effectiveLambda > 0 ? Q / effectiveLambda : 0;
                    const T1_R = T_B + 459.67;

                    const requiredArea = W > 0 && mw_vapor > 0 && p1_psia > 0
                        ? (W * Math.sqrt(T1_R * 1.0)) / (C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(mw_vapor))
                        : 0;
                    const ratedLoad = ratedArea > 0 && mw_vapor > 0 && p1_psia > 0
                        ? (ratedArea * C * 0.975 * p1_psia * 1.0 * 1.0 * Math.sqrt(mw_vapor)) / Math.sqrt(T1_R * 1.0)
                        : 0;

                    scenarioResults.fire_wetted = {
                        applicable: true, label: '1A', name: '1A - Fire-Wetted',
                        requiredFlow: W, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea,
                        // Store additional data for PDF
                        wettedArea, heatAbsorptionConstant: heatConst, heatInput: Q,
                        latentHeat: effectiveLambda, relievingPressure: p1_psia,
                        relievingTempF: T_B, molecularWeight: mw_vapor
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'fire_wetted'; }
                }

                // CV Failure (3)
                if (scenarioSelections.cv_failure?.applicable) {
                    const comp = compositions.cv_failure || {};
                    const cond = scenarioConditions.cv_failure;
                    const M = getMolecularWeight(comp);
                    const Gg = M / 28.97;
                    const k = getSpecificHeatRatio(comp);
                    const Fk = k / 1.4;

                    const P1_psig = cond.upstream_pressure;
                    const P1_psia = P1_psig + 14.69;
                    const P2_psig = setP * 1.10;
                    const P2_psia = P2_psig + 14.69;
                    const deltaP = P1_psig - P2_psig;
                    const x = deltaP / P1_psia;

                    const Cv = cond.cv;
                    const XT = cond.xt;
                    const Z = 0.95;
                    const T1_R = cond.upstream_temp + 459.67;

                    const xChoked = Fk * XT;
                    const xEffective = Math.min(x, xChoked);
                    const Y = Math.max(1 - xEffective / (3 * Fk * XT), 0.667);

                    // ISA volumetric flow equation: q = N7 * Cv * P1 * Y * sqrt(x / (Gg * T * Z))
                    const N7 = 1360; // For q in scfh, P in psia, T in Â°R
                    const q_cv = Gg > 0 && T1_R > 0 && Z > 0
                        ? N7 * Cv * P1_psia * Y * Math.sqrt(xEffective / (Gg * T1_R * Z))
                        : 0;
                    const W_cv = q_cv * M / 379.5;

                    // Bypass flow calculations if applicable
                    let W = W_cv;
                    if (cond.has_bypass && cond.use_bypass_flow) {
                        const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                        const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                        const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;
                        const bypassXT = 1.0;
                        const bypassXChoked = Fk * bypassXT;
                        const bypassXEffective = Math.min(x, bypassXChoked);
                        const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                        const q_bypass = Gg > 0 && T1_R > 0 && Z > 0
                            ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                            : 0;
                        W = q_bypass * M / 379.5;
                    }

                    const C = getAPI520_C(k);
                    const requiredArea = W > 0 && M > 0 && P2_psia > 0
                        ? (W * Math.sqrt(T1_R * Z)) / (C * 0.975 * P2_psia * 1.0 * 1.0 * Math.sqrt(M))
                        : 0;
                    const ratedLoad = ratedArea > 0 && M > 0 && P2_psia > 0
                        ? (ratedArea * C * 0.975 * P2_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                        : 0;

                    scenarioResults.cv_failure = {
                        applicable: true, label: '3', name: '3 - CV Failure - Vapor',
                        requiredFlow: W, ratedFlow: ratedLoad, requiredArea, ratedArea,
                        adequate: ratedArea >= requiredArea,
                        // Additional data for PDF
                        relievingPressure: P2_psia, relievingTempF: cond.upstream_temp,
                        molecularWeight: M, specificHeatRatio: k, cCoefficient: C, Z: Z
                    };
                    if (requiredArea > maxRequiredArea) { maxRequiredArea = requiredArea; controllingScenario = 'cv_failure'; }
                }

                // Find recommended orifice (smallest that meets required area)
                const recommendedOrifice = ORIFICES.find(o => o.area >= maxRequiredArea) || ORIFICES[ORIFICES.length - 1];
                const isUndersized = ratedArea < maxRequiredArea;

                setResults({
                    deviceInfo,
                    selectedOrifice,
                    ratedArea,
                    scenarioResults,
                    controllingScenario,
                    maxRequiredArea,
                    vesselDetails,
                    recommendedOrifice,
                    isUndersized
                });
                setStep(5);
            };

            // Generate PDF Report
            const generateReport = (returnBlob = false) => {
                if (!results) {
                    alert('No results to generate report. Please complete calculations first.');
                    return;
                }

                try {
                    if (!window.jspdf) {
                        alert('PDF library not loaded. Please refresh the page and try again.');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = margin;

                    // Scenario definitions with full names and IDs
                    const SCENARIO_DEFS = {
                        fire_wetted: { id: '1A', name: 'Fire - Wetted', fullName: '1A - Fire-Wetted (Liquid Boil up)' },
                        fire_unwetted: { id: '1B', name: 'Fire - Unwetted', fullName: '1B - Fire-Unwetted (Vapor)' },
                        blocked_vapor: { id: '2A', name: 'Blocked Outlet', fullName: '2A - Blocked Outlet - Vapor' },
                        overfilling: { id: '2B', name: 'Overfilling', fullName: '2B - Overfilling', notCalculated: true },
                        cv_failure: { id: '3', name: 'CV Failure', fullName: '3 - CV Failure - Vapor' },
                        hydraulic_thermal: { id: '4', name: 'Hydraulic Expansion', fullName: '4 - Hydraulic Thermal Expansion', notCalculated: true },
                        loss_of_cooling: { id: '5', name: 'Loss of Cooling', fullName: '5 - Loss of Cooling', notCalculated: true },
                        abnormal_heat: { id: '6', name: 'Abnormal Heat Input', fullName: '6 - Abnormal Heat Input', notCalculated: true },
                        tube_rupture: { id: '7', name: 'Exchanger Tube Rupture', fullName: '7 - Exchanger Tube Rupture', notCalculated: true },
                        compressor_equalization: { id: '8', name: 'Compressor Equalization', fullName: '8 - Compressor Equalization', notCalculated: true },
                        power_failure: { id: '9', name: 'Power Failure', fullName: '9 - Power Failure', notCalculated: true },
                        other: { id: '10', name: 'Other', fullName: '10 - Other', notCalculated: true }
                    };

                    const controllingDef = SCENARIO_DEFS[results.controllingScenario] || { name: results.controllingScenario };

                    // Helper function to format numbers with commas
                    const formatNumber = (num, decimals = 0) => {
                        if (num === undefined || num === null || isNaN(num)) return '-';
                        return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
                    };

                    // Helper functions
                    // Footer is at pageHeight - 12 (line) and pageHeight - 8 (text)
                    // Reserve 25mm above footer to prevent overlap
                    const footerMargin = 25;
                    const checkNewPage = (requiredSpace = 30) => {
                        if (yPos + requiredSpace > pageHeight - footerMargin) {
                            doc.addPage();
                            yPos = margin;
                            return true;
                        }
                        return false;
                    };

                    const drawCellBorder = (x, y, w, h) => {
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.3);
                        doc.rect(x, y, w, h);
                    };

                    // Helper function to draw hatch pattern in a cell
                    const drawHatchPattern = (x, y, w, h, spacing = 2) => {
                        // Fill with light gray background first
                        doc.setFillColor(230, 230, 230);
                        doc.rect(x, y, w, h, 'F');

                        // Draw diagonal lines for hatch pattern
                        doc.setDrawColor(180, 180, 180);
                        doc.setLineWidth(0.3);

                        // Save current clip state and set clipping region
                        doc.saveGraphicsState();
                        doc.rect(x, y, w, h);
                        doc.clip();

                        // Draw diagonal lines from bottom-left to top-right
                        for (let i = -h; i < w + h; i += spacing) {
                            doc.line(x + i, y + h, x + i + h, y);
                        }

                        doc.restoreGraphicsState();

                        // Reset draw color
                        doc.setDrawColor(0, 0, 0);
                    };

                    const drawHeaderCell = (x, y, w, h, text) => {
                        doc.setFillColor(200, 220, 240);
                        doc.rect(x, y, w, h, 'F');
                        drawCellBorder(x, y, w, h);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        doc.text(text, x + 2, y + h/2 + 2);
                    };

                    // Get valve pipe sizes from selected orifice
                    const selectedOrifice = ORIFICES.find(o => o.size === deviceInfo.selected_orifice) || results.selectedOrifice;
                    const valvePipeSize = selectedOrifice ? `${selectedOrifice.inlet} x ${selectedOrifice.outlet}` : '-';

                    // ========== PAGE 1: COVER PAGE ==========
                    // Title box
                    doc.setFillColor(200, 220, 240);
                    doc.rect(margin, margin, pageWidth - 2*margin, 20, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.5);
                    doc.rect(margin, margin, pageWidth - 2*margin, 20);

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`${deviceInfo.tag || 'PSV'} Deliverable Rev. ${reportInfo.revision}`, margin + 5, margin + 13);

                    yPos = margin + 40;

                    // Revision History Table
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');

                    const revTableY = yPos;
                    const col1W = 30, col2W = 30, col3W = pageWidth - 2*margin - 60;

                    drawHeaderCell(margin, revTableY, col1W, 10, 'REVISION');
                    drawHeaderCell(margin + col1W, revTableY, col2W, 10, 'DATE');
                    drawHeaderCell(margin + col1W + col2W, revTableY, col3W, 10, 'DESCRIPTION OF CHANGE');

                    let rowY = revTableY + 10;
                    const rowH = 15;

                    reportInfo.revision_history.forEach((rev, i) => {
                        doc.setFillColor(255, 255, 255);
                        doc.rect(margin, rowY, col1W, rowH, 'F');
                        doc.rect(margin + col1W, rowY, col2W, rowH, 'F');
                        doc.rect(margin + col1W + col2W, rowY, col3W, rowH, 'F');
                        drawCellBorder(margin, rowY, col1W, rowH);
                        drawCellBorder(margin + col1W, rowY, col2W, rowH);
                        drawCellBorder(margin + col1W + col2W, rowY, col3W, rowH);

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);
                        doc.text(rev.rev, margin + col1W/2, rowY + rowH/2 + 2, { align: 'center' });
                        doc.text(rev.date, margin + col1W + col2W/2, rowY + rowH/2 + 2, { align: 'center' });
                        doc.text(rev.description, margin + col1W + col2W + 3, rowY + rowH/2 + 2);
                        rowY += rowH;
                    });

                    // Empty rows for future revisions
                    for (let i = reportInfo.revision_history.length; i < 7; i++) {
                        doc.rect(margin, rowY, col1W, rowH);
                        doc.rect(margin + col1W, rowY, col2W, rowH);
                        doc.rect(margin + col1W + col2W, rowY, col3W, rowH);
                        rowY += rowH;
                    }

                    // Small Franc Engineering at bottom
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text('Franc Engineering | franceng.com', pageWidth / 2, pageHeight - 20, { align: 'center' });

                    // ========== PAGE 2: RELIEF DEVICE SIZING SUMMARY ==========
                    doc.addPage();
                    yPos = margin;

                    // Header
                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 18, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 18);

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Relief Device Sizing Summary', margin + 3, yPos + 12);

                    // Right side header info
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Relief Device Tag :', pageWidth - 80, yPos + 6);
                    doc.text('P&ID Number :', pageWidth - 80, yPos + 12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(deviceInfo.tag || '-', pageWidth - 40, yPos + 6);
                    doc.text(deviceInfo.pid_number || '-', pageWidth - 40, yPos + 12);

                    yPos += 22;

                    // Relief Device & Protected System Details section
                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('Relief Device & Protected System Details', margin + 2, yPos + 5.5);
                    yPos += 14;  // Increased spacing after header

                    const leftCol = margin;
                    const rightCol = pageWidth / 2 + 10;
                    const detailsY = yPos;

                    // Left column - Relief Device
                    const leftDetails = [
                        ['Manufacturer', deviceInfo.manufacturer || '-'],
                        ['Model Number', deviceInfo.model_number || '-'],
                        ['Serial Number', deviceInfo.serial_number || '-'],
                        ['Valve Type', deviceInfo.psv_type?.toUpperCase() || 'CONVENTIONAL'],
                        ['', ''],
                        ['New or Existing?', deviceInfo.new_or_existing?.toUpperCase() || 'NEW'],
                        ['Discharge Location', deviceInfo.discharge_location?.toUpperCase() || 'ATMOSPHERE'],
                        ['Ambient Pressure', '14.7']
                    ];

                    // Right column - Simplified (no pipe schedule/rating)
                    const rightDetails = [
                        ['Orifice Designation', `API    ${selectedOrifice?.letter || '-'}`],
                        ['API Orifice Area', `${selectedOrifice?.area?.toFixed(3) || '-'} inÂ²`],
                        ['Relief Device Set Pressure (psig)', deviceInfo.set_pressure || '-'],
                        ['', ''],
                        ['Nominal Pipe Size (NPS)', valvePipeSize],
                    ];

                    doc.setFontSize(8);
                    leftDetails.forEach((row, i) => {
                        const rowY = detailsY + i * 6;
                        doc.setFont('helvetica', 'normal');
                        doc.text(row[0], leftCol, rowY);
                        doc.setFont('helvetica', 'bold');
                        doc.text(row[1], leftCol + 35, rowY);
                    });

                    rightDetails.forEach((row, i) => {
                        const rowY = detailsY + i * 6;
                        doc.setFont('helvetica', 'normal');
                        doc.text(row[0], rightCol, rowY);
                        doc.setFont('helvetica', 'bold');
                        doc.text(row[1], rightCol + 55, rowY);
                    });

                    yPos = detailsY + 52;

                    // Protected System info
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text('Protected System', leftCol, yPos);
                    doc.setFont('helvetica', 'bold');
                    doc.text(deviceInfo.protected_system || vesselDetails.equipment_tag || '-', leftCol + 35, yPos);
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.text('MAWP (psig)', leftCol, yPos);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${deviceInfo.mawp || deviceInfo.set_pressure || '-'}`, leftCol + 35, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Criteria for MAWP', leftCol + 55, yPos);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`MAWP of ${vesselDetails.equipment_tag || 'Vessel'}`, leftCol + 85, yPos);

                    yPos += 12;

                    // Summary of Potential Relieving Scenarios table
                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('Summary of Potential Relieving Scenarios', margin + 2, yPos + 5.5);
                    yPos += 10;

                    // Simplified scenario table with separate Required/Rated flow columns
                    const scenarioTableHeaders = ['Credible?', 'Scenario', 'Required\nRelieving Flow\n(lb/hr)', 'Rated\nRelieving Flow\n(lb/hr)', 'Required\nOrifice Area\n(inÂ²)', 'API Orifice\nArea\n(inÂ²)'];
                    const colWidths = [22, 45, 30, 30, 25, 25];
                    const headerH = 18;

                    let colX = margin;
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    scenarioTableHeaders.forEach((h, i) => {
                        doc.setFillColor(230, 230, 230);
                        doc.rect(colX, yPos, colWidths[i], headerH, 'F');
                        doc.rect(colX, yPos, colWidths[i], headerH);
                        const lines = h.split('\n');
                        lines.forEach((line, li) => {
                            doc.text(line, colX + colWidths[i]/2, yPos + 5 + li * 4, { align: 'center' });
                        });
                        colX += colWidths[i];
                    });

                    yPos += headerH;

                    // Build scenario rows with IDs in scenario name (Order: 1A, 1B, 2A, 2B, 3, 4, 5-10)
                    const scenarioOrder = ['fire_wetted', 'fire_unwetted', 'blocked_vapor', 'overfilling', 'cv_failure', 'hydraulic_thermal', 'loss_of_cooling', 'abnormal_heat', 'tube_rupture', 'compressor_equalization', 'power_failure', 'other'];
                    const scenarioRowH = 8;

                    scenarioOrder.forEach(scenId => {
                        // Check for page break before drawing each scenario row
                        checkNewPage(scenarioRowH + 5);

                        const sel = scenarioSelections[scenId];
                        const def = SCENARIO_DEFS[scenId];
                        const sr = results.scenarioResults?.[scenId];
                        const isNotCalculated = def?.notCalculated;

                        let credible = 'NO';
                        if (scenId === 'hydraulic_thermal') {
                            // Hydraulic Thermal Expansion shows YES/NO based on user selection
                            credible = sel?.applicable ? 'YES' : 'NO';
                        } else if (isNotCalculated) {
                            credible = 'Unknown';
                        } else if (sel?.applicable && sr?.applicable) {
                            credible = 'YES';
                        } else if (sel?.applicable && sel?.notes) {
                            credible = 'SEE COMMENTS';
                        }

                        // Add ID to scenario name (e.g., "1A Fire - Wetted")
                        const scenarioNameWithId = `${def?.id} ${def?.name || scenId}`;

                        colX = margin;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(7);

                        // Determine if this is the controlling scenario
                        const isControlling = scenId === results.controllingScenario;

                        // Determine row background color based on new logic:
                        // - Not Calculated (Unknown): solid darker gray (except hydraulic_thermal)
                        // - Credible (YES) + Adequate (required < API): light green
                        // - Credible (YES) + Not Adequate (required >= API): light red
                        // - Not credible (NO): light blue-gray for distinction
                        let rowBgColor;
                        const scenarioUndersized = sr?.applicable && sr.requiredArea > (selectedOrifice?.area || 0);
                        // Hydraulic thermal is shown as regular row (not grayed out), but with no flow/area values
                        const showAsNotCalculated = isNotCalculated && scenId !== 'hydraulic_thermal';
                        if (showAsNotCalculated) {
                            rowBgColor = [200, 200, 200]; // Darker gray for Unknown/Not Calculated
                        } else if (credible === 'YES' || credible === 'SEE COMMENTS') {
                            // Check if the scenario is adequate (required area < API orifice area)
                            if (scenarioUndersized) {
                                rowBgColor = [255, 199, 206]; // Light red - credible but NOT adequate
                            } else {
                                rowBgColor = [198, 239, 206]; // Light green - credible AND adequate
                            }
                        } else {
                            rowBgColor = [220, 230, 240]; // Light blue-gray - not credible (NO)
                        }

                        if (showAsNotCalculated) {
                            // "Not Calculated" scenarios - solid darker gray (no hatch)
                            // Credible cell - darker gray background
                            doc.setFillColor(200, 200, 200);
                            doc.rect(colX, yPos, colWidths[0], scenarioRowH, 'F');
                            doc.rect(colX, yPos, colWidths[0], scenarioRowH);
                            doc.setTextColor(80, 80, 80);
                            doc.text(credible, colX + colWidths[0]/2, yPos + scenarioRowH/2 + 1.5, { align: 'center' });
                            colX += colWidths[0];

                            // Scenario name cell - darker gray
                            doc.setFillColor(200, 200, 200);
                            doc.rect(colX, yPos, colWidths[1], scenarioRowH, 'F');
                            doc.rect(colX, yPos, colWidths[1], scenarioRowH);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(80, 80, 80);
                            doc.text(scenarioNameWithId, colX + colWidths[1]/2, yPos + scenarioRowH/2 + 1.5, { align: 'center' });
                            colX += colWidths[1];

                            // Merged "Not Calculated" cells (span remaining 4 columns) - solid darker gray
                            const mergedWidth = colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5];
                            doc.setFillColor(200, 200, 200);
                            doc.rect(colX, yPos, mergedWidth, scenarioRowH, 'F');
                            doc.rect(colX, yPos, mergedWidth, scenarioRowH);
                            doc.setFont('helvetica', 'italic');
                            doc.text('Not Calculated', colX + mergedWidth/2, yPos + scenarioRowH/2 + 1.5, { align: 'center' });

                            doc.setTextColor(0, 0, 0);
                        } else {
                            // Regular calculated scenarios
                            const rowData = [
                                credible,
                                scenarioNameWithId,
                                sr?.applicable ? formatNumber(sr.requiredFlow, 0) : '-',
                                sr?.applicable ? formatNumber(sr.ratedFlow, 0) : '-',
                                sr?.applicable ? sr.requiredArea?.toFixed(3) : '-',
                                sr?.applicable ? (selectedOrifice?.area?.toFixed(3) || '-') : '-'
                            ];

                            rowData.forEach((cell, i) => {
                                // All cells use the row background color consistently
                                // Credible + Adequate = green, Credible + Not Adequate = red, Not credible (NO) = light blue-gray
                                doc.setFillColor(...rowBgColor);

                                doc.rect(colX, yPos, colWidths[i], scenarioRowH, 'F');
                                doc.rect(colX, yPos, colWidths[i], scenarioRowH);
                                doc.text(cell.toString(), colX + colWidths[i]/2, yPos + scenarioRowH/2 + 1.5, { align: 'center' });
                                colX += colWidths[i];
                            });
                        }

                        // Draw double bold border for controlling scenario
                        if (isControlling) {
                            const totalRowWidth = colWidths.reduce((a, b) => a + b, 0);
                            doc.setLineWidth(1.2); // Thicker line for emphasis
                            doc.setDrawColor(0, 0, 0);
                            doc.rect(margin, yPos, totalRowWidth, scenarioRowH);
                            doc.setLineWidth(0.3); // Reset line width
                        }

                        yPos += scenarioRowH;
                    });

                    yPos += 4;

                    // Design Scenario Summary
                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('Design Scenario Summary', margin + 2, yPos + 5.5);
                    yPos += 12;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Design Scenario', leftCol, yPos);
                    doc.setFont('helvetica', 'bold');
                    doc.text(controllingDef.fullName || controllingDef.name, leftCol + 35, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Required Orifice Area', rightCol, yPos);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${results.maxRequiredArea.toFixed(3)} inÂ²`, rightCol + 40, yPos);

                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.text('Relieving Fluid', leftCol, yPos);
                    doc.setFont('helvetica', 'bold');
                    const controllingComp = compositions[results.controllingScenario] || {};
                    const compNames = Object.entries(controllingComp).filter(([k,v]) => v > 0).map(([k,v]) => k);
                    const fluidDesc = compNames.length > 0 ? compNames.slice(0, 3).join(' / ').toUpperCase() : 'VAPOR';
                    doc.text(fluidDesc, leftCol + 35, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text('% Overpressure', rightCol, yPos);
                    doc.setFont('helvetica', 'bold');
                    const overpressure = results.controllingScenario.includes('fire') ? '21%' : '10%';
                    doc.text(overpressure, rightCol + 40, yPos);

                    yPos += 12;

                    // Existing Relief System Adequate?
                    const isAdequate = !results.isUndersized;
                    doc.setFont('helvetica', 'normal');
                    doc.text('Existing Relief System Adequate?:', leftCol, yPos);

                    doc.setFillColor(isAdequate ? 198 : 255, isAdequate ? 239 : 199, isAdequate ? 206 : 206);
                    doc.rect(leftCol + 55, yPos - 4, 15, 6, 'F');
                    doc.rect(leftCol + 55, yPos - 4, 15, 6);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isAdequate ? 0 : 200, isAdequate ? 100 : 0, isAdequate ? 0 : 0);
                    doc.text(isAdequate ? 'YES' : 'NO', leftCol + 62.5, yPos, { align: 'center' });
                    doc.setTextColor(0, 0, 0);

                    if (!isAdequate) {
                        doc.setFont('helvetica', 'bold');
                        doc.text('RELIEF VALVE UNDERSIZED', leftCol + 75, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Recommended: ${results.recommendedOrifice?.letter || 'N/A'} (${results.recommendedOrifice?.area?.toFixed(3) || '-'} inÂ²)`, leftCol + 120, yPos);
                    }

                    // ========== PAGE 3: POTENTIAL RELIEVING SCENARIO DESCRIPTIONS ==========
                    doc.addPage();
                    yPos = margin;

                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Potential Relieving Scenario Descriptions', margin + 2, yPos + 5.5);
                    yPos += 15;

                    // Output each scenario description with ID
                    scenarioOrder.forEach(scenId => {
                        const sel = scenarioSelections[scenId];
                        const def = SCENARIO_DEFS[scenId];
                        const sr = results.scenarioResults?.[scenId];
                        const isNotCalculated = def?.notCalculated;

                        // Use the notes from the text box or default text
                        let notes;
                        if (scenId === 'hydraulic_thermal') {
                            // Special handling for Hydraulic Thermal Expansion
                            if (sel?.applicable) {
                                notes = sel?.notes || `Per API 521 4.4.12.2, the required relieving rate due to thermal expansion is minimal and difficult to calculate. Because of this, the required relieving rate is generally not calculated when the protected system meets one of the criteria described below, as detailed in API 521 4.4.12.3:\n\n1. The protected system consists of long, aboveground, uninsulated pipelines of large diameter.\n2. The protected system includes large vessels or exchangers operating liquid full.\n\nBecause the two cases above do not apply, a detailed analysis has not been performed.`;
                            } else {
                                notes = sel?.notes || `The system is not expected to operate liquid-full or has a different applicable scenario.`;
                            }
                        } else if (isNotCalculated) {
                            notes = `This scenario is not analyzed in this calculator. If applicable to your system, consult with a process engineer for proper evaluation.`;
                        } else {
                            notes = sel?.notes || `No notes provided for ${def?.name || scenId}.`;
                        }
                        const noteLines = doc.splitTextToSize(notes, pageWidth - 2*margin - 4);
                        const boxH = Math.max(15, noteLines.length * 4 + 6);

                        // Check for page break with actual required space (header + box + spacing)
                        checkNewPage(boxH + 15);

                        let credible = 'NO';
                        if (scenId === 'hydraulic_thermal') {
                            // Hydraulic Thermal Expansion shows YES/NO based on user selection
                            credible = sel?.applicable ? 'YES' : 'NO';
                        } else if (isNotCalculated) {
                            credible = 'Unknown';
                        } else if (sel?.applicable && sr?.applicable) {
                            credible = 'YES';
                        } else if (sel?.applicable && sel?.notes) {
                            credible = 'SEE COMMENTS';
                        }

                        // Include scenario ID in header
                        doc.setFont('helvetica', 'bolditalic');
                        doc.setFontSize(9);
                        // Hydraulic thermal shows normal styling (not grayed out like other notCalculated scenarios)
                        const isGrayedOut = isNotCalculated && scenId !== 'hydraulic_thermal';
                        if (isGrayedOut) {
                            doc.setTextColor(100, 100, 100);
                        } else {
                            doc.setTextColor(0, 0, 0);
                        }
                        doc.text(`${def?.id} - ${def?.name || scenId}`, margin, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Credible:  ${credible}`, margin + 55, yPos);

                        yPos += 4;

                        if (isGrayedOut) {
                            doc.setFillColor(240, 240, 240);
                            doc.rect(margin, yPos, pageWidth - 2*margin, boxH, 'F');
                        }
                        doc.rect(margin, yPos, pageWidth - 2*margin, boxH);
                        doc.setFontSize(8);
                        if (isGrayedOut) {
                            doc.setTextColor(100, 100, 100);
                            doc.setFont('helvetica', 'italic');
                        } else {
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                        }
                        noteLines.forEach((line, i) => {
                            doc.text(line, margin + 2, yPos + 4 + i * 4);
                        });
                        doc.setTextColor(0, 0, 0);

                        yPos += boxH + 8;
                    });

                    // ========== PAGE 4+: CALCULATION DETAILS (per scenario) ==========
                    doc.addPage();
                    yPos = margin;

                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                    doc.rect(margin, yPos, pageWidth - 2*margin, 8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('Calculation Details', margin + 2, yPos + 5.5);
                    yPos += 15;

                    // For each applicable scenario, show calculations, composition, and methodology
                    scenarioOrder.forEach(scenId => {
                        const sel = scenarioSelections[scenId];
                        const def = SCENARIO_DEFS[scenId];
                        const sr = results.scenarioResults?.[scenId];
                        const comp = compositions[scenId] || {};
                        const isNotCalculated = def?.notCalculated;

                        // Skip non-applicable scenarios and notCalculated scenarios (they have no calculation details)
                        if (!sel?.applicable || isNotCalculated) return;

                        checkNewPage(100);

                        // Scenario header with badge
                        doc.setFillColor(230, 230, 230);
                        doc.rect(margin, yPos, pageWidth - 2*margin, 10, 'F');
                        doc.rect(margin, yPos, pageWidth - 2*margin, 10);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.text(`${def?.id} - ${def?.fullName || scenId}`, margin + 3, yPos + 7);
                        yPos += 14;

                        // Scenario-specific calculations (MOVED BEFORE COMPOSITION)
                        if (sr?.applicable) {
                            // ========== RELIEF DEVICE SIZING SUMMARY (Required vs Rated) ==========
                            doc.setFont('helvetica', 'bold');
                            doc.setFontSize(9);
                            doc.text('Relief Device Sizing Summary', margin, yPos);
                            yPos += 5;

                            const summaryBoxWidth = (pageWidth - 2*margin - 10) / 2;
                            const summaryBoxHeight = 28;
                            const utilization = sr.requiredArea > 0 && selectedOrifice?.area > 0
                                ? (sr.requiredArea / selectedOrifice.area * 100) : 0;
                            const isAdequate = utilization <= 100;

                            // Required box
                            doc.setFillColor(255, 250, 240);
                            doc.rect(margin, yPos, summaryBoxWidth, summaryBoxHeight, 'F');
                            doc.rect(margin, yPos, summaryBoxWidth, summaryBoxHeight);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(100, 100, 100);
                            doc.text('REQUIRED', margin + 3, yPos + 5);
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Relief Load:', margin + 3, yPos + 12);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${formatNumber(sr.requiredFlow, 0)} lb/hr`, margin + summaryBoxWidth - 5, yPos + 12, { align: 'right' });
                            doc.setFont('helvetica', 'normal');
                            doc.text('Relief Area:', margin + 3, yPos + 19);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${sr.requiredArea?.toFixed(3) || '-'} inÂ²`, margin + summaryBoxWidth - 5, yPos + 19, { align: 'right' });

                            // Rated box
                            doc.setFillColor(240, 248, 255);
                            doc.rect(margin + summaryBoxWidth + 10, yPos, summaryBoxWidth, summaryBoxHeight, 'F');
                            doc.rect(margin + summaryBoxWidth + 10, yPos, summaryBoxWidth, summaryBoxHeight);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(100, 100, 100);
                            doc.text(`RATED (${selectedOrifice?.letter || '-'})`, margin + summaryBoxWidth + 13, yPos + 5);
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Relief Load:', margin + summaryBoxWidth + 13, yPos + 12);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${formatNumber(sr.ratedFlow, 0)} lb/hr`, margin + 2*summaryBoxWidth + 5, yPos + 12, { align: 'right' });
                            doc.setFont('helvetica', 'normal');
                            doc.text('Relief Area:', margin + summaryBoxWidth + 13, yPos + 19);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${selectedOrifice?.area?.toFixed(3) || '-'} inÂ²`, margin + 2*summaryBoxWidth + 5, yPos + 19, { align: 'right' });

                            yPos += summaryBoxHeight + 4;

                            // Sizing % bar
                            if (utilization > 0) {
                                doc.setFontSize(8);
                                doc.setFont('helvetica', 'normal');
                                doc.text('Sizing %:', margin, yPos + 4);
                                const barX = margin + 25;
                                const barWidth = 60;
                                const barHeight = 5;
                                doc.setFillColor(230, 230, 230);
                                doc.rect(barX, yPos, barWidth, barHeight, 'F');
                                doc.setFillColor(isAdequate ? 34 : 220, isAdequate ? 197 : 53, isAdequate ? 94 : 69);
                                doc.rect(barX, yPos, Math.min(utilization / 100, 1) * barWidth, barHeight, 'F');
                                doc.rect(barX, yPos, barWidth, barHeight);
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(isAdequate ? 34 : 220, isAdequate ? 197 : 53, isAdequate ? 94 : 69);
                                doc.text(`${utilization.toFixed(1)}%${isAdequate ? '' : ' (Undersized!)'}`, barX + barWidth + 3, yPos + 4);
                                doc.setTextColor(0, 0, 0);
                                yPos += 10;
                            }

                            // ========== SIZING CALCULATION TABLE ==========
                            doc.setFont('helvetica', 'bold');
                            doc.setFontSize(9);
                            doc.text('Sizing Calculation', margin, yPos);
                            yPos += 5;

                            // Build calculation details based on scenario type - matching online calc layout
                            const cond = scenarioConditions[scenId] || {};

                            // Operating Conditions section (common to most scenarios except CV Failure)
                            if (scenId !== 'cv_failure') {
                                checkNewPage(30);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(220, 255, 220);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Operating Conditions (Inputs)', margin + 2, yPos + 4);
                                yPos += 8;

                                const opConditions = [
                                    ['Normal Operating Pressure (Pn)', `${cond.normal_op_pressure || '-'} psig`],
                                    ['Normal Operating Temperature (Tn)', `${cond.normal_op_temp || '-'} Â°F`]
                                ];
                                doc.autoTable({
                                    startY: yPos,
                                    body: opConditions,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 5;
                            }

                            // Vessel Details section (for fire scenarios)
                            if (scenId === 'fire_wetted' || scenId === 'fire_unwetted') {
                                checkNewPage(40);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(245, 245, 245);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Vessel Details', margin + 2, yPos + 4);
                                yPos += 8;

                                const vesselData = [
                                    ['Equipment Tag', vesselDetails.equipment_tag || '-'],
                                    ['Orientation', vesselDetails.orientation === 'horizontal' ? 'Horizontal' : 'Vertical'],
                                    ['Head Type', vesselDetails.head_type?.replace('_', ' ').toUpperCase() || '-'],
                                    ['Inner Diameter (ID)', `${vesselDetails.inner_diameter || '-'} in`],
                                    ['Seam-to-Seam Length', `${vesselDetails.seam_to_seam || '-'} ft`],
                                    ['Height Above Grade', `${vesselDetails.height_above_grade || '-'} ft`],
                                    ['Max Liquid Operating Level', `${scenId === 'fire_wetted' ? (cond.liquid_level || 0) : 0} %`]
                                ];
                                doc.autoTable({
                                    startY: yPos,
                                    body: vesselData,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 5;
                            }

                            // Scenario-specific calculation details
                            let calcDetails = [];

                            if (scenId === 'fire_wetted') {
                                // Latent Heat Calculation section
                                checkNewPage(40);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(255, 220, 220);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Latent Heat Calculation', margin + 2, yPos + 4);
                                yPos += 8;

                                const latentHeatData = [
                                    ['Ambient Pressure', '14.7 psia'],
                                    ['Relief Device Set Pressure', `${deviceInfo.set_pressure || '-'} psig`],
                                    ['Allowable Overpressure', '21%'],
                                    ['Absolute Relieving Pressure (P1)', `${sr.relievingPressure?.toFixed(1) || '-'} psia`],
                                    ['Relieving Temperature', `${sr.relievingTempF?.toFixed(0) || '-'} Â°F`]
                                ];
                                doc.autoTable({
                                    startY: yPos,
                                    body: latentHeatData,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 5;

                                // Required Relieving Rate Calculation
                                checkNewPage(50);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(245, 245, 245);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Required Relieving Rate Calculation', margin + 2, yPos + 4);
                                yPos += 8;

                                calcDetails = [
                                    ['Is the Vessel Insulated or Bare?', 'BARE'],
                                    ['Environment Factor (F)', '1.00'],
                                    ['Wetted Surface Area (Aws)', `${sr.wettedArea?.toFixed(1) || '-'} ftÂ²`],
                                    ['Heat Absorption Constant (C1 or C2)', sr.heatAbsorptionConstant ? `${formatNumber(sr.heatAbsorptionConstant, 0)}` : '34,500'],
                                    ['Total Heat Absorption (Q)', `${formatNumber(sr.heatInput || 0, 0)} Btu/hr`],
                                    ['Multi-Component Latent Heat', `${sr.latentHeat?.toFixed(0) || '-'} Btu/lb`],
                                    ['Relief Load (W = Q/Î»)', `${formatNumber(sr.requiredFlow, 0)} lb/hr`],
                                    ['Molecular Weight (M)', `${sr.molecularWeight?.toFixed(2) || '-'} lb/lbmol`],
                                    ['Compressibility Factor (Z)', '1.0'],
                                    ['Kd (Coefficient of Discharge)', '0.975'],
                                    ['Kb (Back Pressure Correction)', '1.0'],
                                    ['Required Orifice Area', `${sr.requiredArea?.toFixed(4) || '-'} inÂ²`]
                                ];
                            } else if (scenId === 'fire_unwetted') {
                                // Fire Unwetted calculation details
                                checkNewPage(50);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(245, 245, 245);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Required Relieving Rate Calculation', margin + 2, yPos + 4);
                                yPos += 8;

                                calcDetails = [
                                    ['Relief Device Set Pressure', `${deviceInfo.set_pressure || '-'} psig`],
                                    ['Allowable Overpressure', '21%'],
                                    ['Relieving Pressure (p1)', `${(sr.relievingPressure - 14.69)?.toFixed(1) || '-'} psig`],
                                    ['Critical Pressure (PCRIT)', `${sr.criticalPressure?.toFixed(0) || '-'} psia`],
                                    ['Vapor Molecular Weight (M)', `${sr.molecularWeight?.toFixed(1) || '-'}`],
                                    ['Maximum Wall Temperature (Tw)', '1,100 Â°F'],
                                    ['Unwetted Surface Area (A\')', `${sr.wettedArea?.toFixed(1) || '-'} ftÂ²`],
                                    ['Relieving Temperature (T1)', `${sr.relievingTempF?.toFixed(0) || '-'} Â°F`],
                                    ['Relief Load (qm,relief)', `${formatNumber(sr.requiredFlow, 0)} lb/hr`],
                                    ['Specific Heat Ratio (k)', `${sr.specificHeatRatio?.toFixed(3) || '-'}`],
                                    ['C Coefficient', `${sr.cCoefficient?.toFixed(1) || '315'}`],
                                    ['Required Orifice Area', `${sr.requiredArea?.toFixed(4) || '-'} inÂ²`]
                                ];
                            } else if (scenId === 'blocked_vapor') {
                                // Blocked Outlet calculation details
                                checkNewPage(40);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(245, 245, 245);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Sizing Calculation', margin + 2, yPos + 4);
                                yPos += 8;

                                calcDetails = [
                                    ['Relief Device Set Pressure', `${deviceInfo.set_pressure || '-'} psig`],
                                    ['Allowable Overpressure', '10%'],
                                    ['Relieving Pressure (p1)', `${(sr.relievingPressure - 14.69)?.toFixed(1) || '-'} psig`],
                                    ['Relieving Temperature (T1)', `${sr.relievingTempF?.toFixed(0) || '-'} Â°F`],
                                    ['Vapor Molecular Weight (M)', `${sr.molecularWeight?.toFixed(1) || '-'}`],
                                    ['Specific Heat Ratio (k)', `${sr.specificHeatRatio?.toFixed(3) || '-'}`],
                                    ['C Coefficient', `${sr.cCoefficient?.toFixed(1) || '315'}`],
                                    ['Relieving Rate (Input)', `${formatNumber(sr.requiredFlow, 0)} lb/hr`],
                                    ['Compressibility Factor (Z)', '1.0'],
                                    ['Kd (Coefficient of Discharge)', '0.975'],
                                    ['Kb (Back Pressure Correction)', '1.0'],
                                    ['Kc (Combination Correction)', '1.0'],
                                    ['Required Orifice Area', `${sr.requiredArea?.toFixed(4) || '-'} inÂ²`]
                                ];
                            } else if (scenId === 'cv_failure') {
                                // CV Failure calculation details - more comprehensive like online
                                checkNewPage(30);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(245, 245, 245);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Vapor Properties', margin + 2, yPos + 4);
                                yPos += 8;

                                const vaporProps = [
                                    ['Molecular Weight', `${sr.molecularWeight?.toFixed(2) || '-'} lb/lbmol`],
                                    ['Specific Gravity (Gg)', `${(sr.molecularWeight / 28.97)?.toFixed(3) || '-'}`],
                                    ['Specific Heat Ratio (k)', `${sr.specificHeatRatio?.toFixed(3) || '-'}`],
                                    ['Ratio Factor (Fk)', `${(sr.specificHeatRatio / 1.4)?.toFixed(3) || '-'}`]
                                ];
                                doc.autoTable({
                                    startY: yPos,
                                    body: vaporProps,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 5;

                                // Upstream/Downstream Properties
                                checkNewPage(30);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(245, 245, 245);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Upstream & Downstream Properties', margin + 2, yPos + 4);
                                yPos += 8;

                                const upDownProps = [
                                    ['Maximum Operating Pressure (P1)', `${cond.upstream_pressure || '-'} psig`],
                                    ['Temperature (T1)', `${cond.upstream_temp || '-'} Â°F`],
                                    ['Relief Device Set Pressure', `${deviceInfo.set_pressure || '-'} psig`],
                                    ['Allowable Overpressure', '10%'],
                                    ['Relieving Pressure (P2)', `${(sr.relievingPressure - 14.69)?.toFixed(1) || '-'} psig`]
                                ];
                                doc.autoTable({
                                    startY: yPos,
                                    body: upDownProps,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 5;

                                // Control Valve Specification
                                checkNewPage(30);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(255, 240, 220);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Control Valve Specification', margin + 2, yPos + 4);
                                yPos += 8;

                                const cvProps = [
                                    ['Valve Tag', cond.valve_tag || '-'],
                                    ['Full-Open Valve Coefficient (Cv)', `${cond.cv || '-'}`],
                                    ['Pressure Drop Ratio Factor (XT)', `${cond.xt || '-'}`]
                                ];
                                doc.autoTable({
                                    startY: yPos,
                                    body: cvProps,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 5;

                                // Bypass Valve Information (Reference Only) - if bypass is configured
                                if (cond.has_bypass) {
                                    checkNewPage(35);
                                    doc.setFont('helvetica', 'bold');
                                    doc.setFontSize(8);
                                    doc.setFillColor(255, 250, 230); // Light amber for bypass reference
                                    doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                    doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                    doc.text('Bypass Valve Information (Reference)', margin + 2, yPos + 4);
                                    yPos += 8;

                                    // Calculate bypass flow values for PDF
                                    const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                    const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                                    const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;

                                    // Calculate bypass flow for display
                                    const M = sr.molecularWeight || 20;
                                    const Gg = M / 28.97;
                                    const k = sr.specificHeatRatio || 1.25;
                                    const Fk = k / 1.4;
                                    const P1_psia = (parseFloat(cond.upstream_pressure) || 0) + 14.7;
                                    const P2_psia = sr.relievingPressure || 0;
                                    const T1_R = ((parseFloat(cond.upstream_temp) || 60) + 460);
                                    const Z = sr.Z || 0.95;
                                    const x = P1_psia > 0 ? (P1_psia - P2_psia) / P1_psia : 0;
                                    const bypassXT = 1.0;
                                    const bypassXChoked = Fk * bypassXT;
                                    const bypassXEffective = Math.min(x, bypassXChoked);
                                    const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                                    const N7 = 1360;
                                    const bypassQ = Gg > 0 && T1_R > 0 && Z > 0
                                        ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                                        : 0;
                                    const bypassW = bypassQ * M / 379.5;

                                    const bypassProps = [
                                        ['Valve Type', cond.bypass_valve_type === 'globe' ? 'Globe Valve' : 'Ball Valve'],
                                        ['Nominal Size', cond.bypass_size || '-'],
                                        ['Bypass Cv', `${bypassCv}`],
                                        ['Bypass Flow (q)', `${formatNumber(bypassQ, 0)} scfh`],
                                        ['Bypass Mass Flow (W)', `${formatNumber(bypassW, 0)} lb/hr`],
                                        ['Used for Sizing', cond.use_bypass_flow ? 'YES' : 'NO']
                                    ];
                                    doc.autoTable({
                                        startY: yPos,
                                        body: bypassProps,
                                        theme: 'plain',
                                        bodyStyles: { fontSize: 8 },
                                        columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 50, halign: 'right' } },
                                        margin: { left: margin, right: margin, bottom: footerMargin },
                                        tableWidth: 130
                                    });
                                    yPos = doc.lastAutoTable.finalY + 5;
                                }

                                // Calculated Flow section
                                checkNewPage(30);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(8);
                                doc.setFillColor(220, 240, 255);
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6, 'F');
                                doc.rect(margin, yPos, pageWidth - 2*margin, 6);
                                doc.text('Calculated Flow Through Failed Valve', margin + 2, yPos + 4);
                                yPos += 8;

                                calcDetails = [
                                    ['Mass Flow (W)', `${formatNumber(sr.requiredFlow, 0)} lb/hr`],
                                    ['Compressibility Factor (Z)', `${sr.Z?.toFixed(2) || '0.95'}`],
                                    ['C Coefficient', `${sr.cCoefficient?.toFixed(1) || '315'}`],
                                    ['Kd (Coefficient of Discharge)', '0.975'],
                                    ['Kb (Back Pressure Correction)', '1.0'],
                                    ['Kc (Combination Correction)', '1.0'],
                                    ['Required Orifice Area', `${sr.requiredArea?.toFixed(4) || '-'} inÂ²`]
                                ];
                            }

                            if (calcDetails.length > 0) {
                                doc.autoTable({
                                    startY: yPos,
                                    body: calcDetails,
                                    theme: 'plain',
                                    bodyStyles: { fontSize: 8 },
                                    columnStyles: {
                                        0: { cellWidth: 80 },
                                        1: { cellWidth: 50, halign: 'right' }
                                    },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 130
                                });
                                yPos = doc.lastAutoTable.finalY + 8;
                            }

                            // ========== FLUID COMPOSITION (MOVED AFTER SIZING CALC) ==========
                            const compEntries = Object.entries(comp).filter(([_, val]) => val > 0);
                            if (compEntries.length > 0) {
                                checkNewPage(40);
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(9);
                                doc.text('Fluid Composition', margin, yPos);
                                yPos += 5;

                                doc.autoTable({
                                    startY: yPos,
                                    head: [['Component', 'Mol %', 'MW (lb/lbmol)']],
                                    body: compEntries.map(([name, val]) => {
                                        const c = COMPONENTS[name] || {};
                                        return [c.name || name, val.toFixed(2), c.mw?.toFixed(2) || '-'];
                                    }),
                                    theme: 'grid',
                                    headStyles: { fillColor: [200, 220, 240], textColor: [0, 0, 0], fontStyle: 'bold', fontSize: 8 },
                                    bodyStyles: { fontSize: 8 },
                                    margin: { left: margin, right: margin, bottom: footerMargin },
                                    tableWidth: 90
                                });
                                yPos = doc.lastAutoTable.finalY + 8;
                            }

                            // ========== SIZING METHODOLOGY (AFTER COMPOSITION) ==========
                            checkNewPage(25);
                            doc.setFont('helvetica', 'bold');
                            doc.setFontSize(8);
                            doc.text('Sizing Methodology', margin, yPos);
                            yPos += 4;
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);

                            let methodText = [];
                            if (scenId === 'fire_wetted') {
                                methodText = [
                                    'Fire Case (Wetted Surface) per API 521 Section 4.4.13.2:',
                                    'Q = Câ‚ Ã— F Ã— A^0.82  where Câ‚ = 21,000 (adequate drainage) or 34,500 (inadequate)',
                                    'W = Q / Î»  (Relief load = Heat input / Latent heat)',
                                    'A = W Ã— âˆš(TÃ—Z) / (C Ã— Kd Ã— Pâ‚ Ã— Kb Ã— âˆšM)  (API 520 vapor sizing equation)'
                                ];
                            } else if (scenId === 'fire_unwetted') {
                                methodText = [
                                    'Fire Case (Unwetted/Vapor) per API 521 Section 4.4.13.2.4.3:',
                                    'For gas-filled vessels exposed to fire, relief is based on vessel wall temperature limit.',
                                    'A = W Ã— âˆš(TÃ—Z) / (C Ã— Kd Ã— Pâ‚ Ã— Kb Ã— âˆšM)  (API 520 vapor sizing equation)'
                                ];
                            } else {
                                methodText = [
                                    'Vapor Sizing per API 520 Section 5.6:',
                                    'A = W Ã— âˆš(TÃ—Z) / (C Ã— Kd Ã— Pâ‚ Ã— Kb Ã— Kc Ã— âˆšM)',
                                    'Where: Kd = 0.975 (vapor), Kb = 1.0 (atm discharge), Kc = 1.0 (no rupture disk), Z = 1.0'
                                ];
                            }

                            methodText.forEach(line => {
                                doc.text(line, margin, yPos);
                                yPos += 3.5;
                            });

                            yPos += 12;
                        }
                    });

                    // ========== REFERENCES & ATTACHMENTS DIVIDER PAGE ==========
                    doc.addPage();

                    // Add bookmark/outline for this page
                    const refPageNum = doc.internal.getNumberOfPages();

                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('RELIEF DEVICE SIZING', pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
                    doc.text('REFERENCES & ATTACHMENTS', pageWidth / 2, pageHeight / 2 + 10, { align: 'center' });

                    // ========== ATTACHMENT PAGES ==========
                    // TODO: Implement proper PDF embedding for Pages 7-9
                    // - Use pdf-lib or similar library to merge uploaded PDFs into the report
                    // - Currently only images are embedded, PDFs show placeholder text
                    // Embed uploaded files as images if possible
                    const embedFile = async (file, title) => {
                        if (!file) return;

                        doc.addPage();
                        yPos = margin;

                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Attachment: ${title}`, margin, yPos);
                        yPos += 8;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.text(`File: ${file.name}`, margin, yPos);
                        yPos += 10;

                        // If it's an image, embed it
                        if (file.type.startsWith('image/')) {
                            try {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imgData = e.target.result;
                                    const imgFormat = file.type.includes('png') ? 'PNG' : 'JPEG';
                                    // Calculate dimensions to fit page
                                    const maxWidth = pageWidth - 2*margin;
                                    const maxHeight = pageHeight - yPos - 30;
                                    doc.addImage(imgData, imgFormat, margin, yPos, maxWidth, maxHeight);
                                };
                                reader.readAsDataURL(file);
                            } catch (err) {
                                doc.text('(Image could not be embedded - see attached file)', margin, yPos);
                            }
                        } else {
                            doc.text('(See attached PDF file)', margin, yPos);
                        }
                    };

                    // Handle P&ID file
                    if (pidFile && !returnBlob) {
                        doc.addPage();
                        yPos = margin;
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Attachment: P&ID Drawing', margin, yPos);
                        yPos += 8;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.text(`File: ${pidFile.name}`, margin, yPos);
                        yPos += 6;
                        doc.setFontSize(9);
                        doc.setTextColor(100, 100, 100);
                        doc.text('(See attached file - PDF attachments require manual inclusion)', margin, yPos);
                        doc.setTextColor(0, 0, 0);
                    }

                    // Handle miscellaneous file
                    if (miscFile && !returnBlob) {
                        doc.addPage();
                        yPos = margin;
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Attachment: Supporting Documentation', margin, yPos);
                        yPos += 8;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.text(`File: ${miscFile.name}`, margin, yPos);
                        yPos += 6;
                        doc.setFontSize(9);
                        doc.setTextColor(100, 100, 100);
                        doc.text('(See attached file - PDF attachments require manual inclusion)', margin, yPos);
                        doc.setTextColor(0, 0, 0);
                    }

                    // Add footer to all pages
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(7);
                        doc.setTextColor(128, 128, 128);
                        doc.setFont('helvetica', 'normal');

                        doc.setDrawColor(200, 200, 200);
                        doc.line(margin, pageHeight - 12, pageWidth - margin, pageHeight - 12);

                        if (i > 1) {
                            doc.text(`${deviceInfo.tag || 'PSV'} | Rev. ${reportInfo.revision}`, margin, pageHeight - 8);
                            doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
                            doc.text('Franc Engineering', pageWidth - margin, pageHeight - 8, { align: 'right' });
                        }
                    }

                    // Save the PDF
                    const filename = `${deviceInfo.tag || 'PSV'}_Deliverable_Rev${reportInfo.revision}_${new Date().toISOString().split('T')[0]}.pdf`;
                    if (returnBlob) {
    return doc.output('blob');
}
doc.save(filename);

                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('Error generating PDF: ' + error.message);
                }
            };
// Generate Report using Backend API (with proper PDF attachments)
            const generateReportWithBackend = async () => {
                if (!results) {
                    alert('No results to generate report. Please complete calculations first.');
                    return;
                }

                const btn = document.querySelector('[data-generate-btn]');
                const originalText = btn ? btn.textContent : '';
                
                try {
                    if (btn) {
                        btn.disabled = true;
                        btn.textContent = 'Generating...';
                    }

                    // Check for email (one free report per email)
                    let userEmail = localStorage.getItem('psv_user_email');
                    if (!userEmail) {
                        userEmail = prompt('Enter your email to generate your FREE report:');
                        if (!userEmail || !userEmail.includes('@')) {
                            alert('Valid email required to generate report.');
                            if (btn) {
                                btn.disabled = false;
                                btn.textContent = originalText;
                            }
                            return;
                        }
                        localStorage.setItem('psv_user_email', userEmail);
                    }

                    // Check if user has already used free report
                    const checkResponse = await fetch(`${API_BASE}/check-free-report?email=${encodeURIComponent(userEmail)}`);
                    const checkData = await checkResponse.json();

                    if (!checkData.can_generate_free) {
                        const proceed = confirm('You have already used your free report. Would you like to purchase another report for $99?');
                        if (proceed) {
                            initiateCheckout('standard_report');
                        }
                        return;
                    }

                    // Check if we have attachments to merge
                    const hasAttachments = pidFile || miscFile;
                    
                    if (!hasAttachments) {
                        // No attachments - just generate locally and download
                        console.log('No attachments - generating local PDF');
                        generateReport();
                        trackReportGeneration();
                        alert('Report generated successfully!');
                        return;
                    }

                    // We have attachments - need to use backend merge
                    console.log('Attachments found - using backend merge');
                    
                    if (btn) btn.textContent = 'Generating PDF...';

                    // Step 1: Generate the PDF locally as a blob
                    const pdfBlob = generateReport(true);
                    
                    if (!pdfBlob) {
                        throw new Error('Failed to generate PDF locally');
                    }

                    if (btn) btn.textContent = 'Uploading attachments...';

                    // Step 2: Upload P&ID file if present
                    let pidFileId = null;
                    if (pidFile) {
                        const formData = new FormData();
                        formData.append('file', pidFile);
                        const uploadResponse = await fetch(`${API_BASE}/upload-file`, {
                            method: 'POST',
                            body: formData
                        });
                        if (!uploadResponse.ok) {
                            throw new Error('Failed to upload P&ID file');
                        }
                        const uploadData = await uploadResponse.json();
                        pidFileId = uploadData.file_id;
                        console.log('P&ID uploaded:', pidFileId);
                    }

                    // Step 3: Upload misc file if present
                    let miscFileId = null;
                    if (miscFile) {
                        const formData = new FormData();
                        formData.append('file', miscFile);
                        const uploadResponse = await fetch(`${API_BASE}/upload-file`, {
                            method: 'POST',
                            body: formData
                        });
                        if (!uploadResponse.ok) {
                            throw new Error('Failed to upload misc file');
                        }
                        const uploadData = await uploadResponse.json();
                        miscFileId = uploadData.file_id;
                        console.log('Misc file uploaded:', miscFileId);
                    }

                    if (btn) btn.textContent = 'Merging PDFs...';

                    // Step 4: Send to backend for merging
                    const mergeFormData = new FormData();
                    mergeFormData.append('main_pdf', pdfBlob, 'report.pdf');
                    if (pidFileId) mergeFormData.append('pid_file_id', pidFileId);
                    if (miscFileId) mergeFormData.append('misc_file_id', miscFileId);
                    mergeFormData.append('device_tag', deviceInfo.tag || 'PSV');
                    mergeFormData.append('email', userEmail);

                    const mergeResponse = await fetch(`${API_BASE}/merge-pdfs`, {
                        method: 'POST',
                        body: mergeFormData
                    });

                    if (!mergeResponse.ok) {
                        const errorText = await mergeResponse.text();
                        throw new Error(`Merge failed: ${errorText}`);
                    }

                    // Step 5: Download the merged PDF
                    const mergedPdfBlob = await mergeResponse.blob();
                    const url = window.URL.createObjectURL(mergedPdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${deviceInfo.tag || 'PSV'}_Deliverable_Rev${reportInfo.revision || 'A'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    // Track that user has used their free report
                    trackReportGeneration();
                    alert('Report generated successfully!');

                } catch (error) {
                    console.error('Report generation error:', error);
                    alert(`Error generating report: ${error.message}\n\nFalling back to local generation...`);
                    // Fallback to local generation (without attachments)
                    generateReport();
                } finally {
                    const btn = document.querySelector('[data-generate-btn]');
                    if (btn) {
                        btn.textContent = 'Generate FREE Report';
                        btn.disabled = false;
                    }
                }
            };
            // Check if all applicable scenarios have valid compositions (>=99%)
            const allCompositionsValid = calculableScenarios.every(s => getTotalMol(s.id) >= 99);

            // Updated step order: Device -> Scenario -> Fluid -> Calcs -> Results
            const STEP_LABELS = ['Start', 'Device', 'Scenario', 'Fluid', 'Calcs', 'Results'];

            return (
                <div className={`max-w-4xl mx-auto p-4 sm:p-6 ${darkMode ? 'dark-mode' : ''}`}>
                    {/* Header */}
                    <div className="flex justify-between items-start mb-8">
                        <div>
                            <h1 className={`text-2xl sm:text-3xl font-bold ${darkMode ? 'text-blue-400' : 'franc-blue'} mb-2`}>PSV Sizing Calculator</h1>
                            <p className={darkMode ? 'text-gray-300' : 'text-gray-600'}>Pressure Safety Valve Sizing per API 520/521</p>
                            <p className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Franc Engineering | franceng.com</p>
                        </div>
                        <div className="flex items-start gap-3">
                            {/* Dark Mode Toggle */}
                            <button
                                onClick={() => setDarkMode(!darkMode)}
                                className={`p-2 rounded-lg transition ${darkMode ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                            >
                                {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
                            </button>
                            {/* Clear All Button */}
                            <button
                                onClick={() => {
                                    if (window.confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                                        localStorage.removeItem('psv_calculator_state');
                                        window.location.reload();
                                    }
                                }}
                                className={`p-2 rounded-lg transition ${darkMode ? 'bg-gray-700 text-red-400 hover:bg-gray-600' : 'bg-gray-100 text-red-600 hover:bg-gray-200'}`}
                                title="Clear All Data"
                            >
                                ðŸ—‘ï¸
                            </button>
                            {/* Device Info - Upper Right */}
                            {step > 1 && (deviceInfo.tag || deviceInfo.pid_number || deviceInfo.facility_name) && (
                            <div className={`text-right text-sm rounded-lg p-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                {deviceInfo.tag && (
                                    <div><span className="text-gray-500">Relief Device Tag:</span> <span className="font-semibold">{deviceInfo.tag}</span></div>
                                )}
                                {deviceInfo.pid_number && (
                                    <div><span className="text-gray-500">P&ID Number:</span> <span className="font-semibold">{deviceInfo.pid_number}</span></div>
                                )}
                                {deviceInfo.facility_name && (
                                    <div><span className="text-gray-500">Facility:</span> <span className="font-semibold">{deviceInfo.facility_name}</span></div>
                                )}
                            </div>
                            )}
                        </div>
                    </div>

                    {/* Progress Steps */}
                    <div className="flex justify-center mb-6">
                        <div className="flex items-center space-x-1 sm:space-x-2">
                            {[0, 1, 2, 3, 4, 5].map((s) => (
                                <React.Fragment key={s}>
                                    <div
                                        className={`step-indicator w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center font-semibold cursor-pointer text-sm sm:text-base
                                            ${step >= s ? 'franc-accent-bg text-white' : 'bg-gray-200 text-gray-500'}
                                            ${step === s ? 'active ring-4 ring-blue-200' : ''}`}
                                        onClick={() => (s < step || (step === 0 && s === 1)) && setStep(s)}
                                    >
                                        {s}
                                    </div>
                                    {s < 5 && <div className={`w-4 sm:w-8 h-1 ${step > s ? 'franc-accent-bg' : 'bg-gray-200'}`}></div>}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    {/* Step Labels */}
                    <div className="flex justify-between mb-8 text-xs sm:text-sm text-gray-500 px-2">
                        {STEP_LABELS.map((label, idx) => (
    <span 
        key={label} 
        className={`cursor-pointer hover:text-blue-500 transition ${step === idx + 1 ? 'font-semibold franc-accent' : ''}`}
        onClick={() => (idx + 1) < step && setStep(idx + 1)}
    >
        {label}
    </span>
))}
                    </div>
{/* Example Report Preview - Show on Step 0  */}
                    {step === 0 && (
                        <div className={`mb-8 rounded-xl shadow-lg p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <div className="text-center mb-6">
                                <h2 className={`text-2xl font-bold mb-3 ${darkMode ? 'text-blue-400' : 'franc-blue'}`}>
                                    ðŸ“„ See What You'll Get
                                </h2>
                                <p className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                    Professional PSV sizing reports with comprehensive calculations, scenario analysis, and complete documentation.
                                </p>
                                <div className="flex justify-center gap-4 mb-6">
                                    <a 
                                        href={`${API_BASE}/static/example-report.pdf`}
                                        download="PSV_Example_Report.pdf"
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                    >
                                        â¬‡ï¸ Download Example
                                    </a>
                                    <button 
                                        onClick={() => setStep(1)}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"
                                    >
                                        Get Started â†’
                                    </button>
                                </div>
                            </div>
                            <iframe
                                src={`${API_BASE}/static/example-report.pdf`}
                                className="w-full h-[700px] rounded-lg border"
                                title="Example PSV Report"
                            />
                        </div>
                    )}
                    {/* Step 1: Device Info */}
                    {step === 1 && (
                        <div className="fade-in bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-semibold mb-4">Relief Device Information</h2>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                {/* Relief Device Tag */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Relief Device Tag</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.tag}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, tag: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="PSV-123"
                                    />
                                </div>

                                {/* P&ID Number */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">P&ID Number</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.pid_number}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, pid_number: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="PID-001"
                                    />
                                </div>

                                {/* Facility Name */}
                                <div className="sm:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Facility Name</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.facility_name}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, facility_name: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="Enter facility name"
                                    />
                                </div>

                                {/* Protected System */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Protected System</label>
                                    <input
                                        type="text"
                                        value={deviceInfo.protected_system}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, protected_system: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="Absorber V-123"
                                    />
                                </div>

                                {/* Protected MAWP */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Protected System MAWP (psig)</label>
                                    <input
                                        type="number"
                                        value={deviceInfo.mawp}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, mawp: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="285"
                                    />
                                </div>

                                {/* Relief Device Selection (API Sizes) */}
                                <div className="sm:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Relief Device Selection (API Sizes)</label>
                                    <select
                                        value={deviceInfo.selected_orifice}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, selected_orifice: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="">-- Calculate Required Size --</option>
                                        {ORIFICES.map((o, idx) => (
                                            <option key={`${o.letter}-${o.size}-${idx}`} value={o.size}>
                                                {o.size} â€” Orifice {o.letter} ({o.area} inÂ²) â€” Inlet: {o.inlet}, Outlet: {o.outlet}
                                            </option>
                                        ))}
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">Leave blank to calculate required orifice size</p>
                                </div>

                                {/* New or Existing */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">New or Existing</label>
                                    <select
                                        value={deviceInfo.new_or_existing}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, new_or_existing: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="new">New Installation</option>
                                        <option value="existing">Existing Device</option>
                                    </select>
                                </div>

                                {/* Discharge Location */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Discharge Location</label>
                                    <select
                                        value={deviceInfo.discharge_location}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, discharge_location: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="atmosphere">Atmosphere</option>
                                        <option value="flare">Flare</option>
                                        <option value="process">Process</option>
                                    </select>
                                </div>

                                {/* PSV Set Pressure */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">PSV Set Pressure (psig)</label>
                                    <input
                                        type="number"
                                        value={deviceInfo.set_pressure}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, set_pressure: e.target.value})}
                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                        placeholder="285"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Typically equal to or less than MAWP</p>
                                </div>

                                {/* PSV Type */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">PSV Type</label>
                                    <select
                                        value={deviceInfo.psv_type}
                                        onChange={(e) => setDeviceInfo({...deviceInfo, psv_type: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="conventional">CONVENTIONAL</option>
                                        <option value="balanced">BALANCED</option>
                                        <option value="pilot_modulating">PILOT (MODULATING)</option>
                                        <option value="pilot_pop">PILOT (POP-ACTING)</option>
                                    </select>
                                </div>

                                {/* P&ID Upload */}
                                <FileUpload
                                    label="P&ID Upload (PDF)"
                                    accept=".pdf"
                                    file={pidFile}
                                    onFileChange={setPidFile}
                                />

                                {/* Miscellaneous */}
                                <FileUpload
                                    label="Miscellaneous"
                                    accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"
                                    file={miscFile}
                                    onFileChange={setMiscFile}
                                />
                            </div>

                            {/* Collapsible Project & Report Details */}
                            <div className="mt-6 border-t pt-4">
                                <button
                                    type="button"
                                    onClick={() => setDeviceInfo({...deviceInfo, showProjectDetails: !deviceInfo.showProjectDetails})}
                                    className="flex items-center justify-between w-full text-left"
                                >
                                    <span className="text-sm font-medium text-gray-700">Project & Report Details (for Deliverable)</span>
                                    <span className="text-gray-500">{deviceInfo.showProjectDetails ? 'â–¼' : 'â–¶'}</span>
                                </button>

                                {deviceInfo.showProjectDetails && (
                                <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                                    {/* Client */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Client</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.client}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, client: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="Client Name, LP"
                                        />
                                    </div>

                                    {/* Plant */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Plant</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.plant}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, plant: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="Plant Name"
                                        />
                                    </div>

                                    {/* Project */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Project</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.project}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, project: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="Project Name"
                                        />
                                    </div>

                                    {/* Project No */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Project No.</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.project_no}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, project_no: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="12345"
                                        />
                                    </div>

                                    <div className="sm:col-span-2 border-t pt-4 mt-2">
                                        <p className="text-xs text-gray-500 mb-3">Relief Device Details</p>
                                    </div>

                                    {/* Manufacturer */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Manufacturer</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.manufacturer}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, manufacturer: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="FARRIS"
                                        />
                                    </div>

                                    {/* Model Number */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Model Number</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.model_number}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, model_number: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="26FA10-120"
                                        />
                                    </div>

                                    {/* Serial Number */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                                        <input
                                            type="text"
                                            value={deviceInfo.serial_number}
                                            onChange={(e) => setDeviceInfo({...deviceInfo, serial_number: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="629969-1-10"
                                        />
                                    </div>

                                    <div className="sm:col-span-2 border-t pt-4 mt-2">
                                        <p className="text-xs text-gray-500 mb-3">Piping Details</p>
                                    </div>

                                    {/* Inlet Pipe */}
                                    <div className="grid grid-cols-3 gap-2">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Inlet Size (NPS)</label>
                                            <input
                                                type="text"
                                                value={deviceInfo.inlet_pipe_size}
                                                onChange={(e) => setDeviceInfo({...deviceInfo, inlet_pipe_size: e.target.value})}
                                                className="input-field w-full px-2 py-1.5 border rounded-lg focus:outline-none text-sm"
                                                placeholder="1 1/2&quot;"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Schedule</label>
                                            <select
                                                value={deviceInfo.inlet_pipe_schedule}
                                                onChange={(e) => setDeviceInfo({...deviceInfo, inlet_pipe_schedule: e.target.value})}
                                                className="w-full px-2 py-1.5 border rounded-lg bg-white focus:outline-none text-sm"
                                            >
                                                <option value="STD">STD</option>
                                                <option value="XS">XS</option>
                                                <option value="XXS">XXS</option>
                                                <option value="SCH 40">SCH 40</option>
                                                <option value="SCH 80">SCH 80</option>
                                                <option value="SCH 160">SCH 160</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Rating</label>
                                            <select
                                                value={deviceInfo.inlet_connection_rating}
                                                onChange={(e) => setDeviceInfo({...deviceInfo, inlet_connection_rating: e.target.value})}
                                                className="w-full px-2 py-1.5 border rounded-lg bg-white focus:outline-none text-sm"
                                            >
                                                <option value="CL 150">CL 150</option>
                                                <option value="CL 300">CL 300</option>
                                                <option value="CL 600">CL 600</option>
                                                <option value="CL 900">CL 900</option>
                                                <option value="CL 1500">CL 1500</option>
                                            </select>
                                        </div>
                                    </div>

                                    {/* Outlet Pipe */}
                                    <div className="grid grid-cols-3 gap-2">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Outlet Size (NPS)</label>
                                            <input
                                                type="text"
                                                value={deviceInfo.outlet_pipe_size}
                                                onChange={(e) => setDeviceInfo({...deviceInfo, outlet_pipe_size: e.target.value})}
                                                className="input-field w-full px-2 py-1.5 border rounded-lg focus:outline-none text-sm"
                                                placeholder="2&quot;"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Schedule</label>
                                            <select
                                                value={deviceInfo.outlet_pipe_schedule}
                                                onChange={(e) => setDeviceInfo({...deviceInfo, outlet_pipe_schedule: e.target.value})}
                                                className="w-full px-2 py-1.5 border rounded-lg bg-white focus:outline-none text-sm"
                                            >
                                                <option value="STD">STD</option>
                                                <option value="XS">XS</option>
                                                <option value="XXS">XXS</option>
                                                <option value="SCH 40">SCH 40</option>
                                                <option value="SCH 80">SCH 80</option>
                                                <option value="SCH 160">SCH 160</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Rating</label>
                                            <select
                                                value={deviceInfo.outlet_connection_rating}
                                                onChange={(e) => setDeviceInfo({...deviceInfo, outlet_connection_rating: e.target.value})}
                                                className="w-full px-2 py-1.5 border rounded-lg bg-white focus:outline-none text-sm"
                                            >
                                                <option value="CL 150">CL 150</option>
                                                <option value="CL 300">CL 300</option>
                                                <option value="CL 600">CL 600</option>
                                                <option value="CL 900">CL 900</option>
                                                <option value="CL 1500">CL 1500</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="sm:col-span-2 border-t pt-4 mt-2">
                                        <p className="text-xs text-gray-500 mb-3">Report Information</p>
                                    </div>

                                    {/* Engineered By */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Engineered By</label>
                                        <input
                                            type="text"
                                            value={reportInfo.engineered_by}
                                            onChange={(e) => setReportInfo({...reportInfo, engineered_by: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="Engineer Initials"
                                        />
                                    </div>

                                    {/* Checked By */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Checked By</label>
                                        <input
                                            type="text"
                                            value={reportInfo.checked_by}
                                            onChange={(e) => setReportInfo({...reportInfo, checked_by: e.target.value})}
                                            className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                            placeholder="Checker Initials"
                                        />
                                    </div>

                                    {/* Revision */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Revision</label>
                                        <select
                                            value={reportInfo.revision}
                                            onChange={(e) => setReportInfo({...reportInfo, revision: e.target.value})}
                                            className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none"
                                        >
                                            <option value="A">A - Issued for Review</option>
                                            <option value="B">B</option>
                                            <option value="C">C</option>
                                            <option value="0">0 - Issued for Construction</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                        </select>
                                    </div>
                                </div>
                                )}
                            </div>

                            <div className="flex justify-end mt-6">
                                <button
                                    onClick={() => setStep(2)}
                                    className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 transition"
                                >
                                    Next: Scenario â†’
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Step 2: Scenario Identification */}
                    {step === 2 && (
                        <div className="fade-in bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-semibold mb-2">Potential Relieving Scenario Identification</h2>
                            <p className="text-sm text-gray-600 mb-6">Check "Applicable" for scenarios that require calculation. Add notes to document your justification.</p>

                            <div className="space-y-4">
                                {SCENARIOS.map((s) => {
                                    // Auto-fill notes for hydraulic thermal expansion
                                    const getDefaultNotes = () => {
                                        if (s.id !== 'hydraulic_thermal') return '';
                                        if (!scenarioSelections[s.id]?.applicable) {
                                            return 'The system is not expected to operate liquid-full or has a different applicable scenario.';
                                        }
                                        return `Per API 521 4.4.12.2, the required relieving rate due to thermal expansion is minimal and difficult to calculate. Because of this, the required relieving rate is generally not calculated when the protected system meets one of the criteria described below, as detailed in API 521 4.4.12.3:

1. The protected system consists of long, aboveground, uninsulated pipelines of large diameter.
2. The protected system includes large vessels or exchangers operating liquid full.

Because the two cases above do not apply, a detailed analysis has not been performed.`;
                                    };

                                    const currentNotes = scenarioSelections[s.id]?.notes;
                                    const displayNotes = s.id === 'hydraulic_thermal' && !currentNotes ? getDefaultNotes() : currentNotes;

                                    return (
                                    <div
                                        key={s.id}
                                        className={`p-4 border-2 rounded-xl ${scenarioSelections[s.id]?.applicable ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-center space-x-3">
                                                <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">{s.label}</span>
                                                <span className="text-2xl">{s.icon}</span>
                                                <div>
                                                    <h3 className="font-semibold text-gray-900">{s.name}</h3>
                                                    <p className="text-sm text-gray-500">{s.desc}</p>
                                                    {s.noCalc && <span className="inline-block mt-1 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded">No Calculation Required</span>}
                                                </div>
                                            </div>
                                            <label className="flex items-center space-x-2 cursor-pointer">
                                                <span className={`text-sm font-medium ${scenarioSelections[s.id]?.applicable ? 'text-green-600' : 'text-gray-400'}`}>
                                                    Applicable: {scenarioSelections[s.id]?.applicable ? 'YES' : 'NO'}
                                                </span>
                                                <input
                                                    type="checkbox"
                                                    checked={scenarioSelections[s.id]?.applicable || false}
                                                    onChange={(e) => {
                                                        const newApplicable = e.target.checked;
                                                        setScenarioSelections(prev => ({
                                                            ...prev,
                                                            [s.id]: {
                                                                ...prev[s.id],
                                                                applicable: newApplicable,
                                                                // Auto-fill notes for hydraulic thermal
                                                                notes: s.id === 'hydraulic_thermal' ? '' : prev[s.id]?.notes
                                                            }
                                                        }));
                                                    }}
                                                    className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                />
                                            </label>
                                        </div>
                                        <div className="mt-3">
                                            <textarea
                                                value={displayNotes || ''}
                                                onChange={(e) => setScenarioSelections(prev => ({
                                                    ...prev,
                                                    [s.id]: { ...prev[s.id], notes: e.target.value }
                                                }))}
                                                className={`w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:border-blue-500 resize-none ${s.id === 'hydraulic_thermal' ? 'bg-gray-50' : ''}`}
                                                rows={s.id === 'hydraulic_thermal' ? 4 : 2}
                                                placeholder="Notes / Justification (e.g., 'The system is not expected to operate with a liquid level.')"
                                            />
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>

                            <div className="flex justify-between mt-6">
                                <button onClick={() => setStep(1)} className="px-6 py-2 border rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Back
                                </button>
                                <button
                                    onClick={() => {
                                        // Set the first applicable scenario as the active one for calculation
                                        const firstApplicable = Object.entries(scenarioSelections).find(([id, sel]) => sel.applicable);
                                        if (firstApplicable) setScenario(firstApplicable[0]);
                                        setStep(3);
                                    }}
                                    disabled={!Object.values(scenarioSelections).some(s => s.applicable)}
                                    className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                >
                                    Next: Fluid â†’
                                </button>
                            </div>
                            {!Object.values(scenarioSelections).some(s => s.applicable) && (
                                <p className="text-sm text-red-500 mt-2 text-right">Please select at least one applicable scenario</p>
                            )}
                        </div>
                    )}

                    {/* Step 3: Fluid Selection */}
                    {step === 3 && (
                        <div className="fade-in bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-semibold mb-2">Select Fluid Compositions</h2>
                            <p className="text-sm text-gray-600 mb-6">
                                Enter composition for each applicable scenario.
                                {calculableScenarios.length > 1 && " Use 'Copy from first' to duplicate the first composition."}
                            </p>

                            {/* Scenario Composition Sections */}
                            <div className="space-y-6">
                                {calculableScenarios.map((scenarioItem, idx) => {
                                    const scenarioComp = compositions[scenarioItem.id] || {};
                                    const scenarioTotal = getTotalMol(scenarioItem.id);
                                    const isFirst = idx === 0;
                                    const firstScenarioId = calculableScenarios[0]?.id;

                                    return (
                                        <div key={scenarioItem.id} className="border rounded-xl p-4">
                                            {/* Scenario Header */}
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-xl">{scenarioItem.icon}</span>
                                                    <h3 className="font-semibold text-gray-900">{scenarioItem.compLabel}</h3>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    {!isFirst && (
                                                        <button
                                                            onClick={() => copyCompositionFrom(firstScenarioId, scenarioItem.id)}
                                                            className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition"
                                                        >
                                                            Copy from first
                                                        </button>
                                                    )}
                                                    <span className={`text-sm font-medium ${Math.abs(scenarioTotal - 100) < 0.1 ? 'text-green-600' : 'text-red-500'}`}>
                                                        Total: {scenarioTotal.toFixed(1)}%
                                                    </span>
                                                </div>
                                            </div>

                                            {/* Quick Presets for this scenario */}
                                            <div className="mb-4">
                                                <label className="text-xs text-gray-500 mb-1 block">Quick Select:</label>
                                                <div className="flex gap-2">
                                                    {scenarioItem.presets.map((presetId) => (
                                                        <button
                                                            key={presetId}
                                                            className="px-3 py-1.5 rounded text-sm font-medium transition bg-gray-100 hover:bg-gray-200 text-gray-700"
                                                            onClick={() => handlePresetChange(presetId, scenarioItem.id)}
                                                        >
                                                            {PRESETS[presetId]?.name}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Composition Grid - Left: Hydrocarbons, Right: Inerts/Other */}
                                            <div className="flex gap-8">
                                                {/* Left Column - Hydrocarbons */}
                                                <div className="flex-1 space-y-1">
                                                    {['methane', 'ethane', 'propane', 'isobutane', 'nbutane', 'isopentane', 'npentane', 'nhexane', 'nheptane', 'noctane', 'nnonane', 'ndecane'].map((compId) => {
                                                        const comp = COMPONENTS[compId];
                                                        return (
                                                            <div key={compId} className="flex items-center justify-between py-1 border-b border-gray-100">
                                                                <label className="text-sm text-gray-700">{comp.name} ({comp.formula})</label>
                                                                <input
                                                                    type="number"
                                                                    min="0"
                                                                    max="100"
                                                                    step="0.1"
                                                                    value={scenarioComp[compId] || ''}
                                                                    onChange={(e) => handleCompChange(scenarioItem.id, compId, e.target.value)}
                                                                    className="input-field w-20 px-2 py-1 border rounded text-sm text-right focus:outline-none"
                                                                    placeholder="0"
                                                                />
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                {/* Right Column - Inerts/Other */}
                                                <div className="flex-1 space-y-1">
                                                    {['nitrogen', 'oxygen', 'co2', 'water', 'h2s'].map((compId) => {
                                                        const comp = COMPONENTS[compId];
                                                        return (
                                                            <div key={compId} className="flex items-center justify-between py-1 border-b border-gray-100">
                                                                <label className="text-sm text-gray-700">{comp.name} ({comp.formula})</label>
                                                                <input
                                                                    type="number"
                                                                    min="0"
                                                                    max="100"
                                                                    step="0.1"
                                                                    value={scenarioComp[compId] || ''}
                                                                    onChange={(e) => handleCompChange(scenarioItem.id, compId, e.target.value)}
                                                                    className="input-field w-20 px-2 py-1 border rounded text-sm text-right focus:outline-none"
                                                                    placeholder="0"
                                                                />
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="flex justify-between mt-6">
                                <button onClick={() => setStep(2)} className="px-6 py-2 border rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Back
                                </button>
                                <button
                                    onClick={() => setStep(4)}
                                    disabled={!allCompositionsValid}
                                    className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                >
                                    Next: Calcs â†’
                                </button>
                            </div>
                            {!allCompositionsValid && (
                                <p className="text-sm text-red-500 mt-2 text-right">All compositions must total at least 99%</p>
                            )}
                        </div>
                    )}

                    {/* Step 4: Operating Conditions - Scenario Specific with Tabs */}
                    {step === 4 && (() => {
                        // Set active tab to first calculable scenario if not set
                        if (!activeConditionsTab || !scenarioSelections[activeConditionsTab]?.applicable || SCENARIOS.find(s => s.id === activeConditionsTab)?.noCalc) {
                            const firstCalculable = calculableScenarios[0];
                            if (firstCalculable && activeConditionsTab !== firstCalculable.id) {
                                setTimeout(() => setActiveConditionsTab(firstCalculable.id), 0);
                            }
                        }
                        return (
                        <div className="fade-in space-y-6">
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-2">Required Relieving Rate Calculation</h2>
                                <p className="text-sm text-gray-600 mb-4">Enter conditions for each applicable scenario. Green fields are inputs, blue fields are calculated outputs.</p>

                                {/* Scenario Tabs */}
                                {calculableScenarios.length > 1 && (
                                    <div className="flex border-b border-gray-200">
                                        {calculableScenarios.map((s) => (
                                            <button
                                                key={s.id}
                                                onClick={() => setActiveConditionsTab(s.id)}
                                                className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                                                    activeConditionsTab === s.id
                                                        ? 'border-blue-500 text-blue-600'
                                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                                }`}
                                            >
                                                {s.name}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Fire-Unwetted (1B) Section */}
                            {(activeConditionsTab === 'fire_unwetted' || (calculableScenarios.length === 1 && scenarioSelections.fire_unwetted?.applicable)) && (() => {
                                const comp = compositions.fire_unwetted || {};
                                const cond = scenarioConditions.fire_unwetted;
                                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                                const p1_psia = setP * (1 + FIRE_OVERPRESSURE) + AMBIENT_PRESSURE;
                                const p1_psig = setP * (1 + FIRE_OVERPRESSURE);
                                const M = getMolecularWeight(comp);
                                const Pcrit = getCriticalPressure(comp);
                                const T1 = calcRelievingTemp(p1_psia, cond.normal_op_pressure, cond.normal_op_temp);
                                // Calculate surface areas from vessel geometry (force 0% liquid for fire unwetted)
                                const vesselAreas = calcVesselAreas({ ...vesselDetails, max_liquid_level: 0 });
                                const unwettedArea = vesselAreas.adjustedUnwetted;
                                const qRelief = calcFireUnwettedReliefLoad(M, p1_psia, unwettedArea, MAX_WALL_TEMP, T1);
                                const qVol = calcVolumetricRate(qRelief, M, T1, p1_psia);

                                // Calculate required area using API 520 vapor equation
                                // A = W * sqrt(T*Z) / (C * Kd * P1 * Kb * sqrt(M))
                                const Kd = 0.975; // Coefficient of discharge for vapor
                                const Kb = 1.0; // Back pressure correction (assume atmospheric discharge)
                                const Kc = 1.0; // Combination correction factor (no rupture disk)
                                const T1_R = T1 + 459.67;
                                const Z = 1.0; // Simplified compressibility
                                const k = getSpecificHeatRatio(comp); // Calculate k from composition
                                const C = getAPI520_C(k); // API 520 C coefficient
                                const requiredArea = qRelief > 0 && M > 0 && p1_psia > 0
                                    ? (qRelief * Math.sqrt(T1_R * Z)) / (C * Kd * p1_psia * Kb * Kc * Math.sqrt(M))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrificeSize = deviceInfo.selected_orifice;
                                const selectedOrifice = ORIFICES.find(o => o.size === selectedOrificeSize);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                                // Calculate rated relief load (reverse of area calc)
                                const ratedReliefLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                                    ? (ratedArea * C * Kd * p1_psia * Kb * Kc * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                    <div className="bg-white rounded-xl shadow-lg p-6">
                                        <div className="flex items-center space-x-3 mb-4">
                                            <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">1B</span>
                                            <span className="text-xl">ðŸ’¨</span>
                                            <h3 className="text-lg font-semibold">Fire Unwetted (Vapor) - API 521 6th Ed. 4.4.13.2.4.3</h3>
                                        </div>

                                        {/* Relief Device Sizing Summary - AT TOP */}
                                        <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{qRelief > 0 ? qRelief.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(2) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {ratedArea > 0 && requiredArea > 0 && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-sm text-gray-600">Sizing %</span>
                                                        <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                            {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                            {!selectedOrifice && (
                                                <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                            )}
                                        </div>

                                        <p className="text-xs text-gray-500 mb-4">
                                            This method applies for above-grade pressure vessels with design pressures exceeding 15 psig.
                                            Unwetted wall vessels are those where internal walls are exposed to gas/vapor.
                                        </p>

                                        {/* Operating Conditions Inputs */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-green-800 mb-3">Operating Conditions (Inputs)</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Pressure (P<sub>n</sub>)</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_pressure}
                                                            onChange={(e) => updateScenarioCondition('fire_unwetted', 'normal_op_pressure', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">psig</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Temperature (T<sub>n</sub>)</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_temp}
                                                            onChange={(e) => updateScenarioCondition('fire_unwetted', 'normal_op_temp', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">Â°F</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Vessel Details with Diagram */}
                                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                            <h4 className="font-medium text-gray-700 mb-4">Vessel Details</h4>
                                            <div className="flex gap-6">
                                                {/* Left: Vessel Inputs */}
                                                <div className="flex-1 space-y-3">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Equipment Tag</span>
                                                        <input type="text" value={vesselDetails.equipment_tag}
                                                            onChange={(e) => updateVesselDetail('equipment_tag', e.target.value)}
                                                            placeholder="V-123"
                                                            className="w-28 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Orientation</span>
                                                        <select value={vesselDetails.orientation}
                                                            onChange={(e) => updateVesselDetail('orientation', e.target.value)}
                                                            className="w-28 px-2 py-1.5 bg-green-50 border border-green-300 rounded text-sm focus:outline-none focus:border-green-500">
                                                            <option value="horizontal">Horizontal</option>
                                                            <option value="vertical">Vertical</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Head Type</span>
                                                        <select value={vesselDetails.head_type}
                                                            onChange={(e) => updateVesselDetail('head_type', e.target.value)}
                                                            className="w-36 px-2 py-1.5 bg-green-50 border border-green-300 rounded text-sm focus:outline-none focus:border-green-500">
                                                            <option value="2:1_elliptical">2:1 ELLIPTICAL</option>
                                                            <option value="flat">FLAT</option>
                                                            <option value="hemispherical">HEMISPHERICAL</option>
                                                            <option value="none">NONE</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Inner Diameter (ID)</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.inner_diameter}
                                                                onChange={(e) => updateVesselDetail('inner_diameter', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">in</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Seam-to-Seam Length</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.seam_to_seam}
                                                                onChange={(e) => updateVesselDetail('seam_to_seam', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ft</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Height Above Grade</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.height_above_grade}
                                                                onChange={(e) => updateVesselDetail('height_above_grade', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ft</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Max Liquid Operating Level</span>
                                                        <div className="flex items-center space-x-1">
                                                            <span className="text-sm font-medium text-gray-900 w-20 text-right">0</span>
                                                            <span className="text-xs text-gray-500">%</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Additional Area (+/-)</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.additional_area}
                                                                onChange={(e) => updateVesselDetail('additional_area', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">%</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Right: Vessel Diagram and Results */}
                                                <div className="w-64 flex flex-col">
                                                    {/* Vessel Diagram SVG */}
                                                    <div className="bg-white border border-gray-200 rounded-lg p-3 mb-3">
                                                        <svg viewBox="0 0 200 100" className="w-full h-24">
                                                            {vesselDetails.orientation === 'horizontal' ? (
                                                                <>
                                                                    {/* Horizontal vessel shell */}
                                                                    <rect x="40" y="20" width="120" height="60" fill="none" stroke="#374151" strokeWidth="2" rx="0"/>
                                                                    {/* Left head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="40" cy="50" rx="12" ry="30" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 40 20 A 30 30 0 0 0 40 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="40" y1="20" x2="40" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Right head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="160" cy="50" rx="12" ry="30" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 160 20 A 30 30 0 0 1 160 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="160" y1="20" x2="160" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Liquid level indication (for fire unwetted = empty) */}
                                                                    <text x="100" y="55" textAnchor="middle" className="text-xs" fill="#6b7280">Empty (Vapor)</text>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    {/* Vertical vessel shell */}
                                                                    <rect x="70" y="15" width="60" height="65" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    {/* Top head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="100" cy="15" rx="30" ry="10" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 70 15 A 30 30 0 0 1 130 15" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="70" y1="15" x2="130" y2="15" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Bottom head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="100" cy="80" rx="30" ry="10" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 70 80 A 30 30 0 0 0 130 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="70" y1="80" x2="130" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    <text x="100" y="50" textAnchor="middle" className="text-xs" fill="#6b7280">Empty</text>
                                                                </>
                                                            )}
                                                        </svg>
                                                    </div>

                                                    {/* Volume Results */}
                                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                                                        <div className="flex justify-between mb-2">
                                                            <span className="text-gray-600">Filled Volume</span>
                                                            <span className="font-medium">0 <span className="text-xs text-gray-500">US gal</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Total Volume</span>
                                                            <span className="font-medium">{vesselAreas.volume_gal > 0 ? vesselAreas.volume_gal.toFixed(1) : '-'} <span className="text-xs text-gray-500">US gal</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            {/* Relief Device Set Pressure - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relief Device Set Pressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{setP || '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            {/* Allowable Overpressure - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Allowable Overpressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">21%</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Relieving Pressure - Display (in psig) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Pressure (pâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{p1_psig > 0 ? p1_psig.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            {/* Critical Pressure - Display (from composition) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Critical Pressure (P<sub>CRIT</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{Pcrit > 0 ? Pcrit.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psia</span>
                                                </div>
                                            </div>

                                            {/* Vapor Molecular Weight - Display (from composition) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Vapor Molecular Weight (M)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{M > 0 ? M.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Maximum Wall Temperature - Display (fixed) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Maximum Wall Temperature (T<sub>W</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{MAX_WALL_TEMP.toLocaleString()}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            {/* Unwetted Surface Area from Vessel Geometry */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-blue-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Unwetted Surface Area (A')</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-blue-700 w-24 text-right">{unwettedArea > 0 ? unwettedArea.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">ftÂ²</span>
                                                </div>
                                            </div>

                                            {/* Relieving Temperature - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Temperature (Tâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{T1 > 0 ? T1.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            {/* Relief Load - Display (highlighted) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-red-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Relief Load (q<sub>m,relief</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-red-700 w-24 text-right">{qRelief > 0 ? qRelief.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">lb/hr</span>
                                                </div>
                                            </div>

                                            {/* Volumetric Relieving Rate - Display (highlighted) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-red-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Required Volumetric Relieving Rate</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-red-700 w-24 text-right">{qVol > 0 ? qVol.toFixed(3) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">MMscfd</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Fire-Wetted (1A) Section */}
                            {(activeConditionsTab === 'fire_wetted' || (calculableScenarios.length === 1 && scenarioSelections.fire_wetted?.applicable)) && (() => {
                                const comp = compositions.fire_wetted || {};
                                const cond = scenarioConditions.fire_wetted;
                                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                                const FIRE_WETTED_OVERPRESSURE = 0.21; // 21% for fire case
                                const p1_psia = setP * (1 + FIRE_WETTED_OVERPRESSURE) + AMBIENT_PRESSURE;
                                const p1_psig = setP * (1 + FIRE_WETTED_OVERPRESSURE);
                                const M = getMolecularWeight(comp);
                                const Pcrit = getCriticalPressure(comp);
                                const k = getSpecificHeatRatio(comp);
                                const C = getAPI520_C(k);

                                // Determine if single or multi-component
                                const compEntries = Object.entries(comp).filter(([_, val]) => val > 0);
                                const isMultiComponent = compEntries.length > 1;

                                // Calculate bubble point temperature using PR-EOS
                                const T_bubble = compEntries.length > 0 ? calcBubblePoint(comp, p1_psia) : cond.normal_op_temp;

                                // Heat absorption constant: checked = 21000, unchecked = 34500
                                const heatAbsorptionConstant = cond.prompt_firefighting ? 21000 : 34500;

                                // Environment factor F = 1.0 (uninsulated)
                                const F = 1.0;

                                // Calculate wetted surface area from vessel geometry
                                const wettedVesselAreas = calcVesselAreas({ ...vesselDetails, max_liquid_level: cond.liquid_level });
                                const wettedArea = wettedVesselAreas.wetted;
                                const filledVolume_gal = wettedVesselAreas.filledVolume_gal;

                                // Total heat absorption Q = C * F * A^0.82
                                const Q = heatAbsorptionConstant * F * Math.pow(wettedArea, 0.82);

                                // Calculate latent heat from composition (simple approach for now)
                                const latentHeat = getLatentHeat(comp);

                                // ========== STREAM A/B CALCULATIONS FOR MULTI-COMPONENT ==========
                                // Stream A: Liquid at bubble point (V = 0)
                                const massFlowBasis = 1000; // lb/hr basis
                                const molarFlowBasis = M > 0 ? massFlowBasis / M : 0;
                                const Cp_A = calcMolarCp(comp, true); // Use LIQUID Cp

                                // Stream B: 5% molar vapor - find temperature
                                const vaporFracB = 0.05;
                                let T_B = T_bubble + 30; // Initial guess
                                let flashB = null;
                                for (let iter = 0; iter < 100; iter++) {
                                    flashB = calcFlash(comp, T_B, p1_psia);
                                    const diff = flashB.V - vaporFracB;
                                    if (Math.abs(diff) < 0.0005) break;
                                    const dT = diff > 0 ? -Math.abs(diff) * 50 : Math.abs(diff) * 50;
                                    T_B = T_B + dT * 0.5;
                                    T_B = Math.max(T_bubble + 0.1, Math.min(T_bubble + 300, T_B));
                                }
                                flashB = calcFlash(comp, T_B, p1_psia); // Final flash

                                // Use actual vapor fraction and vapor MW from flash
                                const actualVaporFrac = flashB?.V || vaporFracB;
                                const molesVaporized = molarFlowBasis * actualVaporFrac;
                                const mw_vapor = flashB?.mw_V || M; // Use vapor MW from flash
                                const massVaporized = molesVaporized * mw_vapor;

                                // Calculate weighted Cp for Stream B (liquid + vapor portions)
                                const Cp_L = calcMolarCp(comp, true);  // Liquid Cp
                                const Cp_V = calcMolarCp(comp, false); // Vapor Cp
                                const Cp_B = (1 - actualVaporFrac) * Cp_L + actualVaporFrac * Cp_V;

                                // Sensible heat: Q_sens = n Ã— Cp_avg Ã— Î”T
                                const Cp_avg = (Cp_A + Cp_B) / 2;
                                const Q_sensible = molarFlowBasis * Cp_avg * (T_B - T_bubble);

                                // PR-EOS Latent Heat Calculation
                                const P_Pa = p1_psia * 6894.76;
                                const T_avg_K = ((T_bubble + T_B) / 2 + 459.67) * 5/9;
                                let latentHeat_PR = 0;
                                try {
                                    const H_dep_V = calcEnthalpyDeparture(comp, T_avg_K, P_Pa, 'vapor');
                                    const H_dep_L = calcEnthalpyDeparture(comp, T_avg_K, P_Pa, 'liquid');
                                    const deltaH_Jmol = H_dep_V - H_dep_L;
                                    latentHeat_PR = Math.abs(deltaH_Jmol) * 0.000947817 * 453.592; // J/mol -> Btu/lbmol
                                } catch (e) {
                                    latentHeat_PR = 0;
                                }

                                // Latent heat from vaporization (Btu/hr) = moles vaporized * latent heat per lbmol
                                const Q_latent_PR = molesVaporized * latentHeat_PR;

                                // Total heat input for the vaporized portion
                                const Q_total_stream = Q_sensible + Q_latent_PR;

                                // Multi-component latent heat (Btu/lb) = LATENT portion only / mass vaporized
                                // NOT total heat / mass - the sensible heat is separate
                                const lambda_lightEnds_calc = massVaporized > 0 ? Q_latent_PR / massVaporized : latentHeat;

                                // Apply 10% safety factor if checkbox is checked (reduces Î», increases relief load)
                                const safetyFactor = cond.latent_heat_safety_factor ? 0.90 : 1.0;
                                const lambda_lightEnds = lambda_lightEnds_calc * safetyFactor;

                                // Relief load W = Q / Î» (use multi-component lambda for multi-component mixtures)
                                const effectiveLambda = isMultiComponent ? lambda_lightEnds : latentHeat;
                                const W = effectiveLambda > 0 ? Q / effectiveLambda : 0;

                                // Scale Q to 1000 lb/hr basis for comparison
                                const Q_total_basis = W > 0 ? Q * (massFlowBasis / W) : 0;

                                // Relieving temperature is Stream B (where vapor is generated)
                                const T1_R = T_B + 459.67;

                                // Calculate required area using API 520 vapor equation
                                // Use vapor MW (not bulk MW) since the relieving fluid is vapor
                                const Z = 1.0;
                                const Kd = 0.975;
                                const Kb = 1.0;
                                const Kc = 1.0;
                                const requiredArea = W > 0 && mw_vapor > 0 && p1_psia > 0
                                    ? (W * Math.sqrt(T1_R * Z)) / (C * Kd * p1_psia * Kb * Kc * Math.sqrt(mw_vapor))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrifice = ORIFICES.find(o => o.size === deviceInfo.selected_orifice);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;
                                const ratedReliefLoad = ratedArea > 0 && mw_vapor > 0 && p1_psia > 0
                                    ? (ratedArea * C * Kd * p1_psia * Kb * Kc * Math.sqrt(mw_vapor)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                    <div className="bg-white rounded-xl shadow-lg p-6">
                                        <div className="flex items-center space-x-3 mb-4">
                                            <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-orange-200 text-orange-700 font-bold text-sm">1A</span>
                                            <span className="text-xl">ðŸ”¥</span>
                                            <h3 className="text-lg font-semibold">Fire-Wetted (Liquid Boil up) - API 521 6th Ed. 4.4.13.2</h3>
                                        </div>

                                        {/* Relief Device Sizing Summary - AT TOP */}
                                        <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{W > 0 ? W.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(2) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {ratedArea > 0 && requiredArea > 0 && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-sm text-gray-600">Sizing %</span>
                                                        <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                            {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                            {!selectedOrifice && (
                                                <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                            )}
                                        </div>

                                        <p className="text-xs text-gray-500 mb-4">
                                            This method applies for pool fire on vessel with liquid inventory causing vaporization.
                                            Wetted surface area is the internal vessel area in contact with liquid.
                                        </p>

                                        {/* Operating Conditions Inputs */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-green-800 mb-3">Operating Conditions (Inputs)</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Pressure (P<sub>n</sub>)</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_pressure}
                                                            onChange={(e) => updateScenarioCondition('fire_wetted', 'normal_op_pressure', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">psig</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Temperature (T<sub>n</sub>)</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_temp}
                                                            onChange={(e) => updateScenarioCondition('fire_wetted', 'normal_op_temp', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">Â°F</span>
                                                    </div>
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="flex items-center space-x-2 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={cond.prompt_firefighting}
                                                            onChange={(e) => updateScenarioCondition('fire_wetted', 'prompt_firefighting', e.target.checked)}
                                                            className="w-4 h-4 text-green-600 border-gray-300 rounded"
                                                        />
                                                        <span className="text-sm text-gray-700">Prompt Firefighting & Adequate Drainage?</span>
                                                        <span className="text-xs text-gray-500 ml-2">(If checked: C = 21,000. If unchecked: C = 34,500)</span>
                                                    </label>
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="flex items-center space-x-2 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={cond.latent_heat_safety_factor}
                                                            onChange={(e) => updateScenarioCondition('fire_wetted', 'latent_heat_safety_factor', e.target.checked)}
                                                            className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                                                        />
                                                        <span className="text-sm text-gray-700">Apply 10% Safety Factor to Multi-Comp Latent Heat?</span>
                                                        <span className="text-xs text-gray-500 ml-2">(Recommended for conservative sizing)</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Vessel Details with Diagram - BEFORE Latent Heat */}
                                        <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-4">Vessel Details (Fire Wetted) - A<sub>ws</sub></h4>
                                            <div className="flex gap-6">
                                                {/* Left: Vessel Inputs */}
                                                <div className="flex-1 space-y-3">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Equipment Tag</span>
                                                        <input type="text" value={vesselDetails.equipment_tag}
                                                            onChange={(e) => updateVesselDetail('equipment_tag', e.target.value)}
                                                            placeholder="V-123"
                                                            className="w-28 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Orientation</span>
                                                        <select value={vesselDetails.orientation}
                                                            onChange={(e) => updateVesselDetail('orientation', e.target.value)}
                                                            className="w-28 px-2 py-1.5 bg-green-50 border border-green-300 rounded text-sm focus:outline-none focus:border-green-500">
                                                            <option value="horizontal">Horizontal</option>
                                                            <option value="vertical">Vertical</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Head Type</span>
                                                        <select value={vesselDetails.head_type}
                                                            onChange={(e) => updateVesselDetail('head_type', e.target.value)}
                                                            className="w-36 px-2 py-1.5 bg-green-50 border border-green-300 rounded text-sm focus:outline-none focus:border-green-500">
                                                            <option value="2:1_elliptical">2:1 ELLIPTICAL</option>
                                                            <option value="flat">FLAT</option>
                                                            <option value="hemispherical">HEMISPHERICAL</option>
                                                            <option value="none">NONE</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Inner Diameter (ID)</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.inner_diameter}
                                                                onChange={(e) => updateVesselDetail('inner_diameter', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">in</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Seam-to-Seam Length</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.seam_to_seam}
                                                                onChange={(e) => updateVesselDetail('seam_to_seam', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ft</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Height Above Grade</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.height_above_grade}
                                                                onChange={(e) => updateVesselDetail('height_above_grade', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">ft</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Max Liquid Operating Level</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" min="0" max="100" value={cond.liquid_level}
                                                                onChange={(e) => updateScenarioCondition('fire_wetted', 'liquid_level', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">%</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">Additional Area (+/-)</span>
                                                        <div className="flex items-center space-x-1">
                                                            <input type="number" value={vesselDetails.additional_area}
                                                                onChange={(e) => updateVesselDetail('additional_area', e.target.value)}
                                                                className="w-20 px-3 py-1.5 bg-green-50 border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                            <span className="text-xs text-gray-500">%</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Right: Vessel Diagram and Results */}
                                                <div className="w-64 flex flex-col">
                                                    {/* Vessel Diagram SVG */}
                                                    <div className="bg-white border border-gray-200 rounded-lg p-3 mb-3">
                                                        <svg viewBox="0 0 200 100" className="w-full h-24">
                                                            {vesselDetails.orientation === 'horizontal' ? (
                                                                <>
                                                                    {/* Horizontal vessel shell */}
                                                                    <rect x="40" y="20" width="120" height="60" fill="none" stroke="#374151" strokeWidth="2" rx="0"/>
                                                                    {/* Left head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="40" cy="50" rx="12" ry="30" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 40 20 A 30 30 0 0 0 40 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="40" y1="20" x2="40" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Right head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="160" cy="50" rx="12" ry="30" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 160 20 A 30 30 0 0 1 160 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="160" y1="20" x2="160" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Liquid level fill */}
                                                                    {cond.liquid_level > 0 && (
                                                                        <rect x="40" y={80 - (cond.liquid_level / 100) * 60} width="120" height={(cond.liquid_level / 100) * 60} fill="#3B82F6" fillOpacity="0.3"/>
                                                                    )}
                                                                    <text x="100" y="55" textAnchor="middle" className="text-xs" fill="#6b7280">{cond.liquid_level}% Liquid</text>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    {/* Vertical vessel shell */}
                                                                    <rect x="70" y="15" width="60" height="65" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    {/* Top head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="100" cy="15" rx="30" ry="10" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 70 15 A 30 30 0 0 1 130 15" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="70" y1="15" x2="130" y2="15" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Bottom head */}
                                                                    {vesselDetails.head_type === '2:1_elliptical' && (
                                                                        <ellipse cx="100" cy="80" rx="30" ry="10" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'hemispherical' && (
                                                                        <path d="M 70 80 A 30 30 0 0 0 130 80" fill="none" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {vesselDetails.head_type === 'flat' && (
                                                                        <line x1="70" y1="80" x2="130" y2="80" stroke="#374151" strokeWidth="2"/>
                                                                    )}
                                                                    {/* Liquid level fill */}
                                                                    {cond.liquid_level > 0 && (
                                                                        <rect x="70" y={80 - (cond.liquid_level / 100) * 65} width="60" height={(cond.liquid_level / 100) * 65} fill="#3B82F6" fillOpacity="0.3"/>
                                                                    )}
                                                                    <text x="100" y="50" textAnchor="middle" className="text-xs" fill="#6b7280">{cond.liquid_level}%</text>
                                                                </>
                                                            )}
                                                        </svg>
                                                    </div>

                                                    {/* Volume Results */}
                                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                                                        <div className="flex justify-between mb-2">
                                                            <span className="text-gray-600">Filled Volume</span>
                                                            <span className="font-medium">{filledVolume_gal > 0 ? filledVolume_gal.toFixed(1) : '0'} <span className="text-xs text-gray-500">US gal</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Total Volume</span>
                                                            <span className="font-medium">{wettedVesselAreas.volume_gal > 0 ? wettedVesselAreas.volume_gal.toFixed(1) : '-'} <span className="text-xs text-gray-500">US gal</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* ========== LATENT HEAT CALCULATION SECTION ========== */}
                                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-amber-800 mb-3">Latent Heat Calculation</h4>
                                            <div className="space-y-2">
                                                {/* Ambient Pressure */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Ambient Pressure</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">14.7</span>
                                                        <span className="text-xs text-gray-500 w-12">psia</span>
                                                    </div>
                                                </div>

                                                {/* Relief Device Set Pressure */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Relief Device Set Pressure</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">{setP || '-'}</span>
                                                        <span className="text-xs text-gray-500 w-12">psig</span>
                                                    </div>
                                                </div>

                                                {/* Allowable Overpressure */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Allowable Overpressure</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">21%</span>
                                                        <span className="text-xs text-gray-500 w-12"></span>
                                                    </div>
                                                </div>

                                                {/* Absolute Relieving Pressure */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Absolute Relieving Pressure (Pâ‚)</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">{p1_psia > 0 ? p1_psia.toFixed(0) : '-'}</span>
                                                        <span className="text-xs text-gray-500 w-12">psia</span>
                                                    </div>
                                                </div>

                                                {/* Critical Pressure */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Critical Pressure (P<sub>crit</sub>)</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">{Pcrit > 0 ? Pcrit.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}</span>
                                                        <span className="text-xs text-gray-500 w-12">psia</span>
                                                    </div>
                                                </div>

                                                {/* Single/Multi-Component Indicator */}
                                                <div className="flex items-center justify-between py-1 bg-amber-100 -mx-4 px-4 rounded">
                                                    <span className="text-sm text-gray-700">Single-Component or Multi-Component?</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className={`text-sm font-bold w-36 text-right ${isMultiComponent ? 'text-blue-600' : 'text-green-600'}`}>
                                                            {isMultiComponent ? 'MULTI-COMPONENT' : 'SINGLE-COMPONENT'}
                                                        </span>
                                                    </div>
                                                </div>

                                                {/* Single-Component fields (only show if single component) */}
                                                {!isMultiComponent && (
                                                <>
                                                    <div className="flex items-center justify-between py-1">
                                                        <span className="text-sm text-gray-700">Single-Component Molecular Weight</span>
                                                        <div className="flex items-center space-x-2">
                                                            <span className="text-sm font-medium text-gray-900 w-24 text-right">{M > 0 ? M.toFixed(2) : '-'}</span>
                                                            <span className="text-xs text-gray-500 w-12">lb/lbmol</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between py-1">
                                                        <span className="text-sm text-gray-700">Single-Component Mass Latent Heat</span>
                                                        <div className="flex items-center space-x-2">
                                                            <span className="text-sm font-medium text-gray-900 w-24 text-right">{latentHeat > 0 ? latentHeat.toFixed(0) : '-'}</span>
                                                            <span className="text-xs text-gray-500 w-12">Btu/lb</span>
                                                        </div>
                                                    </div>
                                                </>
                                                )}
                                            </div>
                                        </div>

                                        {/* ========== STREAM A/B MULTI-COMPONENT ANALYSIS (Always visible for multi-component) ========== */}
                                        {isMultiComponent && (
                                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-purple-800 mb-3">Multi-Component Latent Heat Analysis</h4>

                                            {/* Heat Exchanger Diagram */}
                                            <div className="mb-4 flex justify-center">
                                                <svg width="300" height="80" viewBox="0 0 300 80">
                                                    <line x1="20" y1="40" x2="100" y2="40" stroke="#3B82F6" strokeWidth="2" markerEnd="url(#arrowBlue3)"/>
                                                    <text x="60" y="25" textAnchor="middle" fontSize="10" fill="#3B82F6">Stream A</text>
                                                    <circle cx="150" cy="40" r="30" fill="#FEE2E2" stroke="#DC2626" strokeWidth="2"/>
                                                    <path d="M135 32 Q142 40 135 48 Q142 40 150 48 Q158 40 165 48 Q158 40 165 32" fill="none" stroke="#DC2626" strokeWidth="1.5"/>
                                                    <text x="150" y="75" textAnchor="middle" fontSize="9" fill="#DC2626">Heat Input</text>
                                                    <line x1="200" y1="40" x2="280" y2="40" stroke="#10B981" strokeWidth="2" markerEnd="url(#arrowGreen3)"/>
                                                    <text x="240" y="25" textAnchor="middle" fontSize="10" fill="#10B981">Stream B</text>
                                                    <defs>
                                                        <marker id="arrowBlue3" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
                                                            <path d="M0,0 L0,6 L8,3 z" fill="#3B82F6"/>
                                                        </marker>
                                                        <marker id="arrowGreen3" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
                                                            <path d="M0,0 L0,6 L8,3 z" fill="#10B981"/>
                                                        </marker>
                                                    </defs>
                                                </svg>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                {/* Stream A Properties */}
                                                <div className="bg-blue-100 rounded-lg p-3">
                                                    <h5 className="font-semibold text-blue-800 mb-2 text-sm italic">Stream A Properties</h5>
                                                    <div className="space-y-1 text-xs">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Vapor Fraction</span>
                                                            <span className="font-medium">0.00</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Pressure</span>
                                                            <span className="font-medium">{p1_psia.toFixed(0)} <span className="text-gray-400">psia</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Temperature</span>
                                                            <span className="font-medium">{T_bubble.toFixed(1)} <span className="text-gray-400">Â°F</span></span>
                                                        </div>
                                                        <div className="text-gray-500 text-[10px] ml-2">- Bubble Point Temperature at Relieving Pressure</div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Mass Flow Rate</span>
                                                            <span className="font-medium">{massFlowBasis.toLocaleString()} <span className="text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Molar Flow Rate</span>
                                                            <span className="font-medium">{molarFlowBasis.toFixed(1)} <span className="text-gray-400">lbmol/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Molar Heat Capacity</span>
                                                            <span className="font-medium">{Cp_A.toFixed(2)} <span className="text-gray-400">Btu/lbmolÂ·Â°F</span></span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Stream B Properties */}
                                                <div className="bg-green-100 rounded-lg p-3">
                                                    <h5 className="font-semibold text-green-800 mb-2 text-sm italic">Stream B Properties</h5>
                                                    <div className="space-y-1 text-xs">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Vapor Fraction (by mol)</span>
                                                            <span className="font-medium">{actualVaporFrac.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Pressure</span>
                                                            <span className="font-medium">{p1_psia.toFixed(0)} <span className="text-gray-400">psia</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Temperature</span>
                                                            <span className="font-medium">{T_B.toFixed(1)} <span className="text-gray-400">Â°F</span></span>
                                                        </div>
                                                        <div className="text-gray-500 text-[10px] ml-2">- Dew Point Temperature of the 5% Light Ends</div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Mass Flow Rate (Mass Vaporized)</span>
                                                            <span className="font-medium">{massVaporized.toFixed(0)} <span className="text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Molar Flow Rate (Moles Vaporized)</span>
                                                            <span className="font-medium">{molesVaporized.toFixed(2)} <span className="text-gray-400">lbmol/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-600">Bulk Molar Heat Capacity</span>
                                                            <span className="font-medium">{Cp_B.toFixed(2)} <span className="text-gray-400">Btu/lbmolÂ·Â°F</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Heat Duty Summary */}
                                            <div className="mt-4 bg-white rounded-lg p-3 border border-purple-200">
                                                <div className="space-y-1 text-sm">
                                                    <div className="flex justify-between">
                                                        <div>
                                                            <span className="text-gray-700 font-medium">Total Heat Input</span>
                                                            <div className="text-[10px] text-gray-500 ml-2">- Heat Required to Boil the 5% Light Ends & Heat Stream A to Stream B Temperature</div>
                                                        </div>
                                                        <span className="font-medium">{Q_total_stream > 0 ? Q_total_stream.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">Btu/hr</span></span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <div>
                                                            <span className="text-gray-700">Sensible Heat Input</span>
                                                            <div className="text-[10px] text-gray-500 ml-2">- Heat Required to Heat Stream A to Stream B Temperature</div>
                                                        </div>
                                                        <span className="font-medium">{Q_sensible > 0 ? Q_sensible.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">Btu/hr</span></span>
                                                    </div>
                                                    <div className="flex justify-between bg-purple-100 -mx-3 px-3 py-1 rounded">
                                                        <div>
                                                            <span className="text-gray-700 font-medium">Multi-Component Mass Latent Heat (Light Ends)</span>
                                                            <div className="text-[10px] text-gray-500 ml-2">- Heat Required to Boil the 5% Light Ends</div>
                                                        </div>
                                                        <span className="font-bold text-purple-700">{lambda_lightEnds_calc > 0 ? lambda_lightEnds_calc.toFixed(0) : '-'} <span className="text-xs text-gray-400">Btu/lb</span></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        )}

                                        {/* ========== REQUIRED RELIEVING RATE CALCULATION ========== */}
                                        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-3">Required Relieving Rate Calculation</h4>
                                            <div className="space-y-2">
                                                {/* Insulation Status */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Is the Vessel Insulated or Bare?</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">BARE</span>
                                                    </div>
                                                </div>

                                                {/* Environment Factor */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Environment Factor (F)</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">{F.toFixed(2)}</span>
                                                    </div>
                                                </div>

                                                {/* Wetted Surface Area */}
                                                <div className="flex items-center justify-between py-1 bg-blue-50 -mx-4 px-4 rounded">
                                                    <span className="text-sm font-medium text-gray-700">Wetted Surface Area (A<sub>ws</sub>)</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-bold text-blue-700 w-24 text-right">{wettedArea > 0 ? wettedArea.toFixed(1) : '-'}</span>
                                                        <span className="text-xs text-gray-500 w-12">ftÂ²</span>
                                                    </div>
                                                </div>

                                                {/* Heat Absorption Constant */}
                                                <div className="flex items-center justify-between py-1">
                                                    <span className="text-sm text-gray-700">Heat Absorption Constant (Câ‚ or Câ‚‚)</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-medium text-gray-900 w-24 text-right">{heatAbsorptionConstant.toLocaleString()}</span>
                                                    </div>
                                                </div>

                                                {/* Total Heat Absorption */}
                                                <div className="flex items-center justify-between py-1 bg-orange-50 -mx-4 px-4 rounded">
                                                    <span className="text-sm font-medium text-gray-700">Total Heat Absorption (Q)</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-bold text-orange-700 w-24 text-right">{Q > 0 ? Q.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}</span>
                                                        <span className="text-xs text-gray-500 w-12">Btu/hr</span>
                                                    </div>
                                                </div>

                                                {/* Relief Load */}
                                                <div className="flex items-center justify-between py-1 bg-red-50 -mx-4 px-4 rounded">
                                                    <span className="text-sm font-medium text-gray-700">Relief Load</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-sm font-bold text-red-700 w-24 text-right">{W > 0 ? W.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}</span>
                                                        <span className="text-xs text-gray-500 w-12">lb/hr</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* ========== OLD CALCULATED PARAMETERS (TO BE REMOVED/HIDDEN) ========== */}
                                        <details className="mt-4">
                                            <summary className="text-xs text-gray-500 cursor-pointer hover:text-gray-700">Show Additional Calculated Parameters</summary>
                                        <div className="space-y-2 mt-2">
                                            {/* Relieving Pressure - Display (in psig) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Pressure (Pâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{p1_psig > 0 ? p1_psig.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            {/* Insulation Status - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Insulation Status</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">Uninsulated</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Environment Factor - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Environment Factor (F)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{F.toFixed(2)}</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Wetted Surface Area from Vessel Geometry */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-blue-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Wetted Surface Area (A<sub>ws</sub>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-blue-700 w-24 text-right">{wettedArea > 0 ? wettedArea.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">ftÂ²</span>
                                                </div>
                                            </div>

                                            {/* Heat Absorption Constant - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Heat Absorption Constant (C)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{heatAbsorptionConstant.toLocaleString()}</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            {/* Heat Absorption - Display (highlighted) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 bg-orange-50 -mx-2 px-2 rounded">
                                                <span className="text-sm font-medium text-gray-700">Total Heat Absorption (Q = C Ã— F Ã— A<sup>0.82</sup>)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-bold text-orange-700 w-24 text-right">{Q > 0 ? Q.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Btu/hr</span>
                                                </div>
                                            </div>

                                            {/* Latent Heat - Display (use multi-comp Î» for mixtures, single comp for pure) */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">
                                                    Latent Heat of Vaporization (Î»){isMultiComponent && cond.latent_heat_safety_factor && <span className="text-blue-600 text-xs ml-1">(Ã—0.90 SF)</span>}
                                                </span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{effectiveLambda > 0 ? effectiveLambda.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Btu/lb</span>
                                                </div>
                                            </div>

                                            {/* Relieving Temperature - Stream B temperature */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Temperature (Tâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{T_B > 0 ? T_B.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            {/* Latent Heat - Display */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">
                                                    Latent Heat of Vaporization (Î»){isMultiComponent && cond.latent_heat_safety_factor && <span className="text-blue-600 text-xs ml-1">(Ã—0.90 SF)</span>}
                                                </span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{effectiveLambda > 0 ? effectiveLambda.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Btu/lb</span>
                                                </div>
                                            </div>

                                            {/* Relieving Temperature */}
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Temperature (Tâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{T_B > 0 ? T_B.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>
                                        </div>
                                        </details>
                                    </div>
                                );
                            })()}

                            {/* Blocked Outlet (2A) Section */}
                            {(activeConditionsTab === 'blocked_vapor' || (calculableScenarios.length === 1 && scenarioSelections.blocked_vapor?.applicable)) && (() => {
                                const comp = compositions.blocked_vapor || {};
                                const cond = scenarioConditions.blocked_vapor;
                                const setP = parseFloat(deviceInfo.set_pressure) || 0;
                                const BLOCKED_OVERPRESSURE = 0.10; // 10% for non-fire scenarios
                                const p1_psig = setP * (1 + BLOCKED_OVERPRESSURE);
                                const p1_psia = p1_psig + AMBIENT_PRESSURE;
                                const M = getMolecularWeight(comp);
                                const k = getSpecificHeatRatio(comp);
                                const C = getAPI520_C(k);

                                // For isenthalpic flash, T1 â‰ˆ Tn (simplified - actual requires EOS)
                                // In reality would flash to ensure vapor fraction = 1.0
                                const T1 = cond.normal_op_temp; // Simplified: use operating temp
                                const T1_R = T1 + 459.67;

                                // Get flow rate in lb/hr (convert if needed)
                                const flowRateInput = parseFloat(cond.flow_rate) || 0;
                                let qRelief_lb_hr, qRelief_mmscfd;
                                if (cond.flow_rate_unit === 'mmscfd') {
                                    qRelief_mmscfd = flowRateInput;
                                    // Convert MMscfd to lb/hr: (MMscfd * 1e6 * M) / (379.5 * 24)
                                    qRelief_lb_hr = (flowRateInput * 1e6 * M) / (379.5 * 24);
                                } else {
                                    qRelief_lb_hr = flowRateInput;
                                    // Convert lb/hr to MMscfd
                                    qRelief_mmscfd = M > 0 ? (flowRateInput * 379.5 * 24) / (1e6 * M) : 0;
                                }

                                // Calculate required area using API 520 vapor equation
                                const Kd = 0.975;
                                const Kb = 1.0;
                                const Kc = 1.0;
                                const Z = 1.0;
                                const requiredArea = qRelief_lb_hr > 0 && M > 0 && p1_psia > 0
                                    ? (qRelief_lb_hr * Math.sqrt(T1_R * Z)) / (C * Kd * p1_psia * Kb * Kc * Math.sqrt(M))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrificeSize = deviceInfo.selected_orifice;
                                const selectedOrifice = ORIFICES.find(o => o.size === selectedOrificeSize);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                                // Calculate rated relief load
                                const ratedReliefLoad = ratedArea > 0 && M > 0 && p1_psia > 0
                                    ? (ratedArea * C * Kd * p1_psia * Kb * Kc * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                    <div className="bg-white rounded-xl shadow-lg p-6">
                                        <div className="flex items-center space-x-3 mb-4">
                                            <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">2A</span>
                                            <span className="text-xl">â›”</span>
                                            <h3 className="text-lg font-semibold">Blocked Outlet - Vapor</h3>
                                        </div>

                                        {/* Relief Device Sizing Summary - AT TOP */}
                                        <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{qRelief_lb_hr > 0 ? qRelief_lb_hr.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(2) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                    <div className="space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Load</span>
                                                            <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-sm text-gray-600">Relief Area</span>
                                                            <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {ratedArea > 0 && requiredArea > 0 && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-sm text-gray-600">Sizing %</span>
                                                        <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                            {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                            {!selectedOrifice && (
                                                <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                            )}
                                        </div>

                                        {/* Operating Conditions Inputs */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                            <h4 className="font-medium text-green-800 mb-3">Operating Conditions (Inputs)</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Pressure</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_pressure}
                                                            onChange={(e) => updateScenarioCondition('blocked_vapor', 'normal_op_pressure', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">psig</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-700">Normal Operating Temperature</span>
                                                    <div className="flex items-center space-x-1">
                                                        <input type="number" value={cond.normal_op_temp}
                                                            onChange={(e) => updateScenarioCondition('blocked_vapor', 'normal_op_temp', e.target.value)}
                                                            className="w-20 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                        <span className="text-xs text-gray-500">Â°F</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Calculated Values */}
                                        <div className="space-y-2 mb-4">
                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relief Device Set Pressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{setP || '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Allowable Overpressure</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">10%</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Relieving Pressure (pâ‚)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{p1_psig > 0 ? p1_psig.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">psig</span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100 group relative">
                                                <span className="text-sm text-gray-700 cursor-help border-b border-dotted border-gray-400">
                                                    Relieving Temperature (Tâ‚)
                                                    <span className="invisible group-hover:visible absolute left-0 top-full mt-1 p-2 bg-gray-800 text-white text-xs rounded shadow-lg z-10 w-64">
                                                        Isenthalpically flashed to relieving pressure to ensure vapor fraction of 1.0
                                                    </span>
                                                </span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{T1 > 0 ? T1.toFixed(0) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12">Â°F</span>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span className="text-sm text-gray-700">Vapor Molecular Weight (M)</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm font-medium text-gray-900 w-24 text-right">{M > 0 ? M.toFixed(1) : '-'}</span>
                                                    <span className="text-xs text-gray-500 w-12"></span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Relieving Rate Input */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <h4 className="font-medium text-green-800 mb-3">Relieving Rate (Input)</h4>
                                            <div className="flex items-center space-x-4">
                                                {/* Toggle Buttons */}
                                                <div className="flex rounded-lg overflow-hidden border border-green-300">
                                                    <button type="button"
                                                        onClick={() => updateScenarioCondition('blocked_vapor', 'flow_rate_unit', 'lb_hr')}
                                                        className={`px-3 py-1.5 text-sm font-medium transition ${
                                                            cond.flow_rate_unit === 'lb_hr'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-gray-600 hover:bg-gray-50'
                                                        }`}>
                                                        lb/hr
                                                    </button>
                                                    <button type="button"
                                                        onClick={() => updateScenarioCondition('blocked_vapor', 'flow_rate_unit', 'mmscfd')}
                                                        className={`px-3 py-1.5 text-sm font-medium transition ${
                                                            cond.flow_rate_unit === 'mmscfd'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-gray-600 hover:bg-gray-50'
                                                        }`}>
                                                        MMscfd
                                                    </button>
                                                </div>
                                                <input type="number" value={cond.flow_rate}
                                                    onChange={(e) => updateScenarioCondition('blocked_vapor', 'flow_rate', e.target.value)}
                                                    className="w-28 px-3 py-1.5 bg-white border border-green-300 rounded text-sm text-right focus:outline-none focus:border-green-500" />
                                                <span className="text-sm text-gray-400">
                                                    {cond.flow_rate_unit === 'lb_hr'
                                                        ? `= ${qRelief_mmscfd > 0 ? qRelief_mmscfd.toFixed(2) : '-'} MMscfd`
                                                        : `= ${qRelief_lb_hr > 0 ? qRelief_lb_hr.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} lb/hr`
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* CV Failure (3) Section */}
                            {(activeConditionsTab === 'cv_failure' || (calculableScenarios.length === 1 && scenarioSelections.cv_failure?.applicable)) && (() => {
                                const comp = compositions.cv_failure || {};
                                const cond = scenarioConditions.cv_failure;
                                const setP = parseFloat(deviceInfo.set_pressure) || 150;

                                // Calculated vapor properties
                                const M = getMolecularWeight(comp);
                                const Gg = M / 28.97; // Specific gravity relative to air
                                const k = getSpecificHeatRatio(comp);
                                const Fk = k / 1.4; // Ratio of specific heats factor

                                // Pressures
                                const P1_psig = cond.upstream_pressure;
                                const P1_psia = P1_psig + 14.69;
                                const P2_psig = setP * 1.10; // Relieving pressure (10% overpressure)
                                const P2_psia = P2_psig + 14.69;
                                const deltaP = P1_psig - P2_psig;
                                const x = deltaP / P1_psia; // Pressure drop ratio

                                // Control valve calculations
                                const Cv = cond.cv;
                                const XT = cond.xt;
                                const Z = 0.95; // Compressibility factor (fixed)
                                const T1 = cond.upstream_temp;
                                const T1_R = T1 + 459.67;

                                // Limit x to Fk*XT (choked flow limit)
                                const xChoked = Fk * XT;
                                const xEffective = Math.min(x, xChoked);

                                // Expansion factor Y (limited to 0.667 minimum)
                                const Y = Math.max(1 - xEffective / (3 * Fk * XT), 0.667);

                                // Volumetric flow q (scfh) - ISA equation with N7 = 1360
                                const N7 = 1360; // For q in scfh, P in psia, T in Â°R
                                const q_cv = Gg > 0 && T1_R > 0 && Z > 0
                                    ? N7 * Cv * P1_psia * Y * Math.sqrt(xEffective / (Gg * T1_R * Z))
                                    : 0;

                                // CV Mass flow W (lb/hr) = q * M / 379.5 (molar volume at STP)
                                const W_cv = q_cv * M / 379.5;

                                // Bypass flow calculations
                                const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                                const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;
                                const bypassXT = 1.0; // Fixed for bypass valves

                                const bypassXChoked = Fk * bypassXT;
                                const bypassXEffective = Math.min(x, bypassXChoked);
                                const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                                const q_bypass = cond.has_bypass && Gg > 0 && T1_R > 0 && Z > 0
                                    ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                                    : 0;
                                const W_bypass = q_bypass * M / 379.5;

                                // Use CV or Bypass flow based on checkbox
                                const q = cond.has_bypass && cond.use_bypass_flow ? q_bypass : q_cv;
                                const W = cond.has_bypass && cond.use_bypass_flow ? W_bypass : W_cv;

                                // For display purposes, keep Cg based on CV
                                const Cg = Cv * 40 * Math.sqrt(XT);

                                // Calculate required area
                                const C = getAPI520_C(k);
                                const Kd = 0.975;
                                const requiredArea = W > 0 && M > 0 && P2_psia > 0
                                    ? (W * Math.sqrt(T1_R * Z)) / (C * Kd * P2_psia * 1.0 * 1.0 * Math.sqrt(M))
                                    : 0;

                                // Get selected orifice info
                                const selectedOrifice = ORIFICES.find(o => o.size === deviceInfo.selected_orifice);
                                const ratedArea = selectedOrifice ? selectedOrifice.area : 0;

                                // Calculate rated relief load
                                const ratedReliefLoad = ratedArea > 0 && M > 0 && P2_psia > 0
                                    ? (ratedArea * C * Kd * P2_psia * 1.0 * 1.0 * Math.sqrt(M)) / Math.sqrt(T1_R * Z)
                                    : 0;

                                return (
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="flex items-center space-x-3 mb-4">
                                        <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm">3</span>
                                        <span className="text-xl">âš ï¸</span>
                                        <h3 className="text-lg font-semibold">CV Failure - Vapor</h3>
                                    </div>

                                    {/* Relief Device Sizing Summary - matches Fire Unwetted format */}
                                    <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                        <h4 className="font-medium text-gray-700 mb-3">Relief Device Sizing Summary</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Required</h5>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Load</span>
                                                        <span className="text-sm font-medium">{W > 0 ? W.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Area</span>
                                                        <span className="text-sm font-medium">{requiredArea > 0 ? requiredArea.toFixed(2) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">Rated ({selectedOrifice ? selectedOrifice.letter : '-'})</h5>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Load</span>
                                                        <span className="text-sm font-medium">{ratedReliefLoad > 0 ? ratedReliefLoad.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} <span className="text-xs text-gray-400">lb/hr</span></span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-sm text-gray-600">Relief Area</span>
                                                        <span className="text-sm font-medium">{ratedArea > 0 ? ratedArea.toFixed(3) : '-'} <span className="text-xs text-gray-400">inÂ²</span></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {ratedArea > 0 && requiredArea > 0 && (
                                            <div className="mt-3 pt-3 border-t border-gray-200">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">Sizing %</span>
                                                    <span className={`text-sm font-bold ${(requiredArea / ratedArea * 100) <= 100 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {(requiredArea / ratedArea * 100).toFixed(1)}%
                                                        {(requiredArea / ratedArea * 100) <= 100 ? ' âœ“' : ' (Undersized!)'}
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                        {!selectedOrifice && (
                                            <p className="mt-3 text-xs text-amber-600">Select a relief device size on the Device Info page to see rated values.</p>
                                        )}
                                    </div>

                                    {/* Vapor Properties (from composition) */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Vapor Properties</h4>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 bg-gray-50 rounded-lg p-4">
                                            <div>
                                                <p className="text-xs text-gray-500">Molecular Weight</p>
                                                <p className="font-semibold">{M > 0 ? M.toFixed(2) : 'â€”'} <span className="text-xs text-gray-400">lb/lbmol</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Specific Gravity (G<sub>g</sub>)</p>
                                                <p className="font-semibold">{Gg > 0 ? Gg.toFixed(3) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Specific Heat Ratio (k)</p>
                                                <p className="font-semibold">{k > 0 ? k.toFixed(3) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Ratio Factor (F<sub>k</sub>)</p>
                                                <p className="font-semibold">{Fk > 0 ? Fk.toFixed(3) : 'â€”'}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Upstream Properties */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Upstream Properties</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Maximum Operating Pressure (P<sub>1</sub>)
                                                </label>
                                                <div className="flex items-center">
                                                    <input
                                                        type="number"
                                                        value={cond.upstream_pressure}
                                                        onChange={(e) => updateScenarioCondition('cv_failure', 'upstream_pressure', e.target.value)}
                                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                    />
                                                    <span className="ml-2 text-sm text-gray-500">psig</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Temperature (T<sub>1</sub>)
                                                </label>
                                                <div className="flex items-center">
                                                    <input
                                                        type="number"
                                                        value={cond.upstream_temp}
                                                        onChange={(e) => updateScenarioCondition('cv_failure', 'upstream_temp', e.target.value)}
                                                        className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                    />
                                                    <span className="ml-2 text-sm text-gray-500">Â°F</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Downstream Properties (calculated) */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Downstream Properties</h4>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 bg-gray-50 rounded-lg p-4">
                                            <div>
                                                <p className="text-xs text-gray-500">Relief Device Set Pressure</p>
                                                <p className="font-semibold">{setP} <span className="text-xs text-gray-400">psig</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Allowable Overpressure</p>
                                                <p className="font-semibold">10%</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Relieving Pressure (P<sub>2</sub>)</p>
                                                <p className="font-semibold">{P2_psig.toFixed(0)} <span className="text-xs text-gray-400">psig</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Pressure Drop Ratio (x)</p>
                                                <p className="font-semibold">{x > 0 ? x.toFixed(3) : 'â€”'}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Control Valve Specification */}
                                    <div className="mb-6">
                                        <h4 className="font-medium text-gray-700 mb-3">Control Valve Specification</h4>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Valve Tag</label>
                                                <input
                                                    type="text"
                                                    value={cond.valve_tag}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'valve_tag', e.target.value)}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                    placeholder="LCV-485"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Full-Open Valve Coefficient (C<sub>v</sub>)
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    value={cond.cv}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'cv', e.target.value)}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Pressure Drop Ratio Factor (X<sub>T</sub>)
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={cond.xt}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'xt', e.target.value)}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Bypass Valve Section */}
                                    <div className="mb-6">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-medium text-gray-700">Bypass Valve</h4>
                                            <label className="flex items-center cursor-pointer">
                                                <span className="text-sm text-gray-600 mr-3">Has Bypass Valve?</span>
                                                <div className="relative">
                                                    <input
                                                        type="checkbox"
                                                        checked={cond.has_bypass}
                                                        onChange={(e) => updateScenarioCondition('cv_failure', 'has_bypass', e.target.checked)}
                                                        className="sr-only"
                                                    />
                                                    <div className={`w-10 h-6 rounded-full transition ${cond.has_bypass ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                                                    <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition transform ${cond.has_bypass ? 'translate-x-4' : ''}`}></div>
                                                </div>
                                            </label>
                                        </div>

                                        <div className={`grid grid-cols-2 gap-4 p-4 rounded-lg border ${cond.has_bypass ? 'bg-white border-gray-200' : 'bg-gray-100 border-gray-200 opacity-50'}`}>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Valve Type</label>
                                                <select
                                                    value={cond.bypass_valve_type}
                                                    onChange={(e) => {
                                                        updateScenarioCondition('cv_failure', 'bypass_valve_type', e.target.value);
                                                        // Reset size to first available for new valve type
                                                        const sizes = e.target.value === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                                        updateScenarioCondition('cv_failure', 'bypass_size', sizes[0].size);
                                                    }}
                                                    disabled={!cond.has_bypass}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none disabled:bg-gray-100"
                                                >
                                                    <option value="globe">Globe Valve</option>
                                                    <option value="ball">Ball Valve</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Nominal Size (C<sub>v</sub>)
                                                </label>
                                                <select
                                                    value={cond.bypass_size}
                                                    onChange={(e) => updateScenarioCondition('cv_failure', 'bypass_size', e.target.value)}
                                                    disabled={!cond.has_bypass}
                                                    className="input-field w-full px-3 py-2 border rounded-lg focus:outline-none disabled:bg-gray-100"
                                                >
                                                    {(cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL).map(v => (
                                                        <option key={v.size} value={v.size}>{v.size} (Cv = {v.cv})</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Bypass Flow Calculation (shown when bypass exists) */}
                                        {cond.has_bypass && (() => {
                                            const bypassCvTable = cond.bypass_valve_type === 'globe' ? BYPASS_CV_GLOBE : BYPASS_CV_BALL;
                                            const bypassCvEntry = bypassCvTable.find(v => v.size === cond.bypass_size);
                                            const bypassCv = bypassCvEntry ? bypassCvEntry.cv : 0;
                                            const bypassXT = 1.0; // Fixed for bypass valves

                                            const bypassXChoked = Fk * bypassXT;
                                            const bypassXEffective = Math.min(x, bypassXChoked);
                                            const bypassY = Math.max(1 - bypassXEffective / (3 * Fk * bypassXT), 0.667);
                                            const bypassQ = Gg > 0 && T1_R > 0 && Z > 0
                                                ? N7 * bypassCv * P1_psia * bypassY * Math.sqrt(bypassXEffective / (Gg * T1_R * Z))
                                                : 0;
                                            const bypassW = bypassQ * M / 379.5;

                                            return (
                                                <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <h5 className="font-medium text-amber-800">Bypass Flow Calculation</h5>
                                                        <label className="flex items-center cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={cond.use_bypass_flow}
                                                                onChange={(e) => updateScenarioCondition('cv_failure', 'use_bypass_flow', e.target.checked)}
                                                                className="w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500"
                                                            />
                                                            <span className="ml-2 text-sm text-amber-700">Use bypass flow for sizing</span>
                                                        </label>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                                        <div>
                                                            <p className="text-xs text-gray-500">Bypass C<sub>v</sub></p>
                                                            <p className="font-semibold text-amber-700">{bypassCv}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-gray-500">Bypass Flow (q)</p>
                                                            <p className="font-semibold text-amber-700">{bypassQ > 0 ? bypassQ.toLocaleString(undefined, {maximumFractionDigits: 0}) : 'â€”'} <span className="text-xs">scfh</span></p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-gray-500">Bypass Mass Flow (W)</p>
                                                            <p className="font-semibold text-amber-700">{bypassW > 0 ? bypassW.toLocaleString(undefined, {maximumFractionDigits: 0}) : 'â€”'} <span className="text-xs">lb/hr</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>

                                    {/* Calculated Flow Values */}
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 className="font-medium text-green-800 mb-3">Calculated Flow Through Failed Valve</h4>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                            <div>
                                                <p className="text-xs text-gray-500">Gas Sizing Coef (C<sub>g</sub>)</p>
                                                <p className="font-semibold text-green-700">{Cg > 0 ? Cg.toFixed(0) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Expansion Factor (Y)</p>
                                                <p className="font-semibold text-green-700">{Y > 0 ? Y.toFixed(3) : 'â€”'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Volumetric Flow (q)</p>
                                                <p className="font-semibold text-green-700">{q > 0 ? q.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : 'â€”'} <span className="text-xs">scfh</span></p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500">Mass Flow (W)</p>
                                                <p className="font-semibold text-green-700">{W > 0 ? W.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : 'â€”'} <span className="text-xs">lb/hr</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                );
                            })()}

                            {/* Navigation */}
                            <div className="flex justify-between">
                                <button onClick={() => setStep(3)} className="px-6 py-2 border bg-white rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Back
                                </button>
                                <button onClick={calculate} className="px-6 py-2 franc-accent-bg text-white rounded-lg font-medium hover:bg-blue-700 transition">
                                    Calculate â†’
                                </button>
                            </div>
                        </div>
                        );
                    })()}

                    {/* Step 5: Results */}
                    {step === 5 && results && (
                        <div className="fade-in space-y-6">
                            {/* Device Header */}
                            {(results.deviceInfo?.tag || results.deviceInfo?.facility_name) && (
                                <div className="bg-gray-100 rounded-xl p-4">
                                    <div className="flex flex-wrap gap-4 text-sm">
                                        {results.deviceInfo.tag && (
                                            <div><span className="text-gray-500">Tag:</span> <span className="font-semibold">{results.deviceInfo.tag}</span></div>
                                        )}
                                        {results.deviceInfo.facility_name && (
                                            <div><span className="text-gray-500">Facility:</span> <span className="font-semibold">{results.deviceInfo.facility_name}</span></div>
                                        )}
                                        {results.deviceInfo.pid_number && (
                                            <div><span className="text-gray-500">P&ID:</span> <span className="font-semibold">{results.deviceInfo.pid_number}</span></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Sizing Results Card */}
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-4">Sizing Results</h2>

                                {/* Controlling Scenario vs Installed Device vs Recommended */}
                                <div className="bg-blue-50 rounded-xl p-6 mb-6">
                                    <div className={`grid gap-6 ${results.isUndersized ? 'grid-cols-3' : 'grid-cols-2'}`}>
                                        <div className="text-center">
                                            <p className="text-sm text-gray-600 mb-1">Controlling Scenario</p>
                                            <p className="text-2xl font-bold text-blue-700 mb-1">
                                                {results.controllingScenario ? results.scenarioResults[results.controllingScenario]?.name : '-'}
                                            </p>
                                            <p className="text-lg text-gray-700">
                                                Required Area: <span className="font-semibold">{results.maxRequiredArea > 0 ? results.maxRequiredArea.toFixed(2) : '-'}</span> inÂ²
                                            </p>
                                        </div>
                                        <div className="text-center border-l border-blue-200">
                                            <p className="text-sm text-gray-600 mb-1">Installed Device</p>
                                            <p className={`text-2xl font-bold mb-1 ${results.isUndersized ? 'text-red-600' : 'franc-accent'}`}>
                                                {results.selectedOrifice ? results.selectedOrifice.letter : '-'}
                                            </p>
                                            <p className="text-lg text-gray-700">
                                                Rated Area: <span className="font-semibold">{results.ratedArea > 0 ? results.ratedArea.toFixed(3) : '-'}</span> inÂ²
                                            </p>
                                        </div>
                                        {results.isUndersized && results.recommendedOrifice && (
                                            <div className="text-center border-l border-blue-200">
                                                <p className="text-sm text-gray-600 mb-1">Recommended Device</p>
                                                <p className="text-2xl font-bold text-green-600 mb-1">
                                                    {results.recommendedOrifice.letter}
                                                </p>
                                                <p className="text-lg text-gray-700">
                                                    Rated Area: <span className="font-semibold">{results.recommendedOrifice.area.toFixed(3)}</span> inÂ²
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                    {results.ratedArea > 0 && results.maxRequiredArea > 0 && (
                                        <div className="mt-4 pt-4 border-t border-blue-200 text-center">
                                            <span className={`text-lg font-bold ${!results.isUndersized ? 'text-green-600' : 'text-red-600'}`}>
                                                {!results.isUndersized ? 'âœ“ ADEQUATE' : 'âœ— UNDERSIZED'}
                                            </span>
                                            <span className="text-gray-500 ml-2">
                                                ({((results.maxRequiredArea / results.ratedArea) * 100).toFixed(1)}% utilized)
                                            </span>
                                        </div>
                                    )}
                                </div>

                                {/* Summary of Potential Relieving Scenarios Table */}
                                <h3 className="font-medium mb-3">Summary of Potential Relieving Scenarios</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-3 py-2 text-left">Applicable?</th>
                                                <th className="border border-gray-300 px-3 py-2 text-left">Scenario</th>
                                                <th className="border border-gray-300 px-3 py-2 text-right">Required/Rated Flow (lb/hr)</th>
                                                <th className="border border-gray-300 px-3 py-2 text-right">Required Area (inÂ²)</th>
                                                <th className="border border-gray-300 px-3 py-2 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {SCENARIOS.map(s => {
                                                const sr = results.scenarioResults[s.id];
                                                const isControlling = results.controllingScenario === s.id;
                                                const isApplicable = scenarioSelections[s.id]?.applicable;
                                                return (
                                                    <tr key={s.id} className={isControlling ? 'bg-yellow-50 font-bold' : ''}>
                                                        <td className="border border-gray-300 px-3 py-2">
                                                            <span className={isApplicable ? 'text-green-600' : 'text-gray-400'}>
                                                                {isApplicable ? 'YES' : 'NO'}
                                                            </span>
                                                        </td>
                                                        <td className="border border-gray-300 px-3 py-2">{s.name}</td>
                                                        <td className="border border-gray-300 px-3 py-2 text-right">
                                                            {sr && !sr.placeholder
                                                                ? `${sr.requiredFlow > 0 ? sr.requiredFlow.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'} / ${sr.ratedFlow > 0 ? sr.ratedFlow.toLocaleString(undefined, {maximumFractionDigits: 0}) : '-'}`
                                                                : '-'
                                                            }
                                                        </td>
                                                        <td className="border border-gray-300 px-3 py-2 text-right">
                                                            {sr && !sr.placeholder && sr.requiredArea > 0 ? sr.requiredArea.toFixed(2) : '-'}
                                                        </td>
                                                        <td className="border border-gray-300 px-3 py-2 text-center">
                                                            {sr && !sr.placeholder ? (
                                                                <span className={sr.adequate ? 'text-green-600' : 'text-red-600 font-bold'}>
                                                                    {sr.adequate ? 'Adequate' : 'Undersized'}
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400">-</span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Report Options */}
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <h3 className="text-lg font-semibold mb-4 franc-blue">Report Sections</h3>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeInputs}
                                            onChange={(e) => setReportOptions({...reportOptions, includeInputs: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Device Inputs</span>
                                    </label>
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeResults}
                                            onChange={(e) => setReportOptions({...reportOptions, includeResults: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Results Table</span>
                                    </label>
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeCalcs}
                                            onChange={(e) => setReportOptions({...reportOptions, includeCalcs: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Calculations</span>
                                    </label>
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={reportOptions.includeAppendix}
                                            onChange={(e) => setReportOptions({...reportOptions, includeAppendix: e.target.checked})}
                                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-sm text-gray-700">Appendix/Uploads</span>
                                    </label>
                                </div>
                            </div>

                            {/* Professional Reports & Services */}
                            <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl shadow-lg p-6 text-white">
                                <h3 className="text-xl font-semibold mb-2">Professional Reports & Services</h3>
                                <p className="text-blue-100 mb-4">Auto-generate a detailed PDF report with all inputs and calculations.</p>

                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div className="bg-white/10 rounded-lg p-4">
                                        <p className="font-semibold text-lg">Professional Report</p>
                                        <p className="text-sm text-blue-200 mb-2">
                                            {paymentStatus.reportsGenerated === 0 ? 'First report FREE!' : `${paymentStatus.reportsGenerated} report(s) generated`}
                                        </p>
                                        <p className="text-3xl font-bold my-2">$99 <span className="text-sm font-normal">Each</span></p>
                                        <ul className="text-sm text-blue-100 space-y-1 mb-4">
                                            <li>âœ“ Full calculation package</li>
                                            <li>âœ“ Auto-generated PDF</li>
                                            <li>âœ“ All inputs documented</li>
                                        </ul>
                                        {/* Smart button: Free first report, then require payment */}
                                        {paymentStatus.reportsGenerated === 0 || paymentStatus.hasPaid || !paymentStatus.stripeConfigured ? (
                                            <button data-generate-btn
                                                onClick={() => {
                                                    generateReportWithBackend();
                                                    trackReportGeneration();
                                                    if (paymentStatus.hasPaid) {
                                                        setPaymentStatus(prev => ({ ...prev, hasPaid: false, sessionId: null }));
                                                    }
                                                }}
                                                className="w-full py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition">
                                                Pay $99 & Generate
                                            </button>
                                        ) : (
                                            <button
                                                onClick={() => initiateCheckout('standard_report')}
                                                disabled={isProcessingPayment}
                                                className="w-full py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition disabled:opacity-50">
                                                {isProcessingPayment ? 'Processing...' : 'Pay $99 & Generate'}
                                            </button>
                                        )}
                                    </div>

                                    <div className="bg-white/10 rounded-lg p-4 ring-2 ring-yellow-400">
                                        <p className="font-semibold text-lg">PE-Reviewed Report</p>
                                        <p className="text-sm text-yellow-300 mb-2">Engineer Certified</p>
                                        <p className="text-3xl font-bold my-2">$299</p>
                                        <ul className="text-sm text-blue-100 space-y-1 mb-4">
                                            <li>âœ“ Everything in Standard</li>
                                            <li>âœ“ PE (TX/CO) Review</li>
                                            <li>âœ“ More components</li>
                                            <li>âœ“ More scenarios</li>
                                            <li>âœ“ Unlimited report generations</li>
                                            <li>âœ“ 48-72 hour delivery</li>
                                        </ul>
                                        <button
                                           onClick={() => {
                                               if (paymentStatus.stripeConfigured) {
                                                   initiateCheckout('pe_reviewed');
                                               } else {
                                                   window.location.href = 'mailto:caseym@franceng.com?subject=PSV%20PE-Reviewed%20Report%20Request&body=I%20would%20like%20to%20request%20a%20PE-Reviewed%20PSV%20Sizing%20Report.';
                                               }
                                           }}
                                           disabled={isProcessingPayment}
                                           className="w-full py-2 bg-yellow-400 text-blue-900 rounded-lg font-medium hover:bg-yellow-300 transition disabled:opacity-50">
                                            {isProcessingPayment ? 'Processing...' : (paymentStatus.stripeConfigured ? 'Pay $299' : 'Request Quote')}
                                        </button>
                                    </div>

                                    <div className="bg-white/10 rounded-lg p-4">
                                        <p className="font-semibold text-lg">PSV Sizing Services</p>
                                        <p className="text-sm text-blue-200 mb-2">Let us do it for you</p>
                                        <p className="text-3xl font-bold my-2">Custom</p>
                                        <ul className="text-sm text-blue-100 space-y-1 mb-4">
                                            <li>âœ“ Full engineering review</li>
                                            <li>âœ“ Multiple scenarios</li>
                                            <li>âœ“ Turnkey solution</li>
                                        </ul>
                                        <button
                                           onClick={() => {
                                               window.open('https://franceng.com/contact/', '_blank');
                                               window.location.href = 'mailto:caseym@franceng.com?subject=PSV%20Sizing%20Services%20Inquiry';
                                           }}
                                           className="w-full py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition">
                                            Contact Us
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Back Button */}
                            <div className="flex justify-between">
                                <button onClick={() => setStep(1)} className="px-6 py-2 border bg-white rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Start Over
                                </button>
                                <button onClick={() => setStep(4)} className="px-6 py-2 border bg-white rounded-lg font-medium hover:bg-gray-50 transition">
                                    â† Modify Calcs
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="mt-8 text-center text-sm text-gray-500">
                        <p>Calculations per API 520/521. Preliminary estimates only â€” professional engineering verification required.</p>
                        <p className="mt-1">Â© 2024 Franc Engineering | <a href="https://franceng.com" className="hover:underline">franceng.com</a></p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PSVCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
